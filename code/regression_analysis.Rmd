---
title: "Regression Analysis for Emissions Predictions"
authors: "Saloni Shah, Dan Blaustein-Rejto "
date: "originally started 11/06/2020"
output: html_document
---
#SETUP
```{r Load packages}
library(tidyverse); library(naniar); library(janitor)
```

```{r Import data}
#input data for regressions: input use, input emissions and kcal per hectare by country and year, with african countries aggregatedd at region-level. filtered to remove outliers.
filter_reg <- read_csv("int_data/input_data_cleaned_converted_aggregated.csv")

#scenarios for regression analysis
scenarios <- read_csv("int_data/scenarios.csv") %>%  #yields are in kcal/ha
  mutate(region = recode(region, E_Afr = "Eastern", C_Afr = "Middle", S_Afr = "Southern", N_Afr = "Northern", W_Afr = "Western")) %>%   #Convert country names in scenarios to East, West, Central, South, North
  dplyr::rename(country=region) %>%  #rename column to match with variable name used to fit regression
  mutate(scenario = factor(scenario, levels = c("b", "p", "h"), labels = c("Baseline", "Projected", "High")))
```

```{r Create results folders if they don't exist}
# Folders to create
folders <- c("results", 
             "results/supplementary", 
             "results/tables", 
             "results/graphs", 
             "results/graphs/manuscript", 
             "results/graphs/supplementary")

# Check if each folder exists, create if not
for (folder in folders) {
  if (!dir.exists(folder)) {
    dir.create(folder, recursive = TRUE)
    message(paste0("Folder created: ", folder)) 
  }
}
```


# Fit regression models
```{r Run OLS log-log regressions with filtered regression data to estimate relationship between yield and input use factor}
#regressions have country fixed effect where africa regions (e.g. east, west) are used as countries, enabling prediction later

#models for emissions per ha
en_emiss_ols <- lm(filter_reg, formula = log(en_emiss_ha) ~ log(yield) + factor(country)) #Energy Emissions OLS Regression

fert_emiss_ols <- lm(filter_reg, formula = log(fert_emiss_ha) ~ log(yield) + factor(country)) #Synthetic N emissions OLS Regression

fert_m_emiss_ols <- lm(filter_reg, formula = log(fert_m_emiss_ha) ~ log(yield) + factor(country)) #Synthetic N manufacturing emissions OLS Regression

m_emiss_ols <- lm(filter_reg, formula = log(m_emiss_ha) ~ log(yield) + factor(country)) #Energy embodied in machinery OLS Regression

pest_emiss_ols <- lm(filter_reg, formula = log(pest_emiss_ha) ~ log(yield) + factor(country)) #Pesticides manufacturing emissions OLS Regression

tot_emiss_ols <- lm(filter_reg, formula = log(tot_emiss_ha) ~ log(yield) + factor(country)) #Total emissions OLS Regression

#models for input use per ha
p_ols <- lm(filter_reg, formula = log(p_ha) ~ log(yield) + factor(country))

#Pesticides Use OLS regression
fert_use_ols <- lm(filter_reg, formula = log(fert_use_ha) ~ log(yield) + factor(country)) #Synthetic N use or application OLS regression

m_energy_ols <- lm(filter_reg, formula = log(m_energy_ha) ~ log(yield) + factor(country))#Energy embodied in machinery OLS regression
```

#Generate predictions
```{r Calculate predicted input emissions and use per ha by input, scenario and region}
#primarily used to create table (at end of code) with input use per ha. also used in alternate way of calculating CI's, which we dont currently report.

#create empty dataframe to add in fixed effect regression results
reg_fe_results <- tibble(dep_var=character(), scenario = character(), region = character(), fit=double(), lwr = double(), upr = double())

i=1
#define regions to loop through
regions <- c("Eastern","Middle","Northern","Southern","Western")

#map variables to model names
var_models = tibble(var = c("en_emiss_ha", "fert_emiss_ha", "fert_m_emiss_ha", "m_emiss_ha", "pest_emiss_ha", "tot_emiss_ha", "p_ha", "fert_use_ha"),
                   model = c("en_emiss_ols", "fert_emiss_ols", "fert_m_emiss_ols", "m_emiss_ols", "pest_emiss_ols", "tot_emiss_ols", "p_ols", "fert_use_ols"))

#loop through each dependent variable, scenario, and region to predict each dep variable for each region & scenario
for (dependent_variable in var_models$var) {
  for (scenario in unique(scenarios$scenario)){
    for (region in regions){
      
      reg_fe_results[i,] = c(dependent_variable, 
                            scenario, 
                            region, 
                            as.list(as_vector(predict(get(var_models$model[var_models$var==dependent_variable]), #choose regression model to predict with
              newdata = scenarios[scenarios$country==region & scenarios$scenario==scenario, c("country", "yield")], #add regression estimates
              interval = "confidence", level = 0.95))))
      i=i+1
    }
  }
}

#exponentiate estimates and confidence intervals
reg_fe_results <- reg_fe_results %>% mutate(fit = exp(fit), lwr = exp(lwr), upr = exp(upr)) 
  
#convert scenario in reg_fe_results to factor variable
reg_fe_results <- reg_fe_results %>% mutate(scenario = factor(scenario, levels = c("Baseline", "Projected", "High")))
```

```{r Calculate total emissions per ha from input use by region and scenario}
#create dataframe for predictions by region
scenarios_predictions <- scenarios %>% 
  filter(country!="Africa")

scenarios_predictions <- scenarios_predictions %>% #add predictions of per hectare emissions for each region
  mutate(
    ha_e = exp(predict(en_emiss_ols, newdata = scenarios_predictions)),
    ha_f = exp(predict(fert_emiss_ols, newdata = scenarios_predictions)),
    ha_fm = exp(predict(fert_m_emiss_ols, newdata = scenarios_predictions)),
    ha_m = exp(predict(m_emiss_ols, newdata = scenarios_predictions)),
    ha_p = exp(predict(pest_emiss_ols, newdata = scenarios_predictions)),
    ha_t = ha_e+ha_f+ha_fm+ha_m+ha_p) #calculate total emissions per ha

#calculate variance and 95% CI for total emissions per ha for each region
library(car)

# Function to calculate variance using delta method.
# This approach assumes the errors on the log scale are normally distributed.
# It also assumes that the predicted values from the multiple models are independent. 
calculate_variance <- function(model, new_data) {
  #fit model
  predictions <- predict(model, newdata = new_data, se.fit = TRUE)
  
  #predicted mean on log scale
  pred_log <- predictions$fit
  
  #standard error of predicted mean on log scale
  se_log <- predictions$se.fit
  
  #calculate variance on original scale
  pred <- exp(pred_log)
  sigma_squared <- se_log^2
  mu <- pred_log #use mu term to clarify equation below is standard log-normal variance calculation
  
  var_pred <- (exp(sigma_squared) - 1) * exp(2 * mu * sigma_squared)
  return(var_pred)
}

#Calculate Confidence Interval
z <- qnorm(0.975) # Z value for 95% CI

# Calculating variances
scenarios_predictions <- scenarios_predictions %>% 
  mutate( #calculate variances for each per ha value
    var_e = calculate_variance(en_emiss_ols, scenarios_predictions),
    var_f = calculate_variance(fert_emiss_ols, scenarios_predictions),
    var_fm = calculate_variance(fert_m_emiss_ols, scenarios_predictions),
    var_m = calculate_variance(m_emiss_ols, scenarios_predictions),
    var_p = calculate_variance(pest_emiss_ols, scenarios_predictions),
    var_t = var_e + var_f + var_fm + var_m + var_p) %>%  #calculate variance for total emissions/ha
  #calculate confidence intervals for each per ha value
  pivot_longer(cols = -c(country, scenario, harv_area, yield, luc, arable_area, production), 
               names_to = c(".value", "estimate"), 
               names_pattern = "(.*)_(.*)") %>% 
  mutate(
    lwr_ha = ha - z * sqrt(var), #calculate using z value for CI
    upr_ha = ha + z * sqrt(var)) %>% 
  rename(fit_ha = ha, var_ha = var)
```

```{r Calculate total emissions from input use for Africa}
scenarios_predictions <- scenarios_predictions %>% 
  mutate(fit_tot = fit_ha * arable_area,  #Calculate total emissions for each source, region and scenario
         var_tot = (arable_area^2)* var_ha, #Calculate variance for total emissions for each source, region and scenario
         lwr_tot = fit_tot - z * sqrt(var_tot), #Calculate 95% CI for total emissions for each source, region and scenario
         upr_tot = fit_tot + z * sqrt(var_tot))

#calculate Africa sum emissions and sum variance
africa_sums <- scenarios_predictions %>% 
  group_by(scenario, estimate) %>% 
  summarize(across(c(fit_tot, var_tot, harv_area, luc, arable_area, production), sum)) %>% #sum emissions and variance across regions, by scenario, as well as production data
  mutate( #calculate 95% CI for Africa totals
    lwr_tot = fit_tot - z * sqrt(var_tot),
    upr_tot = fit_tot + z * sqrt(var_tot),
    country = "Africa", #add for joining to region dataframe
    yield = production/arable_area) #calculate yield for Africa
```

```{r Unused. Alternative method of calculating 95% CI for Africa totals}
#note that we don't report results from this method since it does not include summing emissions across sources and propogating the errors appropriately. However, this is a more precise method for calculating CI for the individual emission sources (e.g. fertilizer application) since it accounts for the variance-covariance matrix of the coefficients including country fixed effects. This results in slightly larger CI's than the method we report; however the central estimates are the same and the larger CI's do not modify any of our conclusions. 

#map models to model names
models <- list(en_emiss_ols, fert_emiss_ols, fert_m_emiss_ols, m_emiss_ols, pest_emiss_ols)
model_names <- c("en_emiss", "fert_emiss", "fert_m_emiss", "m_emiss", "pest_emiss")
scenario_names <- c("Baseline", "Projected", "High")

#Define function to calculate sum and confidence interval across the regions
calculate_sum_and_ci <- function(model_name){
  # Extract coefficients and variance-covariance matrix
  beta <- coef(model_name)
  V <- vcov(model_name)
                      
  # Structure prediction data for calculation
  
  predictions <- reg_fe_results %>%  #extract exponentiated log values (per ha) from model predictions 
    filter(dep_var == model_name[["terms"]][[2]][[2]], #filter to dependent variable for this model. 
                                 region %in% regions) %>% #ensure only correct regions included
    arrange(scenario, region) %>% #structure in same way as other data to ensure data alignment
    select(fit) %>% 
    pull() 
  
  yields <- scenarios %>% #extract yield values for each region and scenario
    filter(country %in% regions) %>% 
    arrange(scenario, country) %>% 
    select(country, yield) %>% 
    pull()
  
  l_values <- scenarios %>% #extract arable land area values for each region and scenario
    filter(country %in% regions) %>% 
    arrange(scenario, country) %>% 
    select(arable_area) %>% 
    pull() 
  
  ## Calculation of derivatives for log yield and fixed effects
  #map countries to country fixed effects in coeffient table
  country_coef_indices <- sapply(regions, function(country) {
    which(names(beta) == paste0("factor(country)", country))
  })
  
  # Number of countries and scenarios
  num_countries <- length(regions)
  num_scenarios <- length(predictions) / num_countries
  country_factors <- rep(regions, num_scenarios)
  
  # Initialize a matrix for derivatives for all scenarios
  derivatives_all_scenarios <- matrix(nrow = length(predictions), ncol = 1 + num_countries)
  
  # Loop over each scenario
  for (scenario in 1:num_scenarios) {
    # Starting and ending indices for this scenario in the predictions vector
    start_idx <- (scenario - 1) * num_countries + 1
    end_idx <- scenario * num_countries
  
    # Extract predictions for this scenario
    scenario_predictions <- predictions[start_idx:end_idx]
    scenario_yields <- yields[start_idx:end_idx]
    scenario_l_values <- l_values[start_idx:end_idx]
    
    # Fill in the derivatives matrix for log(yield)
    derivatives_all_scenarios[start_idx:end_idx, 1] <- scenario_predictions * (1 / scenario_yields) * scenario_l_values

      
    # Fill in derivatives for each country's fixed effect
    for (i in 1:num_countries) {
      country_index <- country_coef_indices[i]
      derivatives_all_scenarios[start_idx:end_idx, i + 1] <- ifelse(country_factors[start_idx:end_idx] == regions[i], scenario_predictions * scenario_l_values, 0)
    }
  }
  
  # Initialize a vector to store variance of the sum for each scenario
  var_sum_scenarios <- numeric(num_scenarios)
  
  # Loop over each scenario
  for (scenario in 1:num_scenarios) {
    # Starting and ending indices for this scenario in the predictions vector
    start_idx <- (scenario - 1) * num_countries + 1
    end_idx <- scenario * num_countries
  
    # Variance of the sum for this scenario
    var_sum <- 0
    for (i in 1:(1 + num_countries)) { # Include log(yield) and the specific countries
      for (j in 1:(1 + num_countries)) {
        var_sum <- var_sum + sum(derivatives_all_scenarios[start_idx:end_idx, i] * derivatives_all_scenarios[start_idx:end_idx, j]) * V[i, j]
      }
    }
    var_sum_scenarios[scenario] <- var_sum
  }
  
  # Standard error of the sum for each scenario
  se_sum_scenarios <- sqrt(var_sum_scenarios)
  
  # Calculate the sum, across regions, of the total emissions (predicted per ha value * arable area) for each scenario
  # Calculate the sum, across regions, for each scenario
  sum_multiplied_predictions <- tibble(Scenario = character(num_scenarios), Sum = numeric(num_scenarios))
  for (scenario in 1:num_scenarios) {
  start_idx <- (scenario - 1) * num_countries + 1
  end_idx <- scenario * num_countries
  
  sum_multiplied_predictions$Scenario[scenario] <- scenario_names[scenario]
  sum_multiplied_predictions$Sum[scenario] <- sum(predictions[start_idx:end_idx] * l_values[start_idx:end_idx])
}

# Calculate the confidence interval for each scenario
ci_lower <- sum_multiplied_predictions$Sum - (1.96 * se_sum_scenarios)
ci_upper <- sum_multiplied_predictions$Sum + (1.96 * se_sum_scenarios)

# Return results as a dataframe
return(data.frame(
  scenario = sum_multiplied_predictions$Scenario,
  fit = sum_multiplied_predictions$Sum,
  lwr = ci_lower,
  upr = ci_upper
))

}

#apply function to each model
results_list <- lapply(models, calculate_sum_and_ci)
names(results_list) <- model_names

#combine into 1 dataframe
afr_totals <- bind_rows(results_list, .id = "source") %>% 
  mutate(region = "Africa") %>% 
  pivot_longer(cols = c(fit, lwr, upr), names_to = "estimate", values_to = "value") %>%
  pivot_wider(names_from = source, values_from = value)
```

#Add LUC
```{r Add LUC data to input emissions data}
detach("package:car", unload=TRUE) #remove to simplify use of recode function and anything else masked by car

region_key <- c(C_Afr="Middle", E_Afr="Eastern", N_Afr = "Northern", S_Afr="Southern", W_Afr="Western")

convert_luc_co2 <- function(x){return(x * kg_to_mt/38)} # convert to million metric ton and divide by 38, the number of years between 2012 and 2050, this division annualizes the emissions

luc_co2_region <- read_csv("int_data/luc_co2_region.csv") %>%  #read in kg CO2e from LUC by region and scenario, with low values calculated allowing for negative LUC for crops (i.e. restoration) and high values setting all negative LUC to 0.
  mutate(region = recode(region, !!!region_key)) %>%  #rename regions for joining
  rename(luc_co2_low = co2_low, luc_co2_high=co2_high) %>%  #clarify column names
  mutate(across(c(luc_co2_low, luc_co2_high), convert_luc_co2), #convert to MMT CO2/yr
         scenario = factor(scenario, levels = c("b", "p", "h"), labels = c("Baseline", "Projected", "High"))) #make scenario a factor to join below w/ other data

#add rows to luc_co2_region that is the total across regions for each scenario and c_loss_ratio
luc_co2_region <- luc_co2_region %>% 
  bind_rows(luc_co2_region %>% 
              group_by(scenario, c_loss_ratio) %>% 
              summarise(luc_co2_low = sum(luc_co2_low), luc_co2_high = sum(luc_co2_high), luc = sum(luc)) %>% 
              ungroup() %>% 
              mutate(region = "Africa"))

#combine region and Africa values with LUC data
#return to delete
all_emiss <- scenarios_predictions %>% bind_rows(africa_sums) %>%
  rename(region=country) %>% select(-luc) %>% #change and remove cols for joining; luc already in dataframe being joined to. values confirmed to be identical.
  inner_join(luc_co2_region, by = c("scenario", "region"), relationship = "many-to-many")

write_csv(all_emiss,"results/supplementary/all_emiss_region.csv")
```

#Sensitivity analysis
```{r Calculate LUC and total input emissions by scenario and region, under linear model}
#fit linear model for emissions per ha to filtered data set
e_linear <- lm(filter_reg, formula = (en_emiss_ha) ~ (yield) + factor(country)) #Energy Emissions OLS Regression
f_linear <- lm(filter_reg, formula = (fert_emiss_ha) ~ (yield) + factor(country)) #Synthetic N emissions OLS Regression
fm_linear <- lm(filter_reg, formula = (fert_m_emiss_ha) ~ (yield) + factor(country)) #Synthetic N manufacturing emissions OLS Regression
m_linear <- lm(filter_reg, formula = (m_emiss_ha) ~ (yield) + factor(country)) #Energy embodied in machinery OLS Regression
p_linear <- lm(filter_reg, formula = (pest_emiss_ha) ~ (yield) + factor(country)) #Pesticides manufacturing emissions OLS Regression

#Generate predictions for under each yield scenario
linear_predictions <- scenarios %>% filter(country!="Africa") #use yield scenarios for each region
linear_predictions <- linear_predictions %>% 
  #add predictions of per hectare emissions for each region
  mutate(
    ha_e = predict(e_linear, newdata = linear_predictions),
    ha_f = predict(f_linear, newdata = linear_predictions),
    ha_fm = predict(fm_linear, newdata = linear_predictions),
    ha_m = predict(m_linear, newdata = linear_predictions),
    ha_p = predict(p_linear, newdata = linear_predictions),
    ha_t = ha_e+ha_f+ha_fm+ha_m+ha_p)

#calculate Africa sum total input emissions
africa_linear_sums <- linear_predictions %>% 
  mutate(total_emiss = ha_t*arable_area, region="Africa") %>%
  group_by(scenario, region) %>%
  summarize(tot_emiss = sum(total_emiss))

#Add LUC
africa_linear_sums <- inner_join(africa_linear_sums, luc_co2_region, by = c("scenario", "region"), relationship = "many-to-many") %>%  #join input and LUC emissions
  mutate(tot_co2_high = tot_emiss + luc_co2_high, tot_co2_low = tot_emiss + luc_co2_low) #calculate total emissions for low and high LUC approaches
```

```{r Compare linear and log regression models for energy}
plot(e_linear$fitted.values, e_linear$residuals)
plot(en_emiss_ols$fitted.values, en_emiss_ols$residuals)
qqnorm(e_linear$residuals)
qqline(e_linear$residuals)
qqnorm(en_emiss_ols$residuals)
qqline(en_emiss_ols$residuals)
plot(e_linear$fitted.values, e_linear$model$`(en_emiss_ha)`)
plot(en_emiss_ols$fitted.values, en_emiss_ols$model$`log(en_emiss_ha)`)
```

```{r Compare linear and log regression models for fertilizer}
plot(f_linear$fitted.values, f_linear$residuals)
plot(fert_emiss_ols$fitted.values, fert_emiss_ols$residuals)
qqnorm(f_linear$residuals)
qqline(f_linear$residuals)
qqnorm(fert_emiss_ols$residuals)
qqline(fert_emiss_ols$residuals)
plot(f_linear$fitted.values, f_linear$model$`(fert_emiss_ha)`)
plot(fert_emiss_ols$fitted.values, fert_emiss_ols$model$`log(fert_emiss_ha)`)
```

```{r Calculate LUC and total input emissions by scenario and region, with data filter to after 1990}
#re-run log-log regression with data filterted to adfter 1990, which is when pesticide use data is first available. all values are NA before then
#fit log-log model for emissions per ha to filtered data set
e_1990 <- lm(filter_reg %>% filter(year>=1990), formula = log(en_emiss_ha) ~ log(yield) + factor(country)) #Energy Emissions OLS Regression
f_1990 <- lm(filter_reg %>% filter(year>=1990), formula = log(fert_emiss_ha) ~ log(yield) + factor(country)) #Synthetic N emissions OLS Regression
fm_1990 <- lm(filter_reg %>% filter(year>=1990), formula = log(fert_m_emiss_ha) ~ log(yield) + factor(country)) #Synthetic N manufacturing emissions OLS Regression
m_1990 <- lm(filter_reg %>% filter(year>=1990), formula = log(m_emiss_ha) ~ log(yield) + factor(country)) #Energy embodied in machinery OLS Regression
p_1990 <- lm(filter_reg %>% filter(year>=1990), formula = log(pest_emiss_ha) ~ log(yield) + factor(country)) #Pesticides manufacturing emissions OLS Regression

#Generate predictions for under each yield scenario
predictions_1990 <- scenarios %>% filter(country!="Africa") #use yield scenarios for each region
predictions_1990 <- predictions_1990 %>% 
  mutate( #add predictions of per hectare emissions for each region
    ha_e = exp(predict(e_1990, newdata = predictions_1990)),
    ha_f = exp(predict(f_1990, newdata = predictions_1990)),
    ha_fm = exp(predict(fm_1990, newdata = predictions_1990)),
    ha_m = exp(predict(m_1990, newdata = predictions_1990)),
    ha_p = exp(predict(p_1990, newdata = predictions_1990)),
    ha_t = ha_e+ha_f+ha_fm+ha_m+ha_p)

#calculate Africa sum total input emissions
africa_1990_sums <- predictions_1990 %>% 
  mutate(total_emiss = ha_t*arable_area, region="Africa") %>%
  group_by(scenario, region) %>%
  summarize(tot_emiss = sum(total_emiss))

#Add LUC
africa_1990_sums <- inner_join(africa_1990_sums, luc_co2_region, by = c("scenario", "region"), relationship = "many-to-many") %>%  #join input and LUC emissions
  mutate(tot_co2_high = tot_emiss + luc_co2_high, tot_co2_low = tot_emiss + luc_co2_low) #calculate total emissions for low and high LUC approaches
```

```{r Combine rebound LUC values with input emission values}
#import luc emissions and arable land values for high scenario for rebound values
r <- read_csv("int_data/rebound_luc_by_region.csv")

#join with dataframe of predicted input emissions per hectare for high scenario
r <- r %>% 
  mutate(region = recode(region, !!!region_key)) %>%   #rename regions for joining
  mutate(across(c(co2_low, co2_high), convert_luc_co2)) #convert luc emission values from kg to megaton/million metric ton and annualize
  
r <- scenarios_predictions %>% 
  filter(scenario=="High") %>% 
  select(country, estimate, fit_ha) %>% 
  inner_join(r, by = join_by(country == region), relationship = "many-to-many")
  
#calculate total input emissions for each rebound value for high scenario 
r <- r %>% 
  mutate(fit_tot = fit_ha * a) %>%    #calculate total emissions for each source, region, and rebound scenario
  group_by(estimate, rebound, c_loss_ratio) %>%  #summarize for africa
  summarize(fit_tot = sum(fit_tot),
            co2_low = sum(co2_low),
            co2_high = sum(co2_high),
            luc = sum(luc),
            a = sum(a)) %>% 
  pivot_wider(names_from = estimate, values_from = fit_tot) %>% 
  mutate(emiss_tot_high = e+f+fm+m+p+co2_high, #calculate total for co2_high option
         emiss_tot_low = e+f+fm+m+p+co2_low) #calculate total for co2_low option
```

#Graph results
```{r Set BTI style guide for  graphing}
#define colors
bti_colors <- c("#0d4459", "#00a990", "#d05527", "#a33332",
                "#b381d0",  "#dfb9a6", "#b2b2b1", "#2A2A2A", "#ecc627")

#general plot theme
theme_bti <- function (base_size = 6, base_family = "Helvetica") {
  theme_classic() %+replace% 
    theme(plot.title = element_text(color = "black",  size = 12), 
          strip.text.x = element_text(size = 10),
          strip.background = element_blank(),
          
          #gridlines
          panel.grid.major.y = element_blank(), panel.grid.minor.y = element_blank(), #no grid lines
          panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank(), #no grid lines
          #background and border
          panel.border = element_blank(), #no plot border
          #panel.background = element_rect(fill = "white"), #white panel background 
          #legend
          legend.position = "bottom", #legend default position is bottom
          legend.key = element_rect(fill = "#FFFFFF00", color = NA), #no border around legend items
          legend.text = element_text(size=8),
          legend.title = element_text(size=8),
          #axes
          axis.line.x = element_line(color="black", size = .5),
          axis.line.y = element_line(color="black", size = .5),
          axis.title.y = element_text(size = 8, angle = 90,
                                      margin = margin(t = 0, r = 5, b = 0, l = 0)), #set y axis title further left from axis 
          axis.title.x = element_text(size = 8), 
          axis.text.x = element_text(size = 8),
          axis.text.y = element_text(size = 8),
          #logo 
          plot.margin = unit(c(0.5, 0.5, 2, 0.5), "lines") # add space for logo
    )
}
```

```{r Set up data for graphing and tables}
c_loss_selected <- "S" #edit to change which soil carbon loss scenario is used for following graphs. options are S (searchinger), H (houghton)
c_loss_excluded <- "H"
luc_scenario_excluded <- "low" #edit to change which LUC scenario is used for following graphs. options are low and high
luc_scenario_included <- "luc_co2_high" #as above options are luc_co2_low and luc_co2_high

#map short crop names (e.g. banp, barl) onto full names (e.g. Bananas and Plantains, Barley)
crop_full_names <-c(
  "banp" = "Bananas and Plantains",
  "barl" = "Barley",
  "bean" = "Beans, dry",
  "cass" = "Cassava",
  "cott" = "Cotton",
  "grou" = "Groundnuts",
  "maiz" = "Maize",
  "mill" = "Millet",
  "ooil" = "Oilcrops",
  "opul" = "Pulses",
  "pota" = "Potatoes",
  "rice" = "Rice, paddy",
  "sorg" = "Sorghum",
  "soyb" = "Soybeans",
  "sugb" = "Sugar beet",
  "sugc" = "Sugar cane",
  "swpy" = "Sweet potatoes and yams",
  "whea" = "Wheat")

fig_dat <- all_emiss %>% 
  filter(c_loss_ratio != c_loss_excluded) %>% #filter to soil carbon loss scenario being used
  select(-c_loss_ratio, -paste0("luc_co2_", luc_scenario_excluded)) %>% #filter out luc scenario being excluded
  rename(source=estimate) %>% 
  mutate(scenario = factor(scenario, levels = c("Baseline", "Projected", "High"))) %>%    #change order of scenario column
  pivot_longer(cols = c(fit_tot, luc_scenario_included),
               names_to = "source_new", 
               values_to = "tot") %>% 
  mutate(lwr_tot = case_when(source_new == luc_scenario_included ~ NA_real_, TRUE ~ lwr_tot), #set lwr and upr to NA when source equals "luc_co2_low" or "luc_co2_high" so that error bars are not plotted for LUC emissions
         upr_tot = case_when(source_new == luc_scenario_included ~ NA_real_, TRUE ~ upr_tot))
```

```{r Fig 1. Total Africa LUC and Input Emissions by Scenario}
#column chart showing total LUC emissions and total input emissions (sum of energy, fertilizer, pesticide, machinery), by scenario
fig1 <- fig_dat %>% 
  filter(source =="t", region=="Africa") %>% 
  ggplot()+
  geom_col(aes(x = scenario, y = tot, fill = source_new), position = "dodge") +
  geom_errorbar(aes(x = scenario, ymin = lwr_tot, ymax = upr_tot, group=source_new), width = 0.2, position = position_dodge(.9))+
  #ggtitle("Emissions from input use and LUC by scenario for Africa.") + #comment out title for adding to manuscript where title is added in word
  xlab("Scenarios") + 
  ylab("Greenhouse Gas Emissions (million metric tons CO2e)") + 
  labs(fill = "Emission Source")+  #caption = "95% confidence interval shown only for total input emissions."
  scale_y_continuous(expand = expand_scale(mult = c(0.0, 0.1)))+ #move y origin to plot margin/line
  theme_bti()+
  scale_fill_manual(values = setNames(c(bti_colors[1], bti_colors[2]), c("fit_tot", luc_scenario_included)), #set colors
                    labels = setNames(c("Manufacturing and Use of Farm Inputs", "Land Use Change"), c("fit_tot", luc_scenario_included))) #set labels

fig1
ggsave(plot = fig1, filename = "results/graphs/manuscript/fig1.png", width = 6, height = 4, units = "in", dpi = 300)
```

```{r Fig 2. Africa Input Emissions by Scenario and Source}
#column chart showing each source of input emissions for Africa, by scenario
fig2 <- fig_dat %>% 
  filter(source_new != luc_scenario_included, source!="t", region=="Africa") %>% #filter just to individual inputs
  ggplot()+
  geom_col(aes(x = scenario, y = tot, fill = source), position = "dodge") +
  geom_errorbar(aes(x = scenario, ymin = lwr_tot, ymax = upr_tot, group=source), width = 0.2, position = position_dodge(.9))+
  #ggtitle("Emissions from input use by scenario for Africa.") + #comment out title for adding to manuscript where title is added in word
  xlab("Scenarios") + 
  ylab("Greenhouse Gas Emissions (million metric tons CO2e)") + 
  labs(fill = "Emission Source")+  #caption = "95% confidence interval shown only for total input emissions."
  scale_y_continuous(expand = expand_scale(mult = c(0.0, 0.1)))+ #move y origin to plot margin/line
  theme_bti()+
  scale_fill_manual(values=bti_colors, #set colors to bti colors
                    labels = c("On-Farm Energy", "Synthetic N Application", "Synthetic N Manufacturing", "Pesticide Manufacturing", "Machinery Manufacturing"))+ #set labels
  guides(fill = guide_legend(nrow = 2)) #set legend to two rows

fig2
ggsave(plot = fig2, filename = "results/graphs/manuscript/fig2.png", width = 6, height = 4, units = "in", dpi = 300)
```

```{r Fig S1. Total LUC and Input Emissions by Scenario for each region}
#column chart showing total LUC emissions and total input emissions (sum of energy, fertilizer, pesticide, machinery), by scenario, for each region
figS1 <- fig_dat %>% 
  filter(source=="t", region!="Africa") %>% #filter just to individual inputs
  ggplot()+
  geom_col(aes(x = scenario, y = tot, fill = source_new), position = "dodge") +
  geom_errorbar(aes(x = scenario, ymin = lwr_tot, ymax = upr_tot, group=source_new), width = 0.2, position = position_dodge(.9))+
  #ggtitle("Emissions from input use and LUC by scenario for each region.") + #comment out title for adding to manuscript where title is added in word
  xlab("Scenarios") + 
  ylab("Greenhouse Gas Emissions (million metric tons CO2e)") + 
  facet_wrap(~region, scales = "free_y", ncol=3)+
  labs(fill = "Emission Source")+  #caption = "95% confidence interval shown only for total input emissions. "
  scale_y_continuous(expand = expand_scale(mult = c(0.0, 0.1)))+ #move y origin to plot margin/line
  scale_fill_manual(values = setNames(c(bti_colors[1], bti_colors[2]), c("fit_tot", luc_scenario_included)), #set colors
                     labels = setNames(c("Manufacturing and Use of Farm Inputs", "Land Use Change"), c("fit_tot", luc_scenario_included)))+ #set labels
  theme_bti() + 
  geom_hline(yintercept = 0, color = "black", linewidth = 1) #add x axis line since doesnt show up for all when facetted

figS1
ggsave(plot = figS1, filename = "results/graphs/supplementary/figs1.png", width = 6, height = 4, units = "in", dpi = 300)
```

```{r Fig S2. Input Emissions by Scenario and Source for each region}
#column chart showing each source of input emissions for each region, by scenario
figS2 <- fig_dat %>% 
  filter(source_new != luc_scenario_included, source!="t", region!="Africa") %>% 
  ggplot()+
  geom_col(aes(x = scenario, y = tot, fill = source), position = "dodge") +
  geom_errorbar(aes(x = scenario, ymin = lwr_tot, ymax = upr_tot, group=source), width = 0.2, position = position_dodge(.9))+
  #ggtitle("Emissions from input use by scenario for each region.") + #comment out title for adding to manuscript where title is added in word
  xlab("Scenarios") + 
  ylab("Greenhouse Gas Emissions (million metric tons CO2e)") + 
  facet_wrap(~region, scales = "free_y", ncol=3)+
  labs(fill = "Emission Source")+  #caption = "95% confidence interval shown."
  scale_y_continuous(expand = expand_scale(mult = c(0.0, 0.1)))+ #move y origin to plot margin/line
  scale_fill_manual(values=bti_colors, #set colors to bti colors
                    labels = c("On-Farm Energy", "Synthetic N Application", "Synthetic N Manufacturing", "Pesticide Manufacturing", "Machinery Manufacturing"))+ #set labels
  theme_bti() + 
  geom_hline(yintercept = 0, color = "black", linewidth = 1)+ #add x axis line since doesnt show up for all when facetted
  guides(fill = guide_legend(nrow = 2)) #set legend to two rows

figS2
ggsave(plot = figS2, filename = "results/graphs/supplementary/figs2.png", width = 6, height = 4, units = "in", dpi = 300)
```

```{r Fig S3. Rebound Analysis Line Graph}
#calculate difference in emissions from baseline scenario
baseline_tot_emiss = fig_dat %>% 
  filter(source =="t", region=="Africa", scenario=="Baseline") %>% 
  group_by(scenario) %>% 
  summarize(tot = sum(tot)) %>% pull()

fig_s3_dat <- r %>% 
  filter(c_loss_ratio != c_loss_excluded) %>% #filter to soil carbon loss scenario being used
  mutate(emiss_diff = emiss_tot_high - baseline_tot_emiss) %>%  #return to fix so ideally selecting scenario isnt manual
  select(rebound, emiss_diff)

#line chart with rebound value on x-axis and difference in total emissions on y-axis
figS3 <- ggplot(fig_s3_dat)+ 
  geom_line(aes(x=rebound, y=emiss_diff)) + #graph diagonal line showing relationship between rebound /elasticity value  on x axis and difference in emissions on y.  
  geom_hline(yintercept = 0, color = "grey")+ #highlight y=0 where high scenario starts having higher emissions 
  xlab("Rebound") + 
  ylab("Total Emissions Difference (million metric tons CO2e)") + 
  scale_y_continuous(expand = expand_scale(mult = c(0.0, 0.1)))+ #move y origin to plot margin/line
  theme_bti()

figS3

#save/export chart and data used for chart
ggsave(plot = figS3, filename = "results/graphs/supplementary/figs3.png", width = 6, height = 4, units = "in", dpi = 300)

write_csv(fig_s3_dat, "results/supplementary/figs3_rebound_data.csv")
```

#Create and Export Tables
```{r Table 1. Africa Yield and Harvested Area and Arable Area by Scenario}
decimals <- 1 #define number of decimals to round to

scenarios %>% filter(country=="Africa") %>% 
  mutate(yield = round(yield/1000000, digits = decimals), #convert to million kcal/ha
         harv_area = round(harv_area/1000000, digits = decimals), #convert to million ha
         arable_area = round(arable_area/1000000, digits = decimals)) %>% #convert to million ha
  select("Scenario"=scenario, "Yield (million kcal/ha)" = yield, 
         "Harvested Area (million ha)" = harv_area, "Arable Area (million ha)" = arable_area) %>% 
  arrange(Scenario) %>%  #order by scenario order
  write_csv("results/tables/table1_afr_yield_area_by_scenario.csv")
```

```{r Table S1. Yield, Harvested Values for each Scenario and Region}
scenarios %>% 
  mutate(scenario = recode(scenario, "b"="Baseline","p"="Projected", "h"="High"), #rename scenarios for presentation
         country = recode(country, "Middle" = "Middle Africa", "Eastern" = "Eastern Africa", "Northern" = "Northern Africa", "Southern" = "Southern Africa", "Western" = "Western Africa"), #change to full names for regions
         yield = round(yield/1000000, digits = decimals), #convert to million kcal/ha
         harv_area = round(harv_area/1000000, digits = decimals), #convert to million ha
         arable_area = round(arable_area/1000000, digits = decimals)) %>% #convert to million ha
  select("Region"=country, "Scenario"=scenario, "Yield (million kcal/ha)" = yield, 
         "Harvested Area (million ha)" = harv_area, "Arable Area (million ha)" = arable_area) %>%
  arrange(Scenario, Region) %>% #arder by scenario order, and regions alphabetically within
  write_csv("results/tables/tableS1_yield_area_by_scenario_and_region.csv")
```

```{r Table S2. tons CO2 per ha per crop and country}
read_csv("int_data/LUC_CO2_crops.csv") %>%  #read in kg co2/ha carbon loss for crops for all countries; need to filter to just countries included
  select(crop = id, country = ADMIN, co2_ha = tot_H) %>%  #filter to just Houghton loss ratio of 25%
  mutate(country = recode(country, "Republic of the Congo" = "Congo", "Ivory Coast" = "Côte d'Ivoire" , "eSwatini" = "Eswatini")) %>% #change country names to match FAO names
  filter(country %in% africa_scenario_countries, #filter to just countries included
         !crop %in% c("bean", "coff")) %>%  #remove bean & coffee since not matched w/ FOFA and fao data and so not used in analysis
  select(crop, Country = country, co2_ha) %>% #select just crops, country, and kg Co2/ha
  mutate(co2_ha = co2_ha / 1000,  #convert to metric tons Co2/ha
        crop = recode(crop, !!!crop_full_names)) %>% #replace crop names w/full names
  pivot_wider(names_from = crop, values_from = co2_ha) %>% #pivot to have 1 column per crop
  mutate(across(-Country, ~round(., digits = decimals))) %>% #round values
  arrange(Country) %>%  # order country column alphabetically and write to csv
  write_csv("results/tables/tableS2_tons_co2_ha_by_crop_and_country.csv")
```

```{r Table S3 African countries and regional classifications}
#remove Mauritius from scenario country list since not in LUC CO2 data 
africa_scenario_countries <- africa_scenario_countries[africa_scenario_countries!="Mauritius"]

#list unique countries in each region
tibble(
  Region = c("Middle Africa", "Eastern Africa", "Northern Africa", "Southern Africa", "Western Africa"),
  Countries = c(paste(C_Afr[C_Afr %in% africa_scenario_countries], collapse = ", "), 
                paste(E_Afr[E_Afr %in% africa_scenario_countries], collapse = ", "), 
                paste(N_Afr[N_Afr %in% africa_scenario_countries], collapse = ", "), 
                paste(S_Afr[S_Afr %in% africa_scenario_countries], collapse = ", "), 
                paste(W_Afr[W_Afr %in% africa_scenario_countries], collapse = ", ")
                )) %>% 
  write_csv("results/tables/tableS3_african_countries_and_regions.csv")
```

```{r Table S4. LUC and total input emissions by scenario and region}
fig_dat %>% 
  mutate(region = recode(region, "Middle" = "Middle Africa", "Eastern" = "Eastern Africa", "Northern" = "Northern Africa", "Southern" = "Southern Africa", "Western" = "Western Africa")) %>%  #change to full names for regions
  filter(source =="t") %>% #filter to just LUC and total input emissions
  select(region, scenario, source_new, tot) %>% #remove upper and lower bounds
  pivot_wider(names_from = source_new, values_from = tot) %>% #pivot to have 1 column per source
  mutate(`Total (Mt CO2e)` = get(luc_scenario_included) + fit_tot) %>% #add total emissions column
  rename(Scenario = scenario, Region = region, `LUC (Mt CO2e)` = luc_scenario_included, `Input Use (Mt CO2e)` = fit_tot) %>%  #rename columns for presentation
  arrange(Scenario, Region) %>%   #arder by scenario order, and regions alphabetically within
  mutate(across(-c(Scenario, Region), ~round(., digits = decimals))) %>% #round values
  write_csv("results/tables/tableS4_LUC_and_total_input_emissions_by_scenario_and_region.csv")
```

```{r Table S5. Synthetic Nitrogen Fertilizer Application Rate per scenario and region}
reg_fe_results %>% 
  mutate(region = recode(region, "Middle" = "Middle Africa", "Eastern" = "Eastern Africa", "Northern" = "Northern Africa", "Southern" = "Southern Africa", "Western" = "Western Africa")) %>%  #change to full names for regions
  filter(dep_var=="fert_use_ha", region!="Africa") %>% #filter to just synthetic nitrogen fertilizer application rate, and exclude Africa total
  select(-lwr, -upr) %>% #remove upper and lower bounds
  pivot_wider(names_from = dep_var, values_from = fit) %>% #pivot to have 1 column per source
  rename(Scenario = scenario, Region = region, `Synthetic Fertilizer Application (kg N/ha)` = fert_use_ha) %>%  #rename columns for presentation
  arrange(Scenario, Region) %>% #order by scenario order, and regions alphabetically within
  mutate(across(-c(Scenario, Region), ~round(., digits = decimals))) %>% #round values
  write_csv("results/tables/tableS5_synthetic_nitrogen_fertilizer_application_rate_by_scenario_and_region.csv")
#kg N synthetic fertilizer per ha
```

```{r Table S6. Pesticide Application Rate per scenario and region}
reg_fe_results %>% 
  mutate(region = recode(region, "Middle" = "Middle Africa", "Eastern" = "Eastern Africa", "Northern" = "Northern Africa", "Southern" = "Southern Africa", "Western" = "Western Africa")) %>%  #change to full names for regions
  filter(dep_var=="p_ha", region!="Africa") %>% #filter to just pesticide fertilizer application rate, and exclude Africa total
  select(-lwr, -upr) %>% #remove upper and lower bounds
  pivot_wider(names_from = dep_var, values_from = fit) %>% #pivot to have 1 column per source
  mutate(p_ha=p_ha*1000) %>%  #convert tons/ha to kg/ha
  rename(Scenario = scenario, Region = region, `Pesticide Application (kg active ingredient/ha)` = p_ha) %>%  #rename columns for presentation
  arrange(Scenario, Region) %>% #order by scenario order, and regions alphabetically within
  mutate(across(-c(Scenario, Region), ~round(., digits = decimals))) %>% #round values
  write_csv("results/tables/tableS6_pesticide_application_rate_by_scenario_and_region.csv")
#output is in kg pesticide per hectare
```

```{r Table S7. Region and Africa Model slopes and intercepts}
#generate table with the slope coefficient and intercept from each of the region-based regression models
tibble(
  `Emission Source` = c("Synthetic N application", "Manufacturing fertilizers", "Manufacturing pesticides", "On-farm fuel energy", "Machinery energy"),
  `Slope (b1)` = c(fert_emiss_ols$coefficients[2], fert_m_emiss_ols$coefficients[2], pest_emiss_ols$coefficients[2], en_emiss_ols$coefficients[2], m_emiss_ols$coefficients[2]),
  `Intercept (b0)` = c(fert_emiss_ols$coefficients[1], fert_m_emiss_ols$coefficients[1], pest_emiss_ols$coefficients[1], en_emiss_ols$coefficients[1], m_emiss_ols$coefficients[1])) %>%
  mutate(across(-`Emission Source`, ~round(., digits = decimals))) %>% #round values
  write_csv("results/tables/tableS7_region_model_slopes_and_intercepts.csv")
```

```{r Table S8. Fixed effects for each African Region in the regression models}
#generate table with the fixed effects for each region in the regression models
tibble(
  `Emission Source` = c("Synthetic N application", "Manufacturing fertilizers", "Manufacturing pesticides", "On-farm fuel energy", "Machinery energy"),
  `Middle Africa` = c(fert_emiss_ols$coefficients["factor(country)Middle"], fert_m_emiss_ols$coefficients["factor(country)Middle"], pest_emiss_ols$coefficients["factor(country)Middle"], en_emiss_ols$coefficients["factor(country)Middle"], m_emiss_ols$coefficients["factor(country)Middle"]),
  `Eastern Africa` = c(fert_emiss_ols$coefficients["factor(country)Eastern"], fert_m_emiss_ols$coefficients["factor(country)Eastern"], pest_emiss_ols$coefficients["factor(country)Eastern"], en_emiss_ols$coefficients["factor(country)Eastern"], m_emiss_ols$coefficients["factor(country)Eastern"]),
  `Northern Africa` = c(fert_emiss_ols$coefficients["factor(country)Northern"], fert_m_emiss_ols$coefficients["factor(country)Northern"], pest_emiss_ols$coefficients["factor(country)Northern"], en_emiss_ols$coefficients["factor(country)Northern"], m_emiss_ols$coefficients["factor(country)Northern"]),
  `Southern Africa` = c(fert_emiss_ols$coefficients["factor(country)Southern"], fert_m_emiss_ols$coefficients["factor(country)Southern"], pest_emiss_ols$coefficients["factor(country)Southern"], en_emiss_ols$coefficients["factor(country)Southern"], m_emiss_ols$coefficients["factor(country)Southern"]),
  `Western Africa` = c(fert_emiss_ols$coefficients["factor(country)Western"], fert_m_emiss_ols$coefficients["factor(country)Western"], pest_emiss_ols$coefficients["factor(country)Western"], en_emiss_ols$coefficients["factor(country)Western"], m_emiss_ols$coefficients["factor(country)Western"])) %>%
  mutate(across(-`Emission Source`, ~round(., digits = decimals))) %>% #round values
  write_csv("results/tables/tableS8_region_model_fixed_effects.csv")
```

```{r Table S9. LUC (ha) by crop}
#generate table with the LUC (ha) by crop
read_csv("int_data/luc_co2_country_crop.csv") %>%  #read in kg co2/ha carbon loss for crops for all countries; need to filter to just countries included
  select(Crop = Item, CountryName, scenario, luc, c_loss_ratio) %>%  
  mutate(CountryName = recode(CountryName, "Republic of the Congo" = "Congo", "Ivory Coast" = "Côte d’Ivoire" , "eSwatini" = "Eswatini")) %>% #change country names to match FAO names
  filter(CountryName %in% africa_scenario_countries,  #filter to just countries included
         c_loss_ratio == c_loss_selected) %>% #filter to c_loss_ratio used
  group_by(Crop, scenario) %>% summarize(sum_luc = sum(luc)) %>% #summarize to get total LUC for each crop)
  mutate(sum_luc = sum_luc/1000000) %>% #convert to million ha
  pivot_wider(names_from = scenario, values_from = sum_luc) %>% #pivot to wide format
  mutate(Crop = recode(Crop, !!!crop_full_names)) %>% #replace crop names w/full names
  select(Crop, "Baseline"=b, "Projected"=p, "High"=h) %>% #rename cols for presentation and change order of scenarios
  mutate(across(where(is.numeric), round, digits = decimals)) %>%  # Adjust the number of digits as needed
  write_csv("results/tables/tableS9_LUC_mha_by_crop.csv")
```

```{r Table S10. Carbon dioxide loss per hectare by crop for all countries combined}
c_to_co2 <- 44/12 #conversion factor from carbon to CO2

#create aggregated dataframe with average carbon value across all countries included in regression analysis, for each crop. this value represents the total difference in carbon between native vegetation and the crop, not the annual value
read_csv("int_data/LUC_CO2_crops.csv") %>% #read in country-crop level values of total LUC, total soil carbon loss, total veg loss, and avg. crop c stocks
  select(crop = id, country = ADMIN, soilsum, vegsum, lucsum, cstock, co2_ha = tot_H) %>%  #filter to just Houghton loss ratio of 25%
  mutate(country = recode(country, "Republic of the Congo" = "Congo", "Ivory Coast" = "Côte d’Ivoire" , "eSwatini" = "Eswatini")) %>% #change country names to match FAO names
  filter(is.na(cstock)==F,  #remove crops with missing crop carbon data
         !crop %in% c("bean", "coff"), #remove bean & coffee since not matched w/ FOFA and fao data and so not used in analysis
         country %in% africa_scenario_countries) %>% #remove countries not included in regression analysis
  group_by(crop) %>% #group by crop
  summarise(soilH = sum(soilsum, na.rm = TRUE)/sum(lucsum, na.rm = TRUE)  * c_to_co2 *  .25, #calculate total tons CO2e lost
            soilS = sum(soilsum, na.rm = TRUE)/sum(lucsum, na.rm = TRUE)  * c_to_co2 *  .4,
            veg = (sum(vegsum, na.rm = TRUE)/sum(lucsum, na.rm = TRUE) - mean(cstock))  * c_to_co2
  ) %>% 
  mutate(`LUC (t CO2e/ha)` = get(paste0("soil",c_loss_selected)) + veg,  #calculate total carbon loss from LUC with selected C loss ratio
         crop = recode(crop, !!!crop_full_names)) %>% #replace crop names w/full names
  select(Crop=crop, `Carbon Loss (t CO2e/ha)`) %>%  #select only crop and LUC columns
  mutate(across(where(is.numeric), round, digits = decimals)) %>%  # Adjust the number of digits as needed
  write_csv("results/tables/tableS10_tCO2_per_ha_loss_by_crop_for_included_countries.csv")
```

```{r Table S11. LUC (million ha) by region and scenario}
luc_co2_region %>% 
   mutate(region = recode(region, "Middle" = "Middle Africa", "Eastern" = "Eastern Africa", "Northern" = "Northern Africa", "Southern" = "Southern Africa", "Western" = "Western Africa")) %>%  #change to full names for regions
  select(Region = region, scenario, c_loss_ratio, luc) %>% 
  filter(c_loss_ratio == c_loss_selected) %>% 
  mutate(luc = luc / 1000000) %>% #convert to million ha
  pivot_wider(names_from = scenario, values_from = luc) %>% #pivot to wide format
  select(Region, Baseline, Projected, High) %>%  #select and reorder columns
  arrange(Region) %>% #order regions alphabetically
  mutate(across(where(is.numeric), round, digits = decimals)) %>%  # Adjust the number of digits as needed
  write_csv("results/tables/tableS11_LUC_mha_by_region.csv")
```

```{r Table S12. Sensitivity analysis: LUC and total input emissions by scenario and region, under linear model}
#generate table with the sensitivity analysis results for LUC and total input emissions by scenario and region, under linear model
africa_linear_sums %>% 
  filter(c_loss_ratio == c_loss_selected) %>% 
  select(Region = region, Scenario = scenario, `LUC emissions (Mt CO2e)` = luc_co2_high, `Total input emissions (Mt CO2e)` = tot_emiss, `Total emissions (Mt CO2e)` = tot_co2_high) %>% 
  mutate(Scenario = factor(Scenario, levels = c("Baseline", "Projected", "High"))) %>% arrange(Scenario) %>% #reorder scenario column
  mutate(across(where(is.numeric), round, digits = decimals)) %>%  # Adjust the number of digits as needed
  write_csv("results/tables/tableS12_LUC_and_total_input_emissions_mha_by_region_linear_model.csv")
```

```{r Table S13. Sensitivity analysis: LUC and total input emissions by scenario and region, data filtered to >=1990}
africa_1990_sums %>% 
  filter(c_loss_ratio == c_loss_selected) %>% 
  select(Region = region, Scenario = scenario, `LUC emissions (Mt CO2e)` = luc_co2_high, `Total input emissions (Mt CO2e)` = tot_emiss, `Total emissions (Mt CO2e)` = tot_co2_high) %>% 
  mutate(Scenario = factor(Scenario, levels = c("Baseline", "Projected", "High"))) %>% arrange(Scenario) %>% #reorder scenario column
  mutate(across(where(is.numeric), round, digits = decimals)) %>%  # Adjust the number of digits as needed
  write_csv("results/tables/tableS13_LUC_and_total_input_emissions_mha_by_region_post1990.csv")
```
