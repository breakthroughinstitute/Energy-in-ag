---
title: "Regression Analysis for Emissions Predictions"
authors: "Saloni Shah, Dan Blaustein-Rejto "
date: "originally started 11/06/2020; last modified 1/19/2024"
output: html_document
---
#SETUP
```{r Load packages}
library(zoo)
library(sandwich)
library(plm)
library(lmtest)
library(jtools) 
library(ggstance)
library(tidyverse)
library(janitor)
library(naniar)
library(wesanderson)
```

```{r Read in Data}
#pesticide use
pest_use <- read_csv("raw_data/faostat/pest_use.csv") %>% select(Country = Area, Year, pest_use = Value)
#units: tonnes use in country inc. all herbicides, insecticide, fungicide etc. timeframe: 1990-2020

#on-farm energy use emissions - converting to CO2e and subtracting fisheries energy emissions from total on-farm energy emissions
energy_emiss <- read_csv("raw_data/faostat/energy_use_emissions.csv") %>% 
  select(-Domain, -Unit) %>% #remove to avoid creating extra rows when pivoting since Units missing when value is NA
  pivot_wider(names_from = Element, values_from = Value) %>% 
  mutate(`Emissions (CH4)` = coalesce(`Emissions (CH4)`,0),  #replace NA with 0 in each emissions type
         `Emissions (N2O)` = coalesce(`Emissions (N2O)`,0),
         `Emissions (CO2)` = coalesce(`Emissions (CO2)`,0), 
         tot_co2e = (`Emissions (CH4)`*28) + (`Emissions (N2O)`*265) + `Emissions (CO2)`) %>%  # calculate total energy emissions, multiplying by AR5 GWP values FAO uses
  select(Country = Area, Year, tot_co2e, Item) %>%
  pivot_wider(names_from = Item, values_from = tot_co2e) %>% 
  mutate(en_emiss = `Total Energy` -coalesce(`Energy used in fishery`,0)) %>%  #calculate farm emissions as total - fishery 
  mutate(en_emiss = ifelse(en_emiss<0,NA,en_emiss)) %>%  #replace negative values w/ NA
  select(Country, Year, en_emiss)
#units: kilotonnes (i.e. gigagram) CO2e.  timeframe: 1970-2020

#on-farm diesel use, used to estimate emissions embodied in machinery
##we subtract out gas-diesel use in fisheries since FAO metadata says that the gas-diesel oil values  includes fisheries, then multiply by 40% to estimate embodied machinery energy, per Woods et al. (2010) https://royalsocietypublishing.org/doi/full/10.1098/rstb.2010.0172
m_energy <- read_csv("raw_data/faostat/diesel_use.csv") %>% 
  select(Country = Area, Year, Item, Value) %>% 
  pivot_wider(names_from = Item, values_from = Value) %>% 
  mutate(m_energy = rowSums(across(c(`Gas-Diesel oil`, -`Gas-diesel oils used in fisheries`), na.rm=T)) * .40) %>% 
  select(Country, Year, m_energy)
#units: Terajoules. #timeframe 1970-2020

#fertilizer application emissions
fert_emiss <- read_csv("raw_data/faostat/fert_use_emissions.csv") %>% select(Country = Area, Year, fert_emiss = Value)
#units: kilotonnes (i.e. gigagram) CO2e, using AR5 GWP. timeframe: 1961-2020

#synthetic fertilizer use and use per ha cropland
fert_use_per_ha <- read_csv("raw_data/faostat/fert_use_per_ha_cropland.csv") %>% select(Country = Area, Year, fert_use_ha = Value)
#N use per ha of cropland. units: kg nutrient N/ha timeframe: 1961-2020

fert_use <- read_csv("raw_data/faostat/fert_use.csv") %>% select(Country = Area, Year, fert_use = Value) %>% mutate(fert_use= fert_use*1000)
#N agricultural use. units: convert from original units of tonnes N to kg N. timeframe: 1961-2020

#Yield and Cropland Data from calculate_calories_per_cropland.Rmd
prod <- read_csv("int_data/prod.cropland.csv")

#scenarios for regression analysis
scenarios <- read_csv("int_data/scenarios.csv") %>%  #yields are in kcal/ha
  mutate(region = recode(region, E_Afr = "East", C_Afr = "Central", S_Afr = "South", N_Afr = "North", W_Afr = "West")) %>%   #Convert country names in scenarios to East, West, Central, South, North
  dplyr::rename(country=region) #rename column to match with variable name used to fit regression
```

```{r Calculate total fuel emissions, calculate emissions per ha for each input }
#join datasets
reg <- full_join(energy_emiss, fert_emiss) %>% full_join(fert_use) %>% full_join(fert_use_per_ha) %>% full_join(pest_use) %>% full_join(m_energy) %>% full_join(prod, by =  c("Country" = "country", "Year" = "year"))

#Fill in missing data for each column by country. Apply the last one carried forward method to each column in the dataframe (called reg below), grouping by country so that if the first observation is NA, the function doesn't replace with observation from different country. Will not fill in data for previous years.
reg <- reg %>% group_by(Country) %>% arrange(Country, Year) %>% fill(en_emiss:cropland)

#Calculate each emissions or input use per ha 
reg$en_emiss_ha <-reg$en_emiss/reg$cropland #units are gigagrams/ha
reg$p_ha <- reg$pest_use/reg$cropland #units are tons applied/ha
reg$fert_emiss_ha <- reg$fert_emiss/reg$cropland#units are gigagrams/ha
reg$m_energy_ha <- reg$m_energy/reg$cropland#units are Terajoules/ha

#reg calc yield
reg$yield <-  reg$tot_kcal/reg$cropland
# plot(reg$yield, reg$fert_emiss_ha, main = "Yield vs. Syn N emissions per ha")
# plot(reg$yield, reg$fert_use_ha, main = "Yield vs. Syn N use per ha")
# plot(reg$yield, reg$en_emiss_ha, main = "Yield vs. On farm fuel emissions per ha")
# plot(reg$yield, reg$p_ha, main = "Yield vs. Pesticides use per ha")
```

```{r Clean Data }
reg <-  clean_names(reg)  #makes all names lower case

#Determine if all yield values are non-zero
sum(reg$tot_kcal ==  0, na.rm=T) #none zero
sum(reg$cropland ==  0, na.rm=T) #none zero

#check for duplicate rows
get_dupes(reg, country, year) # no duplicates found

#count fuel emissions per ha, pesticide, and synthetic N observations by country
reg %>% group_by(country) %>% summarize(count = sum(is.na(en_emiss_ha)==FALSE)) 
reg %>% group_by(country) %>% summarize(count = sum(is.na(p_ha)==FALSE))
reg %>% group_by(country) %>% summarize(count = sum(is.na(fert_emiss_ha)==FALSE))
#results indicate different number of obs per country, an unbalanced panel dataset

#Convert 0's to NA's  - Not likely that a country has 0 fertilizer or fuel use if production and cropland  values are all non-zero. Likely that the "0" is missing data. These false 0's might influence regression estimates. All 0's will be converted to NAs and the regression will automatically eliminate all NAs. 
reg <- naniar::replace_with_na_all(data = reg, condition = ~.x == 0)

# #Graph data to inspect for outliers
# boxplot(reg$fert_use_ha)
# boxplot(reg$p_ha) #visual representation of data points and outliers. #values are generally within 0.137 tons P/ha maximum (from World Bank) ; 5698 values are NA
# plot(reg$yield, reg$en_emiss_ha) #there are some values for which yields are 0 but fuel emissions per ha is above 0.010 Gg/ha, values that are higher than 0.015 Gg/ha are all from Singapore, everything else is lower than 0.010
# boxplot(reg$en_emiss_ha) #429 outliers
# plot(reg$yield, reg$m_energy_ha)  #outliers with values > 1 primarily Singapore, China Hong Kong, Kuwait
# plot(reg$yield, reg$fert_emiss_ha) #some high values have nearly 0 yields,  2012 values are NA, values are lower in magnitude 
# boxplot(reg$fert_emiss_ha)
# ggplot(reg) + geom_density(aes(fert_emiss_ha))

#remove countries with many substantial and unexplainable outlier values
outlier_en_countries <- reg %>% filter(en_emiss_ha>=0.15) %>% distinct(country) %>% pull() 
outlier_p_countries <- reg %>% filter(p_ha>=0.1) %>% distinct(country) %>% pull() 
outlier_m_countries <- reg %>% filter(m_energy_ha>=1.) %>% distinct(country) %>% pull() 
reg <- reg %>% filter(!country %in% c(outlier_en_countries, outlier_p_countries, outlier_m_countries))

write_csv(reg, "int_data/reg.csv")
```

```{r Aggregate African countries data by region} 
#Subset by regions
#Member countries within each region are from the UN Statistics division : https://unstats.un.org/unsd/methodology/m49/overview/
country_groupings <- readxl::read_excel("raw_data/UNSD — Methodology.xlsx")

Africa <- country_groupings %>% filter(`Region Name`=="Africa") %>% select(`Country or Area`) %>% arrange(`Country or Area`) %>% pull()
W_Afr <- country_groupings %>% filter(`Intermediate Region Name`=="Western Africa") %>% select(`Country or Area`) %>% arrange(`Country or Area`) %>% pull()
E_Afr <- country_groupings %>% filter(`Intermediate Region Name`=="Eastern Africa") %>% select(`Country or Area`) %>% arrange(`Country or Area`) %>% pull()
C_Afr <- country_groupings %>% filter(`Intermediate Region Name`=="Middle Africa") %>% select(`Country or Area`) %>% arrange(`Country or Area`) %>% pull()
S_Afr <- country_groupings %>% filter(`Intermediate Region Name`=="Southern Africa") %>% select(`Country or Area`) %>% arrange(`Country or Area`) %>% pull()
N_Afr <- country_groupings %>% filter(`Sub-region Name`=="Northern Africa") %>% select(`Country or Area`) %>% arrange(`Country or Area`) %>% pull()

#define countries in Africa without matching names in faostat data in order to make names consistent for joining
Africa[which(!Africa %in% unique(reg$country))]

#match all possible, based on manual examination of faostat countries.  non-matching ones aren't listed separately in faostat
reg$country <- recode(reg$country, "Côte d'Ivoire"="Côte d’Ivoire")

#create new coumn with names as factors to revise
reg <- mutate(reg, Country_rename = country)

# add region name for countries in african regions AND in list of africa countries included in FOFA. this ensures that later regressions are conducted such that the fixed effect for a region only includes countries that are in the region for which predictions are being made (i.e. FOFA projections for northern africa exclude libya)
 africa_scenario_countries <- read.csv(file = "int_data/countries_included_in_africa.csv")[,2]
 reg$Country_rename[reg$Country_rename %in% E_Afr & reg$country %in% africa_scenario_countries] <-  "E_Afr"
 reg$Country_rename[reg$Country_rename %in% W_Afr & reg$country %in% africa_scenario_countries] <-  "W_Afr"
 reg$Country_rename[reg$Country_rename %in% C_Afr & reg$country %in% africa_scenario_countries] <-  "C_Afr"
 reg$Country_rename[reg$Country_rename %in% S_Afr & reg$country %in% africa_scenario_countries] <-  "S_Afr"
 reg$Country_rename[reg$Country_rename %in% N_Afr & reg$country %in% africa_scenario_countries] <-  "N_Afr"

aggregate_reg <- function(region_data, region_name){
  output <- region_data %>% select(year,cropland, tot_kcal, en_emiss, fert_use, pest_use, fert_emiss, m_energy) %>% 
  group_by(year) %>%
  summarise_all(sum, na.rm= TRUE) #sum total values across region by year
  
  #calculate per hectare values
  output <- output %>% mutate(yield = tot_kcal/cropland, en_emiss_ha = en_emiss/cropland, p_ha = pest_use/cropland, fert_emiss_ha = fert_emiss/cropland, fert_use_ha = fert_use/cropland, m_energy_ha = m_energy/cropland, country = region_name)
  
  return(output)
}

# #filter data by region
reg_E <- dplyr::filter(reg,reg$Country_rename == "E_Afr" )
reg_W <- dplyr::filter(reg,reg$Country_rename == "W_Afr" )
reg_C <- dplyr::filter(reg,reg$Country_rename == "C_Afr" )
reg_S <- dplyr::filter(reg,reg$Country_rename == "S_Afr" )
reg_N <- dplyr::filter(reg,reg$Country_rename == "N_Afr" )

reg_E_aggregate <- aggregate_reg(reg_E, "East")
reg_W_aggregate <- aggregate_reg(reg_E, "West")
reg_S_aggregate <- aggregate_reg(reg_E, "South")
reg_N_aggregate <- aggregate_reg(reg_E, "North")
reg_C_aggregate <- aggregate_reg(reg_E, "Central")
```

```{r Load in other countries' data and join it with African regions data}
#Filter out Africa data, keep non-Africa data 
reg_other_country <- reg %>% filter(!Country_rename %in% c("N_Afr", "C_Afr", "S_Afr","E_Afr","W_Afr")) %>% select(-Country_rename)

#Join Africa data with all of the countries' (non Africa) data
reg_all_countries <- bind_rows(reg_other_country, reg_C_aggregate, reg_E_aggregate, reg_S_aggregate, reg_W_aggregate, reg_N_aggregate)
```

```{r Explore data and remove outliers}

#OLS model includes country fixed effect to reduce bias

reg_all_countries <- naniar::replace_with_na_all(data = reg_all_countries, condition = ~.x == 0) #Make sure all 0's are converted to NAs, lm function automatically removes data with NAs 

# #Outlier detection is based on yield values, could extend to the other inputs 
# summary(reg_all_countries$yield)
# boxplot(reg_all_countries$yield)
# hist(reg_all_countries$yield,
#   xlab = "yield",
#   main = "Histogram of yield",
#   breaks = sqrt(nrow(reg_all_countries))) # set number of bins
# #Barbados, Kuwait, Belgium, Martinque occupy many of the highest values
# #higher than 2*10^7 is an outlier based on historgram and barplot
# sum(reg_all_countries$yield >= 20000000, na.rm=T) #32 entries
# sum(reg_all_countries$yield >= 20000000, na.rm=T)/nrow(reg_all_countries) #~.5% of total entries
filter_reg <- filter(reg_all_countries, reg_all_countries$yield < 20000000)

##data on outliers for inputs
# summary(reg_all_countries$fert_emiss)
# boxplot(reg_all_countries$fert_emiss)
# hist(reg_all_countries$fert_emiss,
#   xlab = "fuel",
#   main = "Histogram of fuel",
#   breaks = sqrt(nrow(reg_all_countries)))
# 
# summary(reg_all_countries$fert_use)
# boxplot(reg_all_countries$fert_use)
# hist(reg_all_countries$fert_use,
#   xlab = "fert_use",
#   main = "Histogram of fuel",
#   breaks = sqrt(nrow(reg_all_countries)))
# 
# boxplot(reg_all_countries$pesticides_total)
# hist(reg_all_countries$pesticides_total,
#   xlab = "pesticides",
#   main = "Histogram of fuel",
#   breaks = sqrt(nrow(reg_all_countries)))
# 
# summary(reg_all_countries$fuel_emissions)
# hist(reg_all_countries$fuel_emissions,
#   xlab = "fuel",
#   main = "Histogram of fuel",
#   breaks = sqrt(nrow(reg_all_countries)))

```

#Regression Code
```{r Run OLS linear regressions with filtered regression data to estimate relationship between yield and input use factor}
#regressions have country fixed effect where africa regions (e.g. east, west) are used as countries, enabling prediction later
p_ols <- lm(filter_reg, formula = log(p_ha) ~ log(yield) + factor(country)) #Pesticides Use OLS regression
fuel_ols <- lm(filter_reg , formula = log(en_emiss_ha) ~ log(yield) + factor(country)) #Fuel Emissions OLS Regression
syn_n_ols <- lm(filter_reg, formula = log(fert_emiss_ha) ~ log(yield) + factor(country)) #Synthetic N emissions OLS Regression 
fert_use_ols <- lm(filter_reg, formula = log(fert_use_ha) ~ log(yield) + factor(country))#Synthetic N use or application OLS regression
m_energy_ols <- lm(filter_reg, formula = log(m_energy_ha) ~ log(yield) + factor(country))#Energy embodied in machinery OLS regression
```

```{OLS regression with africa data aggregated at continent level}
#fit regression models again with data for african countries and regions aggregated at the continent level. this lets us make continent-level predictions below with proper uncertainty levels
africa_level_reg <- filter_reg %>% mutate(country = recode(country, "East"="Africa", "West"="Africa","Central"="Africa","South"="Africa","North"="Africa")) %>%
                                            group_by(country, year) %>% 
                                            summarize(across(c(en_emiss, fert_emiss, pest_use, fert_use, m_energy, tot_kcal, cropland), sum, na.rm=T)) %>% 
                                            mutate(yield = tot_kcal/cropland, en_emiss_ha = en_emiss/cropland, p_ha = pest_use/cropland, fert_emiss_ha = 
                                                     fert_emiss/cropland, fert_use_ha = fert_use/cropland, m_energy_ha = m_energy/cropland)
africa_level_reg <- naniar::replace_with_na_all(data = africa_level_reg, condition = ~.x == 0) #replace 0s with NA 
afr_p_ols <- lm(africa_level_reg, formula = log(p_ha) ~ log(yield) + factor(country)) #Pesticides Use OLS regression
afr_fuel_ols <- lm(africa_level_reg , formula = log(en_emiss_ha) ~ log(yield) + factor(country)) #Fuel Emissions OLS Regression
afr_syn_n_ols <- lm(africa_level_reg, formula = log(fert_emiss_ha) ~ log(yield) + factor(country)) #Synthetic N emissions OLS Regression 
afr_fert_use_ols <- lm(africa_level_reg, formula = log(fert_use_ha) ~ log(yield) + factor(country))#Synthetic N use or application OLS regression
afr_m_energy_ols <- lm(africa_level_reg, formula = log(m_energy_ha) ~ log(yield) + factor(country))#Energy embodied in machinery OLS regression
```


```{r Sanity Check on parameters - optional for running}
#Check to see that that the model fitted values match the log(actual values) in the regression dataset, values should fall around 1:1 line

# plot(x = log(na.omit(filter_reg$p_ha)), y = p.ols$fitted.values, xlab = "True values", ylab = "Model Fitted values", main = "Regression fits of pesticide/ha values")
# abline(b=1, a=0) #values fall around this 1:1 line 
# 
# plot(x = log(na.omit(filter_reg$en_emiss_ha)), y = fuel.ols$fitted.values, xlab = "True values", ylab = "Model Fitted values", main = "Regression fits of fuel/ha values")
#  abline(b=1, a=0) #values fall around this 1:1 line 
# 
# plot(x = log(na.omit(filter_reg$fert_emiss_ha)), y = syn_n.ols$fitted.values, xlab = "True values", ylab = "Model Fitted values", main = "Regression fits of synN/ha values")
# abline(b=1, a=0) #values fall around this 1:1 line 
# 
# plot(log(na.omit(filter_reg$fert_use_ha)), fert_use.ols$fitted.values,xlab = "True values", ylab = "Model Fitted values", main = "Regression fits of synN use/ha values"  )
# abline(b=1, a=0) #values fall around this 1:1 line 
```

```{r Sensitivity analysis running OLS with data filtered to last 20 years}
#filter_reg_yrs <- filter(filter_reg, filter_reg$year > 1996) #sensitivity analysis - use last 20 years of data
#p.ols <- lm(filter_reg_yrs , formula = log(p_ha) ~ log(yield) + factor(country)) #last 20 years sensitivity
#fuel.ols <- lm(filter_reg_yrs , formula = log(en_emiss_ha) ~ log(yield) + factor(country)) #last 20 years sensitivity
#syn_n.ols <- lm(filter_reg_yrs, formula = log(fert_emiss_ha) ~ log(yield) + factor(country))
#fert_use.ols <- lm(filter_reg_yrs, formula = log(fert_use_ha) ~ log(yield) + factor(country))
#m_en.ols <- lm(filter_reg_yrs, formula = log(m_energy_ha) ~ log(yield) + factor(country))
```

```{r Calculate predicted input use per ha by input, scenario and region}
#fixed effect regression results
reg_fe <- function(dependent_variable, scenario, region){
  output <- exp(predict(dependent_variable, 
              newdata = scenarios[scenarios$country==region & scenarios$scenario==scenario, c("region", "yield")], 
              interval = "confidence", level = 0.95))
  return(output)
}

reg_fe_results <- tibble(dep_var=character(), scenario = character(), region = character(), fit=double(), lwr = double(), upr = double())

i=1
#define regions to loop through
regions <- unique(scenarios$country)
regions <- regions[!regions =="Africa"]

#map variables to model names
var_models = tibble(var = c("en_emiss_ha", "fert_use_ha", "fert_emiss_ha", "p_ha", "m_energy_ha"),
                   model = c("fuel_ols", "fert_use_ols", "syn_n_ols", "p_ols", "m_energy_ols"))

#loop through each dependent variable, scenario, and region to predict each dep variable for each region & scenario
for (dependent_variable in var_models$var) {
  for (scenario in unique(scenarios$scenario)){
    for (region in regions){
      
      reg_fe_results[i,] = c(dependent_variable, 
                            scenario, 
                            region, 
                            as_tibble(exp(predict(get(var_models$model[var_models$var==dependent_variable]), #choose regression model 
              newdata = scenarios[scenarios$country==region & scenarios$scenario==scenario, c("country", "yield")], 
              interval = "confidence", level = 0.95))))
      i=i+1
    }
  }
}
```

```{r Add predictions for Africa to above dataframe of predicted input use per ha by input, scenario and region}
for (dependent_variable in var_models$var) {
  for (scenario in unique(scenarios$scenario)){
    reg_fe_results[i,] = c(dependent_variable, 
                            scenario, 
                            "Africa", 
                            as_tibble(exp(predict(
                              get(paste0("afr_",var_models$model[var_models$var==dependent_variable])), #choose regression model 
                              newdata = scenarios[scenarios$country=="Africa" & scenarios$scenario==scenario, c("country", "yield")], 
                              interval = "confidence", level = 0.95
                              ))))
    i=i+1
  }
}
```

```{r Calculate total predicted emissions for each input source, region, and scenario}
#make reg results dataframe longer
reg_fe_results <- reg_fe_results %>% pivot_longer(c(fit, lwr, upr), names_to = "estimate")

#Conversion factors for fertilizer and pesticides manufacturing emissions
fert_ef <- 5.66 #5.66 kg CO2 eq/kg product  is the fertilizer EF
pest_ef <- 25.5 # 25.5 kg cO2e/kg applied is the pesticides EF
kg_to_Gg <- 1/10^6  #1 Gg/1 * 10^6 kg
tons_to_Gg <- .001 #tons to Gg; formula with units : X tons applied *  Y tons CO2eq/tons product applied * .001 Gg/ ton. Y represents the pesticides emissions factor.
tpes_ef <- 34 #emissions factor for primary energy supply for Africa (34 tons CO2 eq/Terajoules), carbon intensity of energy mix

reg_fe_results <- reg_fe_results %>% 
  mutate(dep_var = recode(dep_var, #change var names for resulting table. for recode, format is old = new
                          "fert_use_ha"="f_m", "p_ha"="pest", "en_emiss_ha"="en", "fert_emiss_ha"="f_a", "m_energy_ha" = "m_en")) %>% 
  left_join(scenarios, by = c("region" = "country", "scenario")) %>% #add production scenario variables i.e. yield, area to fe regression results table. 
  pivot_wider(names_from = dep_var, values_from = value) %>% #make wide to multiple columns for fertilizer and pesticide use per ha by emission factors  
  mutate(across(starts_with("f_m"),  ~.x*harv_area*fert_ef*kg_to_Gg), #convert kg fertilizer use/ha to Gg CO2e emissions from manufacturing for all fert use
         across(starts_with("pest"),  ~.x*harv_area*pest_ef*tons_to_Gg), #convert tons pesticide use/ha to Gg CO2e emissions from manufacturing for all pesticide use
         across(starts_with("en"),  ~.x*harv_area), #convert Gg CO2e from energy use per ha  to Gg CO2 from total energy use
         across(starts_with("f_a"),  ~.x*harv_area), #convert Gg CO2e from fert application per ha to Gg CO2 from total application
         across(starts_with("m_"),  ~.x*harv_area*tpes_ef*tons_to_Gg) #convert from Terajoules per ha to gigagran Co2e from total machinery embodied energy
         )
```

```{r Export table of predicted values }
#"Manufacturing Pesticides", "On-Farm Fuel","Synthetic N", "Manufacturing Fertilizers", "Embodied Energy in Machinery")
```

```{r Add LUC data to Energy emissions data}
region_key <- c(C_Afr="Central", E_Afr="East", N_Afr = "North", S_Afr="South", W_Afr="West")

convert_luc_co2 <- function(x){return(x * kg_to_Gg/38)} # convert to Gg and divide by 38, the number of years between 2012 and 2050, this division annualizes the emissions

luc_co2_region <- read_csv("int_data/luc_co2_region.csv") %>%  #read in kg CO2e from LUC by region and scenario, with low values calculated allowing for negative LUC for crops (i.e. restoration) and high values setting all negative LUC to 0.
  mutate(region = recode(region, !!!region_key)) %>%  #rename regions for joining
  rename(luc_co2_low = co2_low, luc_co2_high=co2_high) %>%  #clarify column names
  mutate(across(c(luc_co2_low, luc_co2_high), convert_luc_co2)) #convert to Gg CO2/yr

all_emiss <- full_join(reg_fe_results, luc_co2_region) %>%  #join input and LUC emissions
  mutate(tot_input_co2 = en + f_m + f_a + pest + m_en,  
    tot_co2_high = tot_input_co2 + luc_co2_high,
    tot_co2_low = tot_input_co2 + luc_co2_low)

write_csv(all_emiss,"results/all_emiss_region.csv")
```

```{r Plot GHG data across Africa's regions and for SSA as a whole}

GHG_Afr <- GHG[GHG$Region == "Africa",] #have separate charts for SSA data to compare to region breakdown
GHG <- anti_join(GHG, GHG_Afr)
#GHG_high <- GHG[GHG$Scenario == "High",] #Use High_alt as High
#GHG <- anti_join(GHG,GHG_high)
GHG$Scenario <- factor(GHG$Scenario ,levels = c("Baseline", "Projected", "High_alt")) #Change order of bars so it is not in alphabetical order, but rather in the order of the yield-scenarios
x.axis <- c("Baseline", "Projected", "High")

#use BTI style guide for charts
#set up
library(tidyverse); library(grid); 
#library(RCurl)

#set fonts 
load_font <- function() {
  text_font <<-  "Manuale"
  title_font <<- "Futura"
  print("Note: Download Futura.ttc and Manuale-Regular.ttf fonts first. Default location should be Library/Fonts/ folder. Url: https://www.dropbox.com/work/Style%20Guide/BTI%20Letterhead/Letterhead%20Font")
  library(sysfonts) 
  library(showtext)
  sysfonts::font_add(family="Futura", regular = "~/Library/Fonts/Futura.ttc")  #~/../../System/Library/Fonts/Supplemental/Futura.ttc")   #ttf: futura-regular.ttf
  sysfonts::font_add(family="Manuale", regular = "~/Library/Fonts/manuale-regular.ttf")
  showtext_auto()
}

bti_colors <- c("#0d4459", "#00a990", "#d05527", "#a33332",
                "#b381d0",  "#dfb9a6", "#b2b2b1", "#2A2A2A", "#ecc627")
#general plot theme
theme_bti <- function (base_size = 14, base_family = "Helvetica") {
  theme_classic() %+replace% 
    theme(plot.title = element_text(color = "black",  size = 14), 
          strip.text.x = element_text(size = 14),
          strip.background = element_blank(),
          
          #gridlines
          panel.grid.major.y = element_blank(), panel.grid.minor.y = element_blank(), #no grid lines
          panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank(), #no grid lines
          #background and border
          panel.border = element_blank(), #no plot border
          #panel.background = element_rect(fill = "white"), #white panel background 
          #legend
          legend.position = "bottom", #legend default position is bottom
          legend.key = element_rect(fill = "#FFFFFF00", color = NA), #no border around legend items
          legend.text = element_text(size=10),
          legend.title = element_text(size=10),
          #axes
          axis.line.x = element_line(color="black", size = .5),
          axis.line.y = element_line(color="black", size = .5),
          axis.title.y = element_text(size = 12, angle = 90), 
          axis.title.x = element_text(size = 12), 
          #logo 
          plot.margin = unit(c(0.5, 0.5, 2, 0.5), "lines") # add space for logo
    )
}

#percent stacked bar chart by region
GHG$Region <- factor(GHG$Region, levels = c("West", "East", "Southern", "Central", "North"))
GHG$Scenario <- factor(GHG$Scenario ,levels = c("Baseline", "Projected", "High"))
GHG_region <- ggplot(GHG, aes(fill= Region, y= GHG, x= Scenario)) + 
    geom_bar(position="fill", stat="identity") + ggtitle(expression(paste("% Greenhouse emissions by region in Africa for each scenario"))) + xlab("Scenarios") + ylab("% of each scenario's GHG emissions") + labs(fill = "Regions")  + scale_x_discrete(labels= x.axis) +  theme(axis.title.x = element_text(color="black",size=12),axis.title.y = element_text(color="black", size=12) ,panel.background = element_rect(fill = NA),
       panel.grid.major.y = element_line(colour="grey68",linetype="solid"),
       panel.grid.major.x = element_line(colour="grey68",linetype="solid"),axis.ticks.y = element_blank(),axis.ticks.x=element_blank(),
       plot.title = element_text(size=15, face="bold")) 
      # plot.background = element_rect(fill=NA), legend.key=element_rect(fill=NA)
GHG_region <- GHG_region  +  scale_fill_manual(values=wes_palette(n=5, name="Darjeeling1")) 
GHG_region
ggsave(filename = "~/Google Drive/My Drive/Food & Farming/Energy in ag/results/Graphs/New Graphs/GHG_region.png", GHG_region) #save ggplot, not great with dimensions, might use current plot window as default plot size and so may need to specify width and height, dims: Saving 7.29 x 4.51 in image


#bar chart by region, grouped

GHG$Region <- factor(GHG$Region, levels = c("West", "East", "Southern", "Central", "North"))
GHG_region_grouped <- ggplot(GHG, aes(fill= Region, y= GHG, x= Scenario)) + 
    geom_bar(position="dodge", stat="identity") + ggtitle(expression(paste("Greenhouse emissions by scenario and region in Africa"))) + xlab("Scenarios") + ylab("GHG Emissions (Gigagtons CO2eq)") + labs(fill = "Regions")  + scale_x_discrete(labels= x.axis) +  theme_bti()

GHG_region_grouped <- GHG_region_grouped  +  scale_fill_manual(values=bti_colors) 
ggsave(filename =  "~/Google Drive/My Drive/Food & Farming/Energy in ag/results/Graphs/New Graphs/GHG_region_grouped.png", plot = GHG_region_grouped )
GHG_region_grouped

#Stacked
GHG_region_stacked <- ggplot(GHG, aes(fill= Region, y= GHG, x= Scenario)) + 
    geom_bar(position="stack", stat="identity") + ggtitle(expression(paste("Greenhouse emissions by scenario for each region in Africa"))) + xlab("Scenarios") + ylab("GHG emissions (Gt CO2eq)") + labs(fill = "African regions")  + scale_x_discrete(labels= x.axis) +  theme(axis.title.x = element_text(color="black",size=12),axis.title.y = element_text(color="black", size=12) ,panel.background = element_rect(fill = NA),
       panel.grid.major.y = element_line(colour="grey68",linetype="solid"),
       panel.grid.major.x = element_line(colour="grey68",linetype="solid"),axis.ticks.y = element_blank(),axis.ticks.x=element_blank(),
       plot.title = element_text(size=15, face="bold")) 
      # plot.background = element_rect(fill=NA), legend.key=element_rect(fill=NA)
GHG_region_stacked <- GHG_region  +  scale_fill_manual(values=bti_colors) 
ggsave(filename = "~/Google Drive/My Drive/Food & Farming/Energy in ag/results/Graphs/New Graphs/GHG_region_stacked.png", plot = GHG_region_stacked, width = , height = )

# Africa
#GHG_Afr_high <- GHG_SSA[GHG_Afr$Scenario == "High",] #Use High_alt as High
#GHG_Afr <- anti_join(GHG_Afr,GHG_SSA_high)
GHG_Afr$Scenario <- factor(GHG_Afr$Scenario ,levels = c("Baseline", "Projected", "High_alt"))

GHG_Afr_plot <- ggplot(GHG_Afr, aes(y = GHG, x= Scenario)) + 
    geom_bar(position= "stack", stat="identity",fill = "#0DC3A8") + ggtitle(expression(paste("Greenhouse emissions by scenario in Africa"))) + xlab("Scenarios") + ylab("GHG Emissions (Gigatons CO2eq)") + labs(fill = "African regions")  + scale_x_discrete(labels= x.axis) +  theme(axis.title.x = element_text(color="black",size=12),axis.title.y = element_text(color="black", size=12) ,panel.background = element_rect(fill = NA),
       panel.grid.major.y = element_line(colour="grey68",linetype="solid"),
       panel.grid.major.x = element_line(colour="grey68",linetype="solid"),axis.ticks.y = element_blank(),axis.ticks.x=element_blank(),
       plot.title = element_text(size=15, face="bold"))
 ggsave(filename = "~/Google Drive/My Drive/Food & Farming/Energy in ag/results/Graphs/New Graphs/GHG_Afr.png", plot = GHG_Afr_plot )   


```

```{r Energy emissions by region }
#Melt data for ggplot
Energy_emis <- melt(Energy_emis)
colnames(Energy_emis) <- c("Energy_Scenario", "Region", "Value")
Energy_emis$Value <- Energy_emis$Value * Gg_to_Gt


#separate scenario from energy source into 2 columns
Energy_emis$Energy_Scenario <- str_replace(Energy_emis$Energy_Scenario, "synN_use", "synNuse") ##change "syn_use_" to synuse to make it easier to separate values into 2 cols
Energy_emis$Energy_Scenario <- str_replace(Energy_emis$Energy_Scenario, "h_alt", "alt")
Energy_emis <- Energy_emis %>% separate(Energy_Scenario, c("Energy Source", "Scenario"), "_")

#Change naming conventions to match that of error bars to making joining easier
Energy_emis$`Energy Source` <- str_replace(Energy_emis$`Energy Source`, "synNuse","Manufacturing Fertilizers")
Energy_emis$`Energy Source` <- str_replace(Energy_emis$`Energy Source`, "pest","Manufacturing Pesticides")
Energy_emis$`Energy Source` <- str_replace(Energy_emis$`Energy Source`, "m","Embodied Energy in Machinery")
Energy_emis$`Energy Source` <- str_replace(Energy_emis$`Energy Source`, "synN","Synthetic N")
Energy_emis$`Energy Source` <- str_replace(Energy_emis$`Energy Source`, "fuel","On-Farm Fuel")

Energy_emis$Scenario <- str_replace(Energy_emis$Scenario, "base","Baseline")
Energy_emis$Scenario <- str_replace(Energy_emis$Scenario, "proj","Projected")
Energy_emis$Scenario <- str_replace(Energy_emis$Scenario, "alt","High")

#Split data by region
Energy_emis_E<- filter(Energy_emis, Region == "East")
Energy_emis_W <- filter(Energy_emis, Region == "West")
Energy_emis_S <- filter(Energy_emis, Region == "Southern")
Energy_emis_C <- filter(Energy_emis, Region == "Central")
Energy_emis_N <- filter(Energy_emis, Region == "North")
Energy_emis_Afr <- filter(Energy_emis, Region == "Africa")
Energy_emis_N$Region <- NULL
Energy_emis_S$Region <- NULL
Energy_emis_W$Region <- NULL
Energy_emis_E$Region <- NULL
Energy_emis_C$Region <- NULL
Energy_emis_Afr$Region <- NULL


```


```{r Energy emissions charts by region }
#Add in upper and lower error bars data for each region and multiply by cropland, emissions & conversions factors if necessary 

#North Africa
colnames(lwr_N) <- c("Energy Source", "Scenario", "lwr")
colnames(upr_N) <- c("Energy Source", "Scenario", "upr")
lwr_N$`Energy Source`<- trimws(lwr_N$`Energy Source`) #eliminate extra spaces in energy source strings
upr_N$`Energy Source`<- trimws(upr_N$`Energy Source`) #eliminate extra spaces in energy source strings
lwr_N$Scenario <- str_replace(lwr_N$Scenario, "High_alt", "High")
upr_N$Scenario <- str_replace(upr_N$Scenario, "High_alt", "High")
lwr_N$Scenario <- as.character(lwr_N$Scenario)
upr_N$Scenario <- as.character(upr_N$Scenario)

#join upper and lower 95% CI values from the model with the estimates of energy emissions by source
Energy_emis_N <- right_join(Energy_emis_N, lwr_N, by = c("Energy Source", "Scenario"))
Energy_emis_N <- right_join(Energy_emis_N, upr_N, by = c("Energy Source", "Scenario"))

#Multiply 95% CI estimates by cropland  
Energy_emis_N$cropland[Energy_emis_N$Scenario == "Baseline"] <- area_b$harv_area[area_b$region == "North"]
Energy_emis_N$cropland[Energy_emis_N$Scenario == "Projected"] <-  area_p$harv_area[area_p$region == "North"]
Energy_emis_N$cropland[Energy_emis_N$Scenario == "High"] <-  area_h_alt$harv_area[area_h_alt$region == "North"]
#Converts upper and lower estimates are in Gigagrams or tons (manufacturing pesticides is in tons)
Energy_emis_N$lwr <- Energy_emis_N$lwr * Energy_emis_N$cropland  
Energy_emis_N$upr <- Energy_emis_N$upr * Energy_emis_N$cropland 

Energy_emis_N$lwr[Energy_emis_N$`Energy Source` == "Manufacturing Fertilizers"] <- Energy_emis_N$lwr[Energy_emis_N$`Energy Source` == "Manufacturing Fertilizers"] * fert_ef  * kg_to_Gg
Energy_emis_N$lwr[Energy_emis_N$`Energy Source` == "Manufacturing Pesticides"] <- Energy_emis_N$lwr[Energy_emis_N$`Energy Source` == "Manufacturing Pesticides"] * pest_ef  * tons_to_Gg
Energy_emis_N$upr[Energy_emis_N$`Energy Source` == "Manufacturing Fertilizers"] <- Energy_emis_N$upr[Energy_emis_N$`Energy Source` == "Manufacturing Fertilizers"] * fert_ef  * kg_to_Gg
Energy_emis_N$upr[Energy_emis_N$`Energy Source` == "Manufacturing Pesticides"] <- Energy_emis_N$upr[Energy_emis_N$`Energy Source` == "Manufacturing Pesticides"] * pest_ef  * tons_to_Gg

#Convert all lower and upper estimates to Gigatons to match the units of the fitted values
Energy_emis_N$lwr <- Energy_emis_N$lwr * Gg_to_Gt
Energy_emis_N$upr <- Energy_emis_N$upr * Gg_to_Gt


#southern Africa
colnames(lwr_S) <- c("Energy Source", "Scenario", "lwr")
colnames(upr_S) <- c("Energy Source", "Scenario", "upr")
lwr_S$`Energy Source` <- trimws(lwr_S$`Energy Source`)
upr_S$`Energy Source` <- trimws(upr_S$`Energy Source`)
lwr_S$Scenario <- str_replace(lwr_S$Scenario , "High_alt", "High")
upr_S$Scenario <- str_replace(upr_S$Scenario , "High_alt", "High")
Energy_emis_S <- right_join(Energy_emis_S, lwr_S, by = c("Energy Source", "Scenario"))
Energy_emis_S <- right_join(Energy_emis_S, upr_S, by = c("Energy Source", "Scenario"))


#Multiply 95% CI estimates by cropland  
Energy_emis_S$cropland[Energy_emis_S$Scenario == "Baseline"] <- area_b$harv_area[area_b$region == "South"]
Energy_emis_S$cropland[Energy_emis_S$Scenario == "Projected"] <-  area_p$harv_area[area_p$region == "South"]
Energy_emis_S$cropland[Energy_emis_S$Scenario == "High"] <-  area_h_alt$harv_area[area_h_alt$region == "South"]
Energy_emis_S$lwr <- Energy_emis_S$lwr * Energy_emis_S$cropland
Energy_emis_S$upr <- Energy_emis_S$upr * Energy_emis_S$cropland

Energy_emis_S$lwr[Energy_emis_S$`Energy Source` == "Manufacturing Fertilizers"] <- Energy_emis_S$lwr[Energy_emis_S$`Energy Source` == "Manufacturing Fertilizers"]  * fert_ef * kg_to_Gg
Energy_emis_S$lwr[Energy_emis_S$`Energy Source` == "Manufacturing Pesticides"] <- Energy_emis_S$lwr[Energy_emis_S$`Energy Source` == "Manufacturing Pesticides"] * pest_ef * tons_to_Gg 
Energy_emis_S$upr[Energy_emis_S$`Energy Source` == "Manufacturing Fertilizers"] <- Energy_emis_S$upr[Energy_emis_S$`Energy Source` == "Manufacturing Fertilizers"]  * fert_ef * kg_to_Gg 
Energy_emis_S$upr[Energy_emis_S$`Energy Source` == "Manufacturing Pesticides"] <- Energy_emis_S$upr[Energy_emis_S$`Energy Source` == "Manufacturing Pesticides"] * pest_ef * tons_to_Gg 

#Convert all lower and upper estimates to Gigatons to match the units of the fitted values
Energy_emis_S$lwr <- Energy_emis_S$lwr * Gg_to_Gt
Energy_emis_S$upr <- Energy_emis_S$upr * Gg_to_Gt

#west Africa
colnames(lwr_W) <- c("Energy Source", "Scenario", "lwr")
colnames(upr_W) <- c("Energy Source", "Scenario", "upr")
lwr_W$`Energy Source` <- trimws(lwr_W$`Energy Source`)
upr_W$`Energy Source` <- trimws(upr_W$`Energy Source`)
lwr_W$Scenario <- str_replace(lwr_W$Scenario , "High_alt", "High")
upr_W$Scenario <- str_replace(upr_W$Scenario , "High_alt", "High")
Energy_emis_W <- right_join(Energy_emis_W, lwr_W, by = c("Energy Source", "Scenario"))
Energy_emis_W <- right_join(Energy_emis_W, upr_W, by = c("Energy Source", "Scenario"))

#Add in lower and upper 95% CI estimates and multiply by cropland to get gigagrams or tons (manufacturing energy sources)
Energy_emis_W$cropland[Energy_emis_W$Scenario == "Baseline"] <- area_b$harv_area[area_b$region == "West"]
Energy_emis_W$cropland[Energy_emis_W$Scenario == "Projected"] <-  area_p$harv_area[area_p$region == "West"]
Energy_emis_W$cropland[Energy_emis_W$Scenario == "High"] <-  area_h_alt$harv_area[area_h_alt$region == "West"]
Energy_emis_W$lwr <- Energy_emis_W$lwr * Energy_emis_W$cropland 
Energy_emis_W$upr <- Energy_emis_W$upr * Energy_emis_W$cropland

#Convert manufacturing fert and pest to Gg 
Energy_emis_W$lwr[Energy_emis_W$`Energy Source` == "Manufacturing Fertilizers"] <- Energy_emis_W$lwr[Energy_emis_W$`Energy Source` == "Manufacturing Fertilizers"] * fert_ef * kg_to_Gg 
Energy_emis_W$lwr[Energy_emis_W$`Energy Source` == "Manufacturing Pesticides"] <- Energy_emis_W$lwr[Energy_emis_W$`Energy Source` == "Manufacturing Pesticides"] * pest_ef * tons_to_Gg
Energy_emis_W$upr[Energy_emis_W$`Energy Source` == "Manufacturing Fertilizers"] <- Energy_emis_W$upr[Energy_emis_W$`Energy Source` == "Manufacturing Fertilizers"] * fert_ef * kg_to_Gg
Energy_emis_W$upr[Energy_emis_W$`Energy Source` == "Manufacturing Pesticides"] <- Energy_emis_W$upr[Energy_emis_W$`Energy Source` == "Manufacturing Pesticides"] * pest_ef * tons_to_Gg 

#Convert all lower and upper estimates to Gigatons to match the units of the fitted values
Energy_emis_W$lwr <- Energy_emis_W$lwr * Gg_to_Gt
Energy_emis_W$upr <- Energy_emis_W$upr * Gg_to_Gt

#east Africa
colnames(lwr_E) <- c("Energy Source", "Scenario", "lwr")
colnames(upr_E) <- c("Energy Source", "Scenario", "upr")
lwr_E$`Energy Source` <- trimws(upr_E$`Energy Source`)
upr_E$`Energy Source` <- trimws(lwr_E$`Energy Source`)
lwr_E$Scenario <- str_replace(lwr_E$Scenario , "High_alt", "High")
upr_E$Scenario <- str_replace(upr_E$Scenario , "High_alt", "High")
Energy_emis_E <- right_join(Energy_emis_E, lwr_E, by = c("Energy Source", "Scenario"))
Energy_emis_E <- right_join(Energy_emis_E, upr_E, by = c("Energy Source", "Scenario"))

#Multiply lower and upper 95% by cropland 
Energy_emis_E$cropland[Energy_emis_E$Scenario == "Baseline"] <- area_b$harv_area[area_b$region == "East"]
Energy_emis_E$cropland[Energy_emis_E$Scenario == "Projected"] <-  area_p$harv_area[area_p$region == "East"]
Energy_emis_E$cropland[Energy_emis_E$Scenario == "High"] <-  area_h_alt$harv_area[area_h_alt$region == "East"]

#Converts upper and lower estimates are in Gigagrams or tons (manufacturing pesticides/fertilizers is in tons)
Energy_emis_E$lwr <- Energy_emis_E$lwr * Energy_emis_E$cropland  
Energy_emis_E$upr <- Energy_emis_E$upr * Energy_emis_E$cropland 

#convert upper and lower estimates to gigagrams for manufacturing emissions
Energy_emis_E$lwr[Energy_emis_E$`Energy Source` == "Manufacturing Fertilizers"] <- Energy_emis_E$lwr[Energy_emis_E$`Energy Source` == "Manufacturing Fertilizers"] * fert_ef * kg_to_Gg
Energy_emis_E$lwr[Energy_emis_E$`Energy Source` == "Manufacturing Pesticides"] <- Energy_emis_E$lwr[Energy_emis_E$`Energy Source` == "Manufacturing Pesticides"] * pest_ef * tons_to_Gg #Did not multiply by pest_ef 
Energy_emis_E$upr[Energy_emis_E$`Energy Source` == "Manufacturing Fertilizers"] <- Energy_emis_E$upr[Energy_emis_E$`Energy Source` == "Manufacturing Fertilizers"] * fert_ef * kg_to_Gg
Energy_emis_E$upr[Energy_emis_E$`Energy Source` == "Manufacturing Pesticides"] <- Energy_emis_E$upr[Energy_emis_E$`Energy Source` == "Manufacturing Pesticides"] * pest_ef *  tons_to_Gg

#Convert all lower and upper estimates to Gigatons to match the units of the fitted values
Energy_emis_E$lwr <- Energy_emis_E$lwr * Gg_to_Gt
Energy_emis_E$upr <- Energy_emis_E$upr * Gg_to_Gt

#Central Africa
colnames(lwr_C) <- c("Energy Source", "Scenario", "lwr")
colnames(upr_C) <- c("Energy Source", "Scenario", "upr")
lwr_C$`Energy Source` <- trimws(lwr_C$`Energy Source`)
upr_C$`Energy Source` <- trimws(lwr_C$`Energy Source`)
lwr_C$Scenario <- str_replace(lwr_C$Scenario , "High_alt", "High")
upr_C$Scenario <- str_replace(upr_C$Scenario , "High_alt", "High")
Energy_emis_C <- right_join(Energy_emis_C, lwr_C, by = c("Energy Source", "Scenario"))
Energy_emis_C <- right_join(Energy_emis_C, upr_C, by = c("Energy Source", "Scenario"))

Energy_emis_C$cropland[Energy_emis_C$Scenario == "Baseline"] <- area_b$harv_area[area_b$region == "Central"]
Energy_emis_C$cropland[Energy_emis_C$Scenario == "Projected"] <-  area_p$harv_area[area_p$region == "Central"]
Energy_emis_C$cropland[Energy_emis_C$Scenario == "High"] <-  area_h_alt$harv_area[area_h_alt$region == "Central"]
#Converts upper and lower estimates are in Gigagrams or tons (manufacturing pesticides/fertilizers is in tons)
Energy_emis_C$lwr <- Energy_emis_C$lwr * Energy_emis_C$cropland  
Energy_emis_C$upr <- Energy_emis_C$upr * Energy_emis_C$cropland 

#convert upper and lower estimates to gigagrams for manufacturing emissions
Energy_emis_C$lwr[Energy_emis_C$`Energy Source` == "Manufacturing Fertilizers"] <- Energy_emis_C$lwr[Energy_emis_C$`Energy Source` == "Manufacturing Fertilizers"] * fert_ef * kg_to_Gg 
Energy_emis_C$lwr[Energy_emis_C$`Energy Source` == "Manufacturing Pesticides"] <- Energy_emis_C$lwr[Energy_emis_C$`Energy Source` == "Manufacturing Pesticides"] * pest_ef * tons_to_Gg #Did not multiply by pest_ef 
Energy_emis_C$upr[Energy_emis_C$`Energy Source` == "Manufacturing Fertilizers"] <- Energy_emis_C$upr[Energy_emis_C$`Energy Source` == "Manufacturing Fertilizers"] * fert_ef * kg_to_Gg
Energy_emis_C$upr[Energy_emis_C$`Energy Source` == "Manufacturing Pesticides"] <- Energy_emis_C$upr[Energy_emis_C$`Energy Source` == "Manufacturing Pesticides"] * pest_ef *  tons_to_Gg

#Convert all lower and upper estimates to Gigatons to match the units of the fitted values
Energy_emis_C$lwr <- Energy_emis_C$lwr * Gg_to_Gt
Energy_emis_C$upr <- Energy_emis_C$upr * Gg_to_Gt

#Calculate lwr and upr error bounds for Africa
# Energy_emis_E$Scenario <- as.matrix(unlist(Energy_emis_E$Scenario))
# Energy_emis_E$Scenario[is.na(Energy_emis_E$Scenario)] <- "High"
Energy_emis_Afr$MoE <- (Energy_emis_C$Value - Energy_emis_C$lwr)^2 + (Energy_emis_N$Value - Energy_emis_N$lwr)^2 +  (Energy_emis_S$Value - Energy_emis_S$lwr)^2 +  (Energy_emis_W$Value - Energy_emis_W$lwr)^2
                                                                                                                        
Energy_emis_Afr$sqrt_MoE <- sqrt(Energy_emis_Afr$MoE)
Energy_emis_Afr$upr <- Energy_emis_Afr$Value + Energy_emis_Afr$sqrt_MoE
Energy_emis_Afr$lwr <- Energy_emis_Afr$Value - Energy_emis_Afr$sqrt_MoE

#rename inputs

#syn n application
Energy_emis_E$`Energy Source` <- str_replace(Energy_emis_E$`Energy Source` , "Synthetic N", "Synthetic N Application")
Energy_emis_W$`Energy Source` <- str_replace(Energy_emis_W$`Energy Source` , "Synthetic N", "Synthetic N Application")
Energy_emis_S$`Energy Source` <- str_replace(Energy_emis_S$`Energy Source` , "Synthetic N", "Synthetic N Application")
Energy_emis_N$`Energy Source` <- str_replace(Energy_emis_N$`Energy Source` , "Synthetic N", "Synthetic N Application")
Energy_emis_C$`Energy Source` <- str_replace(Energy_emis_C$`Energy Source` , "Synthetic N", "Synthetic N Application")
Energy_emis_Afr$`Energy Source` <- str_replace(Energy_emis_Afr$`Energy Source` , "Synthetic N", "Synthetic N Application")

#fert manufacturing
Energy_emis_E$`Energy Source` <- str_replace(Energy_emis_E$`Energy Source` , "Manufacturing Fertilizers", "Manufacturing Synthetic N Fertilizer")
Energy_emis_W$`Energy Source` <- str_replace(Energy_emis_W$`Energy Source` , "Manufacturing Fertilizers", "Manufacturing Synthetic N Fertilizer")
Energy_emis_S$`Energy Source` <- str_replace(Energy_emis_S$`Energy Source` , "Manufacturing Fertilizers", "Manufacturing Synthetic N Fertilizer")
Energy_emis_N$`Energy Source` <- str_replace(Energy_emis_N$`Energy Source` , "Manufacturing Fertilizers", "Manufacturing Synthetic N Fertilizer")
Energy_emis_C$`Energy Source` <- str_replace(Energy_emis_C$`Energy Source` , "Manufacturing Fertilizers", "Manufacturing Synthetic N Fertilizer")
Energy_emis_Afr$`Energy Source` <- str_replace(Energy_emis_Afr$`Energy Source` , "Manufacturing Fertilizers", "Manufacturing Synthetic N Fertilizer")

#machinery
Energy_emis_E$`Energy Source` <- str_replace(Energy_emis_E$`Energy Source` , "Embodied Energy in Machinery", "Manufacturing Machinery")
Energy_emis_W$`Energy Source` <- str_replace(Energy_emis_W$`Energy Source` , "Embodied Energy in Machinery", "Manufacturing Machinery")
Energy_emis_S$`Energy Source` <- str_replace(Energy_emis_S$`Energy Source` , "Embodied Energy in Machinery", "Manufacturing Machinery")
Energy_emis_N$`Energy Source` <- str_replace(Energy_emis_N$`Energy Source` , "Embodied Energy in Machinery", "Manufacturing Machinery")
Energy_emis_C$`Energy Source` <- str_replace(Energy_emis_C$`Energy Source` , "Embodied Energy in Machinery", "Manufacturing Machinery")
Energy_emis_Afr$`Energy Source` <- str_replace(Energy_emis_Afr$`Energy Source` , "Embodied Energy in Machinery", "Manufacturing Machinery")

#change y-axis to megatons and upper and lower error bars
Gt_Mt <- 1000
Energy_emis_E$Value <- Energy_emis_E$Value * Gt_Mt
Energy_emis_W$Value <- Energy_emis_W$Value * Gt_Mt
Energy_emis_S$Value <- Energy_emis_S$Value * Gt_Mt
Energy_emis_C$Value <- Energy_emis_C$Value * Gt_Mt
Energy_emis_N$Value <- Energy_emis_N$Value * Gt_Mt
Energy_emis_Afr$Value <- Energy_emis_Afr$Value * Gt_Mt

#lwr
Energy_emis_E$lwr <- Energy_emis_E$lwr * Gt_Mt
Energy_emis_W$lwr <- Energy_emis_W$lwr * Gt_Mt
Energy_emis_S$lwr <- Energy_emis_S$lwr * Gt_Mt
Energy_emis_C$lwr <- Energy_emis_C$lwr * Gt_Mt
Energy_emis_N$lwr <- Energy_emis_N$lwr * Gt_Mt
Energy_emis_Afr$lwr <- Energy_emis_Afr$lwr * Gt_Mt

#upr
Energy_emis_E$upr <- Energy_emis_E$upr * Gt_Mt
Energy_emis_W$upr <- Energy_emis_W$upr * Gt_Mt
Energy_emis_S$upr <- Energy_emis_S$upr * Gt_Mt
Energy_emis_C$upr <- Energy_emis_C$upr * Gt_Mt
Energy_emis_N$upr <- Energy_emis_N$upr * Gt_Mt
Energy_emis_Afr$upr <- Energy_emis_Afr$upr * Gt_Mt

#Energy graphs by region
#Energy_E_high <- Energy_emis_E[Energy_emis_E$Scenario == "High_alt",] #Use High_alt as High
#Energy_emis_E<- anti_join(Energy_emis_E, Energy_E_high)
Energy_emis_E$Scenario <- factor(Energy_emis_E$Scenario ,levels = c("Baseline", "Projected", "High"))

Energy_E <- ggplot(Energy_emis_E, aes(fill = `Energy Source` , y = Value, x = Scenario)) + 
    geom_bar(position="dodge", stat="identity" ) + ggtitle(expression(paste("East"))) + xlab("Scenario") + ylab("GHG Emissions (Gt CO2 eq)") + labs(fill = "Inputs") + geom_errorbar(aes(ymin = lwr, ymax= upr), width=.2,
                 position=position_dodge(.9))  +  scale_x_discrete(labels= x.axis) +   scale_y_continuous(expand = expand_scale(mult = c(0.0, 0.1))) + theme_bti()
Energy_E <- Energy_E  +  scale_fill_manual(values=bti_colors)
ggsave(filename = "~/Google Drive/My Drive/Food & Farming/Energy in ag/results/Graphs/New Graphs/Energy_E.png", plot = Energy_E)  

#West Africa
Energy_emis_W$Scenario <- factor(Energy_emis_W$Scenario ,levels = c("Baseline", "Projected", "High"))

Energy_W <- ggplot(Energy_emis_W, aes(fill = `Energy Source` , y = Value, x = Scenario)) + 
    geom_bar(position="dodge", stat="identity" ) + ggtitle(expression(paste("West"))) + xlab("Scenario") + ylab("GHG Emissions (Gt CO2eq)") + labs(fill = "Inputs") + geom_errorbar(aes(ymin= lwr , ymax= upr), width=0.2,
                 position=position_dodge(.9))  +  scale_x_discrete(labels= x.axis) +   scale_y_continuous(expand = expand_scale(mult = c(0.0, 0.1)))  + theme_bti()
Energy_W <- Energy_W  +  scale_fill_manual(values=bti_colors)
ggsave(filename ="~/Google Drive/My Drive/Food & Farming/Energy in ag/results/Graphs/New Graphs/Energy_W.png", plot = Energy_W)  

#Central Africa
Energy_emis_C$Scenario <- factor(Energy_emis_C$Scenario ,levels = c("Baseline", "Projected", "High"))

Energy_C <- ggplot(Energy_emis_C, aes(fill = `Energy Source` , y = Value, x = Scenario)) + 
    geom_bar(position="dodge", stat="identity" ) + ggtitle(expression(paste("Central"))) + xlab("Scenario") + ylab("GHG Emissions (Gt CO2eq)") + labs(fill = "Inputs") + geom_errorbar(aes(ymin= lwr , ymax= upr), width=.2,
                 position=position_dodge(.9))  +  scale_x_discrete(labels= x.axis) +   scale_y_continuous(expand = expand_scale(mult = c(0.0, 0.1))) + theme_bti()
Energy_C <- Energy_C  +  scale_fill_manual(values=bti_colors)
ggsave(filename = "~/Google Drive/My Drive/Food & Farming/Energy in ag/results/Graphs/New Graphs/Energy_C.png", plot = Energy_C )  

#Southern Africa
Energy_emis_S$Scenario <- factor(Energy_emis_S$Scenario ,levels = c("Baseline", "Projected", "High"))

Energy_S <- ggplot(Energy_emis_S, aes(fill = `Energy Source` , y = Value, x = Scenario)) + 
    geom_bar(position="dodge", stat="identity" ) + ggtitle(expression(paste("Southern"))) + xlab("Scenario") + ylab("GHG Emissions (Gt CO2eq)") + labs(fill = "Inputs") + geom_errorbar(aes(ymin= lwr , ymax= upr), width=.2,
                 position=position_dodge(.9))  +  scale_x_discrete(labels= x.axis) +   scale_y_continuous(expand = expand_scale(mult = c(0.0, 0.1))) + theme_bti()
Energy_S <- Energy_S  +  scale_fill_manual(values= bti_colors)
ggsave(filename = "~/Google Drive/My Drive/Food & Farming/Energy in ag/results/Graphs/New Graphs/Energy_S.png", plot = Energy_S, width = , height = )  


#North Africa
Energy_emis_N$Scenario <- factor(Energy_emis_N$Scenario ,levels = c("Baseline", "Projected", "High"))

Energy_N <- ggplot(Energy_emis_N, aes(fill = `Energy Source` , y = Value, x = Scenario))  +  geom_bar(position="dodge", stat="identity" ) + ggtitle(expression(paste("North")))  + xlab("Scenario") + ylab("GHG Emissions (Gt CO2eq)") + labs(fill = "Inputs") + geom_errorbar(aes(ymin= lwr , ymax= upr), width=.2,
                 position=position_dodge(.9))  +  scale_x_discrete(labels= x.axis) +  scale_y_continuous(expand = expand_scale(mult = c(0.0, 0.1))) + theme_bti()
Energy_N <- Energy_N  +  scale_fill_manual(values= bti_colors)
ggsave(filename = "~/Google Drive/My Drive/Food & Farming/Energy in ag/results/Graphs/New Graphs/Energy_N.png", plot = Energy_N)  

#Africa
Energy_emis_Afr$Scenario <- factor(Energy_emis_Afr$Scenario ,levels = c("Baseline", "Projected", "High"))

Energy_Afr <- ggplot(Energy_emis_Afr, aes(fill = `Energy Source` , y = Value, x = Scenario))  +  geom_bar(position="dodge", stat="identity" ) + ggtitle(expression(paste("Africa")))  + xlab("Scenario") + ylab("GHG Emissions (Gt CO2eq)") + labs(fill = "Inputs") + geom_errorbar(aes(ymin= lwr , ymax= upr), width=.2,
                 position=position_dodge(.9))  +  scale_x_discrete(labels= x.axis) + scale_y_continuous(expand = expand_scale(mult = c(0.0, 0.1))) + theme_bti()
Energy_Afr <- Energy_Afr  +  scale_fill_manual(values= bti_colors)
ggsave(filename = "~/Google Drive/My Drive/Food & Farming/Energy in ag/results/Graphs/New Graphs/Energy_N.png", plot = Energy_Afr) 


#total Energy graphs with all regions included except SSA (no error bars)
Energy_emis_all <- Energy_emis %>% group_by(Scenario, Region) %>% summarize(sum(Value)) 
Energy_emis_Afr_all <- Energy_emis_all[Energy_emis_all$Region == "Africa",]
Energy_emis_all <- anti_join(Energy_emis_all,Energy_emis_Afr_all )
Energy_emis_all$Scenario <- factor(Energy_emis_all$Scenario ,levels = c("Baseline", "Projected", "High"))

Energy_emis_all_reg <- ggplot(Energy_emis_all, aes(fill = Region , y = `sum(Value)`, x = Scenario)) + 
    geom_bar(position="dodge", stat="identity" ) + ggtitle(expression(paste("Energy Input Use Emissions by Region"))) + xlab("Scenario") + ylab("GHG Emissions (Gt CO2eq)") + labs(fill = "Region") + theme_bti()
Energy_emis_all_reg <- Energy_emis_all_reg +  scale_fill_manual(values= bti_colors)
ggsave(filename = "~/Google Drive File Stream/My Drive/Food & Farming/Energy in ag/results/Graphs/New Graphs/Energy_all_reg.png", plot = Energy_emis_all_reg, width = , height = )

#Create a figure that has all of the energy source by region grafs displayed
Energy_N <- Energy_N + ggtitle("") + ylab("") + xlab("") +  theme_bti() 
Energy_S <- Energy_S + ggtitle("") + ylab("") + xlab("") + theme_bti() 
Energy_W <- Energy_W + ggtitle("") + ylab("") + xlab("") +  theme_bti() 
Energy_E <- Energy_E + ggtitle("") + ylab("") + xlab("") + theme_bti()  
Energy_C <- Energy_C + ggtitle("") + ylab("") + xlab("") +  theme_bti() 
Energy_Afr <-  Energy_Afr + ggtitle("") + ylab("") + xlab("") + theme_bti()  

library(ggpubr)
energy_region_grafs <- ggarrange(Energy_N, Energy_S, Energy_W, Energy_E, Energy_C, Energy_Afr, labels = c("North", "Southern","West","East", "Central", "Africa"),font.label = list(size = 12, face = "plain", color = "black", family = NULL), common.legend = TRUE, legend = "bottom")


# Annotate the figure by adding a common labels
energy_region_grafs <- annotate_figure(energy_region_grafs,
                top = text_grob("Emissions from Input Use by Region", color = "black" , size = 12),
                left = text_grob("GHG Emissions (Mt CO2eq)", color = "black", rot = 90))
                
                #fig.lab = "Figure 1", fig.lab.face = "bold")
ggsave(filename = "~/Google Drive/My Drive/Food & Farming/Energy in ag/results/Graphs/New Graphs/panel_energy_reg_grafs.png", plot = energy_region_grafs, width = , height = )


#Total Energy emissions error bars, and with LUC emis for each region 

#add in lwr and upr bounds for Energy emissions
Energy_emis_E$MoE <- Energy_emis_E$Value - Energy_emis_E$lwr
Energy_emis_C$MoE <- Energy_emis_C$Value - Energy_emis_C$lwr
Energy_emis_S$MoE <- Energy_emis_S$Value - Energy_emis_S$lwr
Energy_emis_N$MoE <- Energy_emis_N$Value - Energy_emis_N$lwr
Energy_emis_W$MoE <- Energy_emis_W$Value - Energy_emis_W$lwr

Energy_emis_E$MoE2 <- Energy_emis_E$MoE^2
Energy_emis_C$MoE2 <- Energy_emis_C$MoE^2
Energy_emis_W$MoE2 <- Energy_emis_W$MoE^2
Energy_emis_N$MoE2 <- Energy_emis_N$MoE^2
Energy_emis_W$MoE2 <- Energy_emis_W$MoE^2

# En <- as.data.frame(matrix(0, ncol = ncol(tot_E) + 1, nrow = nrow(tot_E)))
# En[1,] <- tot_E %>% filter(Region == "East", Scenario == "Baseline") %>% mutate( SS = with(Energy_emis_E,sum(MoE2[Scenario == "Baseline"])))
# En[2,] <- tot_E %>% filter(Region == "East", Scenario == "Projected") %>% mutate( SS = with(Energy_emis_E,sum(MoE2[Scenario == "Projected"])))
# En[3,] <- tot_E %>% filter(Region == "East", Scenario == "High") %>% mutate( SS = with(Energy_emis_E,sum(MoE2[Scenario == "High"])))
# En[4,] <- tot_E %>% filter(Region == "West", Scenario == "Baseline") %>% mutate( SS = with(Energy_emis_E,sum(MoE2[Scenario == "Baseline"])))
# En[5,] <- tot_E %>% filter(Region == "West", Scenario == "Projected") %>% mutate( SS = with(Energy_emis_E,sum(MoE2[Scenario == "Projected"])))
# En[6,] <- tot_E %>% filter(Region == "West", Scenario == "High") %>% mutate( SS = with(Energy_emis_E,sum(MoE2[Scenario == "High"])))
# En[7,] <- tot_E %>% filter(Region == "Southern", Scenario == "Baseline") %>% mutate( SS = with(Energy_emis_E,sum(MoE2[Scenario == "Baseline"])))
# En[8,] <- tot_E %>% filter(Region == "Southern", Scenario == "Projected") %>% mutate( SS = with(Energy_emis_E,sum(MoE2[Scenario == "Projected"])))
# En[9,] <- tot_E %>% filter(Region == "Southern", Scenario == "High") %>% mutate( SS = with(Energy_emis_E,sum(MoE2[Scenario == "High"])))
# En[10,] <- tot_E %>% filter(Region == "Central", Scenario == "Baseline") %>% mutate( SS = with(Energy_emis_E,sum(MoE2[Scenario == "Baseline"])))
# En[11,] <- tot_E %>% filter(Region == "Central", Scenario == "Projected") %>% mutate( SS = with(Energy_emis_E,sum(MoE2[Scenario == "Projected"])))
# En[12,] <- tot_E %>% filter(Region == "Central", Scenario == "High") %>% mutate( SS = with(Energy_emis_E,sum(MoE2[Scenario == "High"])))
# En[13,] <- tot_E %>% filter(Region == "North", Scenario == "Baseline") %>% mutate( SS = with(Energy_emis_E,sum(MoE2[Scenario == "Baseline"])))
# En[14,] <- tot_E %>% filter(Region == "North", Scenario == "Projected") %>% mutate( SS = with(Energy_emis_E,sum(MoE2[Scenario == "Projected"])))
# En[15,] <- tot_E %>% filter(Region == "North", Scenario == "High") %>% mutate( SS = with(Energy_emis_E,sum(MoE2[Scenario == "High"])))
# En[16,] <- tot_E %>% filter(Region == "Africa", Scenario == "Baseline") %>% mutate( SS = with(Energy_emis_E,sum(MoE2[Scenario == "Baseline"])))
# En[17,] <- tot_E %>% filter(Region == "Africa", Scenario == "Projected") %>% mutate( SS = with(Energy_emis_E,sum(MoE2[Scenario == "Projected"])))
# En[18,] <- tot_E %>% filter(Region == "Africa", Scenario == "High") %>% mutate( SS = with(Energy_emis_E,sum(MoE2[Scenario == "High"])))                          
# colnames(En) <- c("Scenario", "Region", "Energy", "SummedSqs")
# En$SS_sqrt <- sqrt(En$SummedSqs)
# En$upr <- En$Energy + En$SS_sqrt
# En$lwr <- En$Energy - En$SS_sqrt
# En$Energy <- En$Energy * Gg_to_Gt * Gt_Mt
# En$upr <- En$upr  * Gg_to_Gt * Gt_Mt
# En$lwr <- En$lwr  * Gg_to_Gt * Gt_Mt
# En$Scenario <- ifelse(En$Scenario == 1, "Baseline", ifelse(En$Scenario == 3, "Projected", ifelse(En$Scenario == 2, "High", NA)))
#
#convert to megatons
tot_E$Energy <- tot_E$Energy * Gg_to_Gt * Gt_Mt
#new lwr and upr bounds for tot_e
En2 <- as.data.frame(matrix(0, ncol = ncol(tot_E) + 1, nrow = nrow(tot_E)))
En2[1,] <-  tot_E %>% filter(Region == "East", Scenario == "Baseline") %>% mutate(lwr_new = with(Energy_emis_E,sum(lwr[Scenario == "Baseline"])))
En2[2,] <- tot_E %>% filter(Region == "East", Scenario == "Projected") %>% mutate( lwr_new = with(Energy_emis_E,sum(lwr[Scenario == "Projected"])))
En2[3,] <- tot_E %>% filter(Region == "East", Scenario == "High") %>% mutate(lwr_new = with(Energy_emis_E,sum(lwr[Scenario == "High"])))
En2[4,] <- tot_E %>% filter(Region == "West", Scenario == "Baseline") %>% mutate(lwr_new = with(Energy_emis_W,sum(lwr[Scenario == "Baseline"])))
En2[5,] <- tot_E %>% filter(Region == "West", Scenario == "Projected") %>% mutate(lwr_new = with(Energy_emis_W,sum(lwr[Scenario == "Projected"])))
En2[6,] <- tot_E %>% filter(Region == "West", Scenario == "High") %>% mutate(lwr_new = with(Energy_emis_W,sum(lwr[Scenario == "High"])))
En2[7,] <- tot_E %>% filter(Region == "Southern", Scenario == "Baseline") %>% mutate(lwr_new = with(Energy_emis_S,sum(lwr[Scenario == "Baseline"])))
En2[8,] <- tot_E %>% filter(Region == "Southern", Scenario == "Projected") %>% mutate(lwr_new = with(Energy_emis_S,sum(lwr[Scenario == "Projected"])))
En2[9,] <- tot_E %>% filter(Region == "Southern", Scenario == "High") %>% mutate(lwr_new = with(Energy_emis_S,sum(lwr[Scenario == "High"])))
En2[10,] <- tot_E %>% filter(Region == "Central", Scenario == "Baseline") %>% mutate(lwr_new = with(Energy_emis_C,sum(lwr[Scenario == "Baseline"])))
En2[11,] <- tot_E %>% filter(Region == "Central", Scenario == "Projected") %>% mutate(lwr_new = with(Energy_emis_C,sum(lwr[Scenario == "Projected"])))
En2[12,] <- tot_E %>% filter(Region == "Central", Scenario == "High") %>% mutate(lwr_new = with(Energy_emis_C,sum(lwr[Scenario == "High"])))
En2[13,] <- tot_E %>% filter(Region == "North", Scenario == "Baseline") %>% mutate(lwr_new = with(Energy_emis_N,sum(lwr[Scenario == "Baseline"])))
En2[14,] <- tot_E %>% filter(Region == "North", Scenario == "Projected") %>% mutate(lwr_new = with(Energy_emis_N,sum(lwr[Scenario == "Projected"])))
En2[15,] <- tot_E %>% filter(Region == "North", Scenario == "High") %>% mutate( lwr_new = with(Energy_emis_N,sum(lwr[Scenario == "High"])))
En2[16,] <- tot_E %>% filter(Region == "Africa", Scenario == "Baseline") %>% mutate(lwr_new = with(Energy_emis_Afr,sum(lwr[Scenario == "Baseline"])))
En2[17,] <- tot_E %>% filter(Region == "Africa", Scenario == "Projected") %>% mutate(lwr_new = with(Energy_emis_Afr,sum(lwr[Scenario == "Projected"])))
En2[18,] <- tot_E %>% filter(Region == "Africa", Scenario == "High") %>% mutate(lwr_new = with(Energy_emis_Afr,sum(lwr[Scenario == "High"])))
colnames(En2) <- c("Scenario", "Region", "value", "upr", "lwr","variable" , "lwr_new")
En2$Scenario <- ifelse(En2$Scenario == 1, "Baseline", ifelse(En2$Scenario == 3, "Projected", ifelse(En2$Scenario == 2, "High", NA)))

 #merge lwr and upr bounds with tot_E data

 tot_E <- merge(tot_E, En)
 tot_E$SummedSqs <- NULL
#tot_E$SS_sqrt <- NULL
tot_E$variable <- "Energy"
 colnames(tot_E) <- c("Scenario" , "Region"  ,"value" ,  "upr" , "lwr" ,  "variable")
 LUC_Afr_regions$variable <- "LUC"
 colnames(LUC_Afr_regions) <- c("Region" , "Scenario"  ,"value", "variable")
 LUC_Afr_regions$value <- (LUC_Afr_regions$value * kg_to_Gg *Gg_to_Gt)/380
 GHG <- full_join(tot_E, LUC_Afr_regions)
 GHG[GHG$upr == 0] <- NA
#
 
tot_E$Scenario <- as.character(unlist(tot_E$Scenario))
upr_new <- as.data.frame(matrix(0, nrow = nrow(tot_E), ncol = ncol(tot_E) + 1))
upr_new[1,] <- tot_E %>% filter(Region == "East", Scenario == "Baseline") %>% mutate(upr_new = with(Energy_emis_E,sum(upr[Scenario == "Baseline"])))
upr_new[2,] <- tot_E %>% filter(Region == "East", Scenario == "Projected") %>% mutate( upr_new = with(Energy_emis_E,sum(upr[Scenario == "Projected"])))
upr_new[3,] <- tot_E %>% filter(Region == "East", Scenario == "High") %>% mutate(upr_new = with(Energy_emis_E,sum(upr[Scenario == "High"])))
upr_new[4,] <- tot_E %>% filter(Region == "West", Scenario == "Baseline") %>% mutate(upr_new = with(Energy_emis_W,sum(upr[Scenario == "Baseline"])))
upr_new[5,] <- tot_E %>% filter(Region == "West", Scenario == "Projected") %>% mutate(upr_new = with(Energy_emis_W,sum(upr[Scenario == "Projected"])))
upr_new[6,] <- tot_E %>% filter(Region == "West", Scenario == "High") %>% mutate(upr_new = with(Energy_emis_W,sum(upr[Scenario == "High"])))
upr_new[7,] <- tot_E %>% filter(Region == "Southern", Scenario == "Baseline") %>% mutate(upr_new = with(Energy_emis_S,sum(upr[Scenario == "Baseline"])))
upr_new[8,] <- tot_E %>% filter(Region == "Southern", Scenario == "Projected") %>% mutate(upr_new = with(Energy_emis_S,sum(upr[Scenario == "Projected"])))
upr_new[9,] <- tot_E %>% filter(Region == "Southern", Scenario == "High") %>% mutate(upr_new = with(Energy_emis_S,sum(upr[Scenario == "High"])))
upr_new[10,] <- tot_E %>% filter(Region == "Central", Scenario == "Baseline") %>% mutate(upr_new = with(Energy_emis_C,sum(upr[Scenario == "Baseline"])))
upr_new[11,] <- tot_E %>% filter(Region == "Central", Scenario == "Projected") %>% mutate(upr_new = with(Energy_emis_C,sum(upr[Scenario == "Projected"])))
upr_new[12,] <- tot_E %>% filter(Region == "Central", Scenario == "High") %>% mutate(upr_new = with(Energy_emis_C,sum(upr[Scenario == "High"])))
upr_new[13,] <- tot_E %>% filter(Region == "North", Scenario == "Baseline") %>% mutate(upr_new = with(Energy_emis_N,sum(upr[Scenario == "Baseline"])))
upr_new[14,] <- tot_E %>% filter(Region == "North", Scenario == "Projected") %>% mutate(upr_new = with(Energy_emis_N,sum(upr[Scenario == "Projected"])))
upr_new[15,] <- tot_E %>% filter(Region == "North", Scenario == "High") %>% mutate( upr_new = with(Energy_emis_N,sum(upr[Scenario == "High"])))
upr_new[16,] <- tot_E %>% filter(Region == "Africa", Scenario == "Baseline") %>% mutate(upr_new = with(Energy_emis_Afr,sum(upr[Scenario == "Baseline"])))
upr_new[17,] <- tot_E %>% filter(Region == "Africa", Scenario == "Projected") %>% mutate(upr_new = with(Energy_emis_Afr,sum(upr[Scenario == "Projected"])))
upr_new[18,] <- tot_E %>% filter(Region == "Africa", Scenario == "High") %>% mutate(upr_new = with(Energy_emis_Afr,sum(upr[Scenario == "High"])))
colnames(upr_new) <-  c("Scenario", "Region", "value", "upr", "lwr","variable" , "upr_new")
En2 <- merge(En2, upr_new)
tot_E <- merge(tot_E, En2)  
LUC_Afr_regions$value  <- LUC_Afr_regions$value * Gt_Mt
GHG <- full_join(tot_E, LUC_Afr_regions)


#Energy_LUC_GHG <- Energy_LUC[Energy_LUC$variable == "GHG",] #exclude total GHG emissions, units are gigatons
#Energy_LUC_GHG  <- anti_join(Energy_LUC , Energy_LUC_GHG )
Energy_LUC_E <- filter(GHG, Region == "East")
Energy_LUC_W <- filter(GHG, Region == "West")
Energy_LUC_C <- filter(GHG, Region == "Central")
Energy_LUC_S <- filter(GHG, Region == "Southern")
Energy_LUC_N <- filter(GHG, Region == "North")
Energy_LUC_Afr <- filter(GHG, Region == "Africa")
Energy_LUC_Afr$variable <- str_replace(Energy_LUC_Afr$variable, "Energy", "Inputs")
Energy_LUC_E$variable <- str_replace(Energy_LUC_E$variable, "Energy", "Inputs")
Energy_LUC_W$variable <- str_replace(Energy_LUC_W$variable, "Energy", "Inputs")
Energy_LUC_C$variable <- str_replace(Energy_LUC_C$variable, "Energy", "Inputs")
Energy_LUC_S$variable <- str_replace(Energy_LUC_S$variable, "Energy", "Inputs")
Energy_LUC_N$variable <- str_replace(Energy_LUC_N$variable, "Energy", "Inputs")

#Graph Energy + LUC graphs
#East
Energy_LUC_E$Scenario <- factor(Energy_LUC_E$Scenario,levels = c("Baseline", "Projected", "High"))
Energy_LUC_E_plot <- ggplot(Energy_LUC_E , aes(fill = variable , y = value , x= Scenario)) + 
    geom_bar(position="dodge", stat="identity") + xlab("") + ylab("") + labs(fill = "Emissions Type") + scale_x_discrete(labels= x.axis) + scale_y_continuous(expand = expand_scale(mult = c(0.0, 0.1))) +  geom_errorbar(aes(ymin= lwr_new , ymax= upr_new), width=.2, position=position_dodge(.9)) + theme_bti()
Energy_LUC_E_plot <- Energy_LUC_E_plot  +  scale_fill_manual(values= bti_colors) 
#West
Energy_LUC_W$Scenario <- factor(Energy_LUC_W$Scenario,levels = c("Baseline", "Projected", "High"))
Energy_LUC_W_plot <- ggplot(Energy_LUC_W , aes(fill = variable , y = value , x= Scenario)) + 
    geom_bar(position="dodge", stat="identity") + xlab("") + ylab("") + labs(fill = "Emissions Type") +  geom_errorbar(aes(ymin= Energy_LUC_W$lwr_new, ymax= Energy_LUC_W$upr_new), width=.2, position=position_dodge(.9))  + scale_x_discrete(labels= x.axis)  + scale_y_continuous(expand = expand_scale(mult = c(0.0, 0.1))) + theme_bti() 
Energy_LUC_W_plot <- Energy_LUC_W_plot  +  scale_fill_manual(values= bti_colors) 

Energy_LUC_S$Scenario <- factor(Energy_LUC_S$Scenario,levels = c("Baseline", "Projected", "High"))
Energy_LUC_S_plot <- ggplot(Energy_LUC_S , aes(fill = variable , y = value , x= Scenario)) + 
    geom_bar(position="dodge", stat="identity") + xlab("") + ylab("") + labs(fill = "Emissions Type") +  geom_errorbar(aes(ymin= lwr_new, ymax= upr_new), width= 0.2, position=position_dodge(0.9)) + scale_x_discrete(labels= x.axis) + scale_y_continuous(expand = expand_scale(mult = c(0.0, 0.1))) +  theme_bti() 
Energy_LUC_S_plot <- Energy_LUC_S_plot  +  scale_fill_manual(values= bti_colors) 

Energy_LUC_N$Scenario <- factor(Energy_LUC_N$Scenario,levels = c("Baseline", "Projected", "High"))
Energy_LUC_N_plot <- ggplot(Energy_LUC_N, aes(fill = variable , y = value , x= Scenario)) + 
    geom_bar(position="dodge", stat="identity") + xlab("") + ylab("") + labs(fill = "Emissions Type") + geom_errorbar(aes(ymin= Energy_LUC_N$lwr_new, ymax= Energy_LUC_N$upr_new), width =0.2, position = position_dodge(0.9))  + scale_x_discrete(labels= x.axis) + scale_y_continuous(expand = expand_scale(mult = c(0.0, 0.1))) +  theme_bti()  
Energy_LUC_N_plot <- Energy_LUC_N_plot  +  scale_fill_manual(values= bti_colors) 

Energy_LUC_C$Scenario <- factor(Energy_LUC_C$Scenario,levels = c("Baseline", "Projected", "High"))
Energy_LUC_C_plot <- ggplot(Energy_LUC_C , aes(fill = variable , y = value , x= Scenario)) + 
    geom_bar(position="dodge", stat="identity") + xlab("") + ylab("") + labs(fill = "Emissions Type") + geom_errorbar(aes(ymin= lwr_new, ymax= upr_new), width = 0.2, position = position_dodge(0.9))  + scale_x_discrete(labels= x.axis) + scale_y_continuous(expand = expand_scale(mult = c(0.0, 0.1))) +  theme_bti() 
Energy_LUC_C_plot <- Energy_LUC_C_plot  +  scale_fill_manual(values= bti_colors) 

#Africa
Energy_LUC_Afr$lwr_new <- Energy_LUC_Afr$lwr_new  * Gt_Mt
Energy_LUC_Afr$upr_new <- Energy_LUC_Afr$upr_new  * Gt_Mt
Energy_LUC_Afr$Scenario <- factor(Energy_LUC_Afr$Scenario,levels = c("Baseline", "Projected", "High"))
Energy_LUC_Afr_plot <- ggplot(Energy_LUC_Afr , aes(fill = variable , y = value , x= Scenario)) +
    geom_bar(position="dodge", stat="identity") + xlab("") + ylab("") + labs(fill = "Emissions Type") + geom_errorbar(aes(ymin= lwr_new, ymax= upr_new), width = 0.2, position = position_dodge(0.9))   + scale_x_discrete(labels= x.axis) +scale_y_continuous(expand = expand_scale(mult = c(0.0, 0.1))) +  theme_bti() 
Energy_LUC_Afr_plot <- Energy_LUC_Afr_plot  +  scale_fill_manual(values= bti_colors) 

energy_LUC_grafs2 <- ggarrange(Energy_LUC_N_plot, Energy_LUC_S_plot, Energy_LUC_W_plot, Energy_LUC_E_plot, Energy_LUC_C_plot,Energy_LUC_Afr_plot, labels = c("North", "Southern","West","East", "Central", "Africa"), hjust = 0,vjust = 0.4, font.label = list(size = 10, face = "plain", color = "black", family = NULL), common.legend = TRUE, legend = "bottom")


# Annotate the figure by adding a common labels
energy_LUC_grafs2 <- annotate_figure(energy_LUC_grafs2,
                top = text_grob("", color = "black" , size = 10),
                left = text_grob("GHG Emissions (Mt CO2eq)", color = "black", rot = 90))
                
                #fig.lab = "Figure 1", fig.lab.face = "bold")
ggsave(filename = "~/Google Drive/My Drive/Food & Farming/Energy in ag/results/Graphs/New Graphs/energy_LUC_grafs.png", plot = energy_LUC_grafs2, width = , height = )


write.csv(Energy_emis_C, "~/Google Drive File Stream/My Drive/Food & Farming/Energy in ag/results/Energy-Ag_tbls/Energy_emis_C.csv")
write.csv(Energy_emis_E, "~/Google Drive File Stream/My Drive/Food & Farming/Energy in ag/results/Energy-Ag_tbls/Energy_emis_E.csv")
write.csv(Energy_emis_S, "~/Google Drive File Stream/My Drive/Food & Farming/Energy in ag/results/Energy-Ag_tbls/Energy_emis_S.csv")
write.csv(Energy_emis_W, "~/Google Drive File Stream/My Drive/Food & Farming/Energy in ag/results/Energy-Ag_tbls/Energy_emis_W.csv")
write.csv(Energy_emis_N, "~/Google Drive File Stream/My Drive/Food & Farming/Energy in ag/results/Energy-Ag_tbls/Energy_emis_N.csv")
write.csv(Energy_emis_Afr, "~/Google Drive File Stream/My Drive/Food & Farming/Energy in ag/results/Energy-Ag_tbls/Energy_emis_Afr.csv")
```


```{r LUC emis graph, all emis sources graph }

#plot results  
LUC_emis <- GHG[, c(1:3)]
x.axis <- c("Baseline", "Projected", "High")

LUC_emis_Afr <- LUC_emis[LUC_emis$Region == "Africa",] #have separate charts for SSA data to compare to region breakdown
LUC_emis <- anti_join(LUC_emis, LUC_emis_Afr)
LUC_emis$Scenario <- str_replace(LUC_emis$Scenario, "High_alt","High")
LUC_emis$Scenario <- factor(LUC_emis$Scenario,levels = c("Baseline", "Projected", "High"))

LUC_regions <- ggplot(LUC_emis , aes(fill = Region , y = LUC , x = Scenario)) + 
    geom_bar(position="dodge", stat="identity" ) + ggtitle(expression(paste("LUC emissions by scenario and region"))) + xlab("Scenario") + ylab("LUC Emissions (Gt CO2 eq)") + labs(fill = "Region")  +  scale_x_discrete(labels= x.axis) + theme_bti()

LUC_regions  <- LUC_regions  +  scale_fill_manual(values= bti_colors)
ggsave(filename = "~/Google Drive File Stream/My Drive/Food & Farming/Energy in ag/results/LUC_regions_grouped", plot = LUC_regions , width = , height = )

#LUC stacked chart 
LUC_stacked <- ggplot(LUC_Afr_regions , aes(fill = Region , y = `LUC emissions(Gt)`, x = Scenario)) + 
    geom_bar(position="fill", stat="identity" ) + ggtitle(expression(paste("% LUC emissions by region for each scenario"))) + xlab("Scenario") + ylab("% LUC emissions") + labs(fill = "Region")  +  scale_x_discrete(labels= x.axis) + theme(axis.title.x = element_text(color="black",size=12),axis.title.y = element_text(color="black", size=12) ,panel.background = element_rect(fill = NA),
       panel.grid.major.y = element_line(colour="grey68",linetype="dotted"),
       panel.grid.major.x = element_line(colour="grey68",linetype="dotted"),axis.ticks.y = element_blank(),axis.ticks.x=element_blank(),
       plot.title = element_text(size=13, face="bold"))

LUC_stacked <- LUC_stacked +  scale_fill_manual(values=wes_palette(n=5, name="Darjeeling1"))
ggsave(filename = "~/Google Drive File Stream/My Drive/Food & Farming/Energy in ag/results/Graphs/New Graphs/LUC_stacked_reg", plot = LUC_stacked , width = , height = )


#LUC_SSA chart
LUC_SSA$Scenario <- factor(LUC_SSA$Scenario,levels = c("Baseline", "Projected", "High_alt"))
LUC_SSA <- as.data.frame(na.omit(LUC_Afr_regions))
LUC_SSA <- ggplot(LUC_Afr_regions , aes(y = LUC, x = Scenario)) + 
    geom_bar(position="dodge", stat="identity", fill = "#0DC3A8") + ggtitle(expression(paste("LUC emissions by scenario in Sub-Saharan Africa"))) + xlab("Scenario") + ylab("LUC Emissions (Gt CO2 eq)")  +  scale_x_discrete(labels= x.axis) + theme(axis.title.x = element_text(color="black",size=12),axis.title.y = element_text(color="black", size=12) ,panel.background = element_rect(fill = NA),
       panel.grid.major.y = element_line(colour="grey68",linetype="dotted"),
       panel.grid.major.x = element_line(colour="grey68",linetype="dotted"),axis.ticks.y = element_blank(),axis.ticks.x=element_blank(),
       plot.title = element_text(size=13, face="bold"))

ggsave(filename = "~/Desktop/Grafs_energyag/LUC_SSA.png", plot = LUC_SSA , width = , height = )





#Stacked bar chart

bp <- ggplot(all_emis_melted, aes(fill= variable, y= LUC, x=Scenario)) + 
    geom_bar(position="stack", stat="identity") + ggtitle(expression(paste("Emissions by Scenario"))) + xlab("Scenario") + ylab("GHG Emissions (CO2eq)") + labs(fill = "Categories") + theme(axis.title.x = element_text(color="black",size=12),axis.title.y = element_text(color="black", size=12) ,panel.background = element_rect(fill = NA),
       panel.grid.major.y = element_line(colour="grey68",linetype="dotted"),
       panel.grid.major.x = element_line(colour="grey68",linetype="dotted"), axis.ticks.y = element_blank(),axis.ticks.x=element_blank(),
       plot.title = element_text(size=13, face="bold"))

positions <- c("Baseline Yield", "Projected Yield", "High Yield")
bp + scale_x_discrete(limits = positions) 
bp

colnames(all_emis) <- c("LUC", "Total Energy + LUC emissions", "Synthetic N emissions", "On Farm Fuel Emissions", "Manufacturing Pesticides Emissions", "Manufacturing Nitrogen Emissions", "Manufacturing Nitrogen Emissions 2", "Energy Embodied in Machinery Emissions", "Total Energy Emissions", "Scenario")
rownames(all_emis) <- c("current", "projected", "high")
write_csv(all_emis, path = "~/Google Drive/Energy and GHG Analysis (2019)/energy_ag_analysis/Results/LUC_Energy_Emissions.csv")


```


```{r OLS Estimators table and Predictions Estimator table}
m.ols_coef <- rbind(m.ols$coefficients[1],m.ols$coefficients[2])
p.ols_coef <- rbind(p.ols$coefficients[1],p.ols$coefficients[2])
fert_use.coef  <- rbind(fert_use.ols$coefficients[1],fert_use.ols$coefficients[2])
syn_n.coef <- rbind(syn_n.ols$coefficients[1],syn_n.ols$coefficients[2])
fuel.coef <- rbind(fuel.ols$coefficients[1], fuel.ols$coefficients[2])
energy_coefs <- cbind(m.ols_coef, p.ols_coef, syn_n.coef, fert_use.coef, fuel.coef)
colnames(energy_coefs) <- c("machinery energy emissions", "manufacturing pesticides emissions", "synthetic N fertilizer emissions", "manufacturing fertilizers emissions", "on-farm fuel energy emissions")
energy_coefs[2,1] <- exp(energy_coefs[2,1])
energy_coefs[2,2] <- exp(energy_coefs[2,2])
energy_coefs[2,3] <- exp(energy_coefs[2,3])
energy_coefs[2,4] <- exp(energy_coefs[2,4])
energy_coefs[2,5] <- exp(energy_coefs[2,5])

rownames(energy_coefs) <- c("Intercept", "Yield")
energy_coefs <- as.data.frame(energy_coefs)
write_csv(energy_coefs, "~/Google Drive/Energy and GHG Analysis (2019)/energy_ag_analysis/Results/energy_coefs.csv")

write_csv(predict_tbl, path = "~/Google Drive/Energy and GHG Analysis (2019)/energy_ag_analysis/Results/predict_tbl.csv")

#Error Bars
fuel.ols <- as.data.frame(fuel.ols$coefficients)
write.csv(fuel.ols, "~/Desktop/Energy-Ag_tbls/Fuel_coeffs.csv")
p.coeffs <- as.data.frame(p.ols$coefficients)
p.coeffs$coeffs <- rownames(p.coeffs)
rownames(p.coeffs) <- NULL
write.csv(p.coeffs, "~/Desktop/Energy-Ag_tbls/p_coeffs.csv")
m.coeffs <- as.data.frame(m.ols$coefficients)
m.coeffs$coeffs <- rownames(m.coeffs)
rownames(p.coeffs) <- NULL
write.csv(m.coeffs, "~/Desktop/Energy-Ag_tbls/m_coeffs.csv")

fert_use.coeffs <- as.data.frame(fert_use.ols$coefficients)
fert_use.coeffs$coeffs <- rownames(fert_use.coeffs)
rownames(fert_use.coeffs) <- NULL
write.csv(fert_use.coeffs, "~/Desktop/Energy-Ag_tbls/fert_use_coeffs.csv")

syn_n.coeffs <- as.data.frame(syn_n.ols$coefficients)
syn_n.coeffs$coeffs <- rownames(syn_n.coeffs)
rownames(syn_n.coeffs) <- NULL
write.csv(syn_n.coeffs, "~/Desktop/Energy-Ag_tbls/syn_n_coeffs.csv")



```
```{r Additional Data Viz}

```

```{r Calculations comparing scenarios}
pct_c_p <- (Energy_emissions$total[2] -  Energy_emissions$total[1])/Energy_emissions$total[1]
pct_c_h <- (Energy_emissions$total[3] -  Energy_emissions$total[1])/Energy_emissions$total[1]
pct_yld_p <- (unlist(Yield_scenarios$projected[1]) -  unlist(Yield_scenarios$current[1])/unlist(Yield_scenarios$current[1])) 
(all_emis$`Total Energy + LUC emissions`[2] - all_emis$LUC[2])/all_emis$LUC[2]
```