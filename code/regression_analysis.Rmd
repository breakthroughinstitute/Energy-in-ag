---
title: "Regression Analysis for Emissions Predictions"
authors: "Saloni Shah, Dan Blaustein-Rejto "
date: "originally started 11/06/2020; last modified 1/24/2024"
output: html_document
---
#SETUP
```{r Load packages}
library(zoo)
library(sandwich)
library(plm)
library(lmtest)
library(jtools) 
library(ggstance)
library(tidyverse)
library(janitor)
library(naniar)
library(wesanderson)
library(grid);library(sysfonts);library(showtext)
```

```{r Read in Data}
#pesticide use
pest_use <- read_csv("raw_data/faostat/pest_use.csv") %>% select(Country = Area, Year, pest_use = Value)
#units: tonnes use in country inc. all herbicides, insecticide, fungicide etc. timeframe: 1990-2020

#on-farm energy use emissions - converting to CO2e and subtracting fisheries energy emissions from total on-farm energy emissions
energy_emiss <- read_csv("raw_data/faostat/energy_use_emissions.csv") %>% 
  select(-Domain, -Unit) %>% #remove to avoid creating extra rows when pivoting since Units missing when value is NA
  pivot_wider(names_from = Element, values_from = Value) %>% 
  mutate(tot_co2e = (`Emissions (CH4)`*28) + (`Emissions (N2O)`*265) + `Emissions (CO2)`) %>%  # calculate total energy emissions, multiplying by AR5 GWP values FAO uses
  select(Country = Area, Year, tot_co2e, Item) %>%
  pivot_wider(names_from = Item, values_from = tot_co2e) %>% 
  mutate(en_emiss = ifelse(is.na(`Total Energy`), NA, `Total Energy` - coalesce(`Energy used in fishery`, 0)),#calculate farm emissions as total - fishery, ensuring that the result is not NA just because Energy used in fishery is 
         en_emiss = ifelse(en_emiss<0,NA,en_emiss)) %>%  #replace negative values w/ NA
  select(Country, Year, en_emiss)
#units: kilotonnes (i.e. gigagram) CO2e.  timeframe: 1970-2020

#on-farm diesel use, used to estimate emissions embodied in machinery
##we subtract out gas-diesel use in fisheries since FAO metadata says that the gas-diesel oil values  includes fisheries, then multiply by 40% to estimate embodied machinery energy, per Woods et al. (2010) https://royalsocietypublishing.org/doi/full/10.1098/rstb.2010.0172
m_energy <- read_csv("raw_data/faostat/diesel_use.csv") %>% 
  select(Country = Area, Year, Item, Value) %>% 
  pivot_wider(names_from = Item, values_from = Value) %>% 
  mutate(m_energy = (`Gas-Diesel oil` -coalesce(`Gas-diesel oils used in fisheries`, 0)) * 0.4,
         m_energy = ifelse(m_energy<0,NA,m_energy)) %>%  #replace negative values w/ NA 
  select(Country, Year, m_energy)
#units: Terajoules. #timeframe 1970-2020

#fertilizer application emissions
fert_emiss <- read_csv("raw_data/faostat/fert_use_emissions.csv") %>% select(Country = Area, Year, fert_emiss = Value)
#units: kilotonnes (i.e. gigagram) CO2e, using AR5 GWP. timeframe: 1961-2020

#synthetic fertilizer use and use per ha cropland
fert_use_per_ha <- read_csv("raw_data/faostat/fert_use_per_ha_cropland.csv") %>% select(Country = Area, Year, fert_use_ha = Value)
#N use per ha of cropland. units: kg nutrient N/ha timeframe: 1961-2020

fert_use <- read_csv("raw_data/faostat/fert_use.csv") %>% select(Country = Area, Year, fert_use = Value) %>% mutate(fert_use= fert_use*1000)
#N agricultural use. units: convert from original units of tonnes N to kg N. timeframe: 1961-2020

#Yield and Cropland Data from calculate_calories_per_cropland.Rmd
prod <- read_csv("int_data/prod.cropland.csv")

#scenarios for regression analysis
scenarios <- read_csv("int_data/scenarios.csv") %>%  #yields are in kcal/ha
  mutate(region = recode(region, E_Afr = "Eastern", C_Afr = "Middle", S_Afr = "Southern", N_Afr = "Northern", W_Afr = "Western")) %>%   #Convert country names in scenarios to East, West, Central, South, North
  dplyr::rename(country=region) %>%  #rename column to match with variable name used to fit regression
  mutate(scenario = factor(scenario, levels = c("b", "p", "h"), labels = c("Baseline", "Projected", "High")))
```

```{r Calculate total fuel emissions, calculate emissions per ha for each input }
#join datasets
reg <- full_join(energy_emiss, fert_emiss) %>% full_join(fert_use) %>% full_join(fert_use_per_ha) %>%full_join(pest_use) %>% full_join(m_energy) %>% full_join(prod, by =  c("Country" = "country", "Year" = "year"))

#Fill in missing data for each column by country. Apply the last one carried forward method to each column in the dataframe (called reg below), grouping by country so that if the first observation is NA, the function doesn't replace with observation from different country. Will not fill in data for previous years.
reg <- reg %>% group_by(Country) %>% arrange(Country, Year) %>% fill(en_emiss:cropland)

#Calculate each emissions or input use per ha 
reg$en_emiss_ha <-reg$en_emiss/reg$cropland #units are gigagrams CO2e/ha of cropland (not harvested area)
reg$p_ha <- reg$pest_use/reg$cropland #units are tons applied/ha of cropland
reg$fert_emiss_ha <- reg$fert_emiss/reg$cropland#units are gigagrams CO2e/ha of cropland
reg$m_energy_ha <- reg$m_energy/reg$cropland#units are Terajoules/ha of cropland

#calculate yield
reg$yield <-  reg$tot_kcal/reg$cropland #units are kilocal/ha of cropland 
```

```{r Clean Data }
reg <-  clean_names(reg)  #makes all names lower case

#Determine if all yield values are non-zero
sum(reg$tot_kcal ==  0, na.rm=T) #none zero
sum(reg$cropland ==  0, na.rm=T) #none zero

#check for duplicate rows
get_dupes(reg, country, year) # no duplicates found

#count fuel emissions per ha, pesticide, and synthetic N observations by country
reg %>% group_by(country) %>% summarize(count = sum(is.na(en_emiss_ha)==FALSE)) 
reg %>% group_by(country) %>% summarize(count = sum(is.na(p_ha)==FALSE))
reg %>% group_by(country) %>% summarize(count = sum(is.na(fert_emiss_ha)==FALSE))
#results indicate different number of obs per country, an unbalanced panel dataset

#Convert 0's to NA's  - Not likely that a country has 0 fertilizer or fuel use if production and cropland  values are all non-zero. Likely that the "0" is missing data. These false 0's might influence regression estimates. All 0's will be converted to NAs and the regression will automatically eliminate all NAs. 
reg <- naniar::replace_with_na_all(data = reg, condition = ~.x == 0)

# #Graph data to inspect for outliers
# boxplot(reg$fert_use_ha)
# boxplot(reg$p_ha) #visual representation of data points and outliers. #values are generally within 0.137 tons P/ha maximum (from World Bank) ; 5698 values are NA
# plot(reg$yield, reg$en_emiss_ha) #there are some values for which yields are low but fuel emissions per ha is above 0.010 Gg/ha, values that are higher than 0.5 Gg/ha are nearly all from Singapore. Others that are above 0.15 include Bermuda, Hong Kong, and Kuwait.
# boxplot(reg$en_emiss_ha) #429 outliers
# plot(reg$yield, reg$m_energy_ha)  #outliers with values > 1 primarily Singapore, China Hong Kong, Kuwait
# plot(reg$yield, reg$fert_emiss_ha) #some high values have low yields, but values are substantially more clustered (w/ less extreme outliers) than for fert_use_ha, p_ha, en_emiss_ha, and m_energy_ha. 2012 values are NA, values are lower in magnitude 
# boxplot(reg$fert_emiss_ha)
# ggplot(reg) + geom_density(aes(fert_emiss_ha))

#remove countries with many substantial and unexplainable outlier values
outlier_en_countries <- reg %>% filter(en_emiss_ha>=0.15) %>% distinct(country) %>% pull() 
outlier_p_countries <- reg %>% filter(p_ha>=0.1) %>% distinct(country) %>% pull() 
outlier_m_countries <- reg %>% filter(m_energy_ha>=1.0) %>% distinct(country) %>% pull() 
reg <- reg %>% filter(!country %in% c(outlier_en_countries, outlier_p_countries, outlier_m_countries))
```

```{r Aggregate African countries data by region} 
#Subset by regions
#Member countries within each region are from the UN Statistics division : https://unstats.un.org/unsd/methodology/m49/overview/
country_groupings <- readxl::read_excel("raw_data/UNSD — Methodology.xlsx")

Africa <- country_groupings %>% filter(`Region Name`=="Africa") %>% select(`Country or Area`) %>% arrange(`Country or Area`) %>% pull()
W_Afr <- country_groupings %>% filter(`Intermediate Region Name`=="Western Africa") %>% select(`Country or Area`) %>% arrange(`Country or Area`) %>% pull()
E_Afr <- country_groupings %>% filter(`Intermediate Region Name`=="Eastern Africa") %>% select(`Country or Area`) %>% arrange(`Country or Area`) %>% pull()
C_Afr <- country_groupings %>% filter(`Intermediate Region Name`=="Middle Africa") %>% select(`Country or Area`) %>% arrange(`Country or Area`) %>% pull()
S_Afr <- country_groupings %>% filter(`Intermediate Region Name`=="Southern Africa") %>% select(`Country or Area`) %>% arrange(`Country or Area`) %>% pull()
N_Afr <- country_groupings %>% filter(`Sub-region Name`=="Northern Africa") %>% select(`Country or Area`) %>% arrange(`Country or Area`) %>% pull()

#define countries in Africa without matching names in faostat data in order to make names consistent for joining
Africa[which(!Africa %in% unique(reg$country))]

#match all possible, based on manual examination of faostat countries.  non-matching ones aren't listed separately in faostat
reg$country <- recode(reg$country, "Côte d'Ivoire"="Côte d’Ivoire")

#create new column with names as factors to revise
reg <- mutate(reg, Country_rename = country)

# add region name for countries in african regions AND in list of africa countries included in FOFA. this ensures that later regressions are conducted such that the fixed effect for a region only includes countries that are in the region for which predictions are being made (i.e. FOFA projections for northern africa exclude libya)
africa_scenario_countries <- read.csv(file = "int_data/countries_included_in_africa.csv")[,2]
reg$Country_rename[reg$Country_rename %in% E_Afr & reg$country %in% africa_scenario_countries] <-  "E_Afr"
reg$Country_rename[reg$Country_rename %in% W_Afr & reg$country %in% africa_scenario_countries] <-  "W_Afr"
reg$Country_rename[reg$Country_rename %in% C_Afr & reg$country %in% africa_scenario_countries] <-  "C_Afr"
reg$Country_rename[reg$Country_rename %in% S_Afr & reg$country %in% africa_scenario_countries] <-  "S_Afr"
reg$Country_rename[reg$Country_rename %in% N_Afr & reg$country %in% africa_scenario_countries] <-  "N_Afr"

aggregate_reg <- function(region_data, region_name){
  output <- region_data %>% select(year,cropland, tot_kcal, en_emiss, fert_use, pest_use, fert_emiss, m_energy) %>% 
  group_by(year) %>%
  summarise_all(sum, na.rm= TRUE) #sum total values across region by year
  
  #calculate per hectare values
  output <- output %>% mutate(yield = tot_kcal/cropland, en_emiss_ha = en_emiss/cropland, p_ha = pest_use/cropland, fert_emiss_ha = fert_emiss/cropland, fert_use_ha = fert_use/cropland, m_energy_ha = m_energy/cropland, country = region_name)
  
  return(output)
}

# #filter data by region
reg_E <- dplyr::filter(reg,reg$Country_rename == "E_Afr" )
reg_W <- dplyr::filter(reg,reg$Country_rename == "W_Afr" )
reg_C <- dplyr::filter(reg,reg$Country_rename == "C_Afr" )
reg_S <- dplyr::filter(reg,reg$Country_rename == "S_Afr" )
reg_N <- dplyr::filter(reg,reg$Country_rename == "N_Afr" )

reg_E_aggregate <- aggregate_reg(reg_E, "Eastern")
reg_W_aggregate <- aggregate_reg(reg_W, "Western")
reg_C_aggregate <- aggregate_reg(reg_C, "Middle")
reg_S_aggregate <- aggregate_reg(reg_S, "Southern")
reg_N_aggregate <- aggregate_reg(reg_N, "Northern")
```

```{r Load in other countries' data and join it with African regions data}
#Filter out Africa data, keep non-Africa data 
reg_other_country <- reg %>% filter(!Country_rename %in% c("N_Afr", "C_Afr", "S_Afr","E_Afr","W_Afr")) %>% select(-Country_rename)

#Join Africa data with all of the countries' (non Africa) data
reg_all_countries <- bind_rows(reg_other_country, reg_C_aggregate, reg_E_aggregate, reg_S_aggregate, reg_W_aggregate, reg_N_aggregate)
```

```{r Explore data and remove outliers}

#OLS model includes country fixed effect to reduce bias

reg_all_countries <- naniar::replace_with_na_all(data = reg_all_countries, condition = ~.x == 0) #Make sure all 0's are converted to NAs, lm function automatically removes data with NAs 

# #Outlier detection is based on yield values, could extend to the other inputs 
# summary(reg_all_countries$yield)
# boxplot(reg_all_countries$yield)
# hist(reg_all_countries$yield,
#   xlab = "yield",
#   main = "Histogram of yield",
#   breaks = sqrt(nrow(reg_all_countries))) # set number of bins
# #Barbados, Kuwait, Belgium, Martinque occupy many of the highest values
# #higher than ~2*10^7 is an outlier based on historgram and barplot
# sum(reg_all_countries$yield >= 20000000, na.rm=T) #32 entries
# sum(reg_all_countries$yield >= 20000000, na.rm=T)/nrow(reg_all_countries) #~.5% of total entries
filter_reg <- filter(reg_all_countries, reg_all_countries$yield < 20000000)
write_csv(filter_reg %>% select(country, year, cropland, en_emiss_ha, p_ha, fert_emiss_ha, m_energy_ha, yield), "int_data/reg_dat_outliers_removed.csv")
```

#Regression Code
```{r Prep for regression: Convert input use to consistent units of emissions per ha}
#Conversion factors
fert_ef <- 5.66 #5.66 kg CO2 eq/kg product  is the fertilizer EF
pest_ef <- 25.5 # 25.5 kg cO2e/kg applied is the pesticides EF
tpes_ef <- 34 #emissions factor for primary energy supply for Africa (34 tons CO2 eq/Terajoules), carbon intensity of energy mix

kg_to_mt <- 1/10^9 #conversion factor for kg to megatons (million metric tons)
tons_to_mt <- 1/10^6 #conversion factor for metric tons to megatons (million metric tons)
Gg_to_mt <- 1/10^3 #conversion factor for gigatons to megatons (million metric tons)

filter_reg <- filter_reg %>% 
  mutate(en_emiss_ha = en_emiss_ha * Gg_to_mt,#convert gigagrams CO2e emissions from energy use per ha to MMT CO2e emissions from energy use per ha     
         fert_emiss_ha = fert_emiss_ha * Gg_to_mt, #convert gigagrams CO2e emissions from energy use per ha to MMT CO2e emissions from energy use per ha
         fert_m_emiss_ha = fert_use_ha * fert_ef * kg_to_mt, #convert kg fertilizer use/ha to MMT CO2e emissions from fertilizer manufacturing per ha
         m_emiss_ha = m_energy_ha * tpes_ef * tons_to_mt, #convert from Terajoules per ha to MMT CO2e emissions per ha
         pest_emiss_ha = p_ha * pest_ef * tons_to_mt, #convert tons pesticide use/ha to MMT CO2e emissions from pesticide manufacturing per ha
         tot_emiss_ha = en_emiss_ha + fert_emiss_ha + fert_m_emiss_ha + m_emiss_ha + pest_emiss_ha) #total emissions per ha in MMT CO2e
```

```{r Run OLS log-log regressions with filtered regression data to estimate relationship between yield and input use factor}
#regressions have country fixed effect where africa regions (e.g. east, west) are used as countries, enabling prediction later

#models for emissions per ha
en_emiss_ols <- lm(filter_reg, formula = log(en_emiss_ha) ~ log(yield) + factor(country)) #Energy Emissions OLS Regression
fert_emiss_ols <- lm(filter_reg, formula = log(fert_emiss_ha) ~ log(yield) + factor(country)) #Synthetic N emissions OLS Regression
fert_m_emiss_ols <- lm(filter_reg, formula = log(fert_m_emiss_ha) ~ log(yield) + factor(country)) #Synthetic N manufacturing emissions OLS Regression
m_emiss_ols <- lm(filter_reg, formula = log(m_emiss_ha) ~ log(yield) + factor(country)) #Energy embodied in machinery OLS Regression
pest_emiss_ols <- lm(filter_reg, formula = log(pest_emiss_ha) ~ log(yield) + factor(country)) #Pesticides manufacturing emissions OLS Regression
tot_emiss_ols <- lm(filter_reg, formula = log(tot_emiss_ha) ~ log(yield) + factor(country)) #Total emissions OLS Regression

#models for input use per ha
p_ols <- lm(filter_reg, formula = log(p_ha) ~ log(yield) + factor(country)) #Pesticides Use OLS regression
fert_use_ols <- lm(filter_reg, formula = log(fert_use_ha) ~ log(yield) + factor(country))#Synthetic N use or application OLS regression
m_energy_ols <- lm(filter_reg, formula = log(m_energy_ha) ~ log(yield) + factor(country))#Energy embodied in machinery OLS regression
```


```{r Sanity Check on parameters - optional for running}
#Check to see that that the model fitted values match the log(actual values) in the regression dataset, values should fall around 1:1 line

# plot(x = log(na.omit(filter_reg$p_ha)), y = p_ols$fitted.values, xlab = "True values", ylab = "Model Fitted values", main = "Regression fits of pesticide/ha values")
# abline(b=1, a=0) #values fall around this 1:1 line
# 
# plot(x = log(na.omit(filter_reg$en_emiss_ha)), y = fuel_ols$fitted.values, xlab = "True values", ylab = "Model Fitted values", main = "Regression fits of fuel/ha values")
#  abline(b=1, a=0) #values fall around this 1:1 line
# 
# plot(x = log(na.omit(filter_reg$fert_emiss_ha)), y = syn_n_ols$fitted.values, xlab = "True values", ylab = "Model Fitted values", main = "Regression fits of synN/ha values")
# abline(b=1, a=0) #values fall around this 1:1 line
# 
# plot(log(na.omit(filter_reg$fert_use_ha)), fert_use_ols$fitted.values,xlab = "True values", ylab = "Model Fitted values", main = "Regression fits of synN use/ha values"  )
# abline(b=1, a=0) #values fall around this 1:1 line
```
#Generate predictions
```{r Calculate predicted input emissions and use per ha by input, scenario and region}
#create empty dataframe to add in fixed effect regression results
reg_fe_results <- tibble(dep_var=character(), scenario = character(), region = character(), fit=double(), lwr = double(), upr = double())

i=1
#define regions to loop through
regions <- c("Eastern","Middle","Northern","Southern","Western")

#map variables to model names
var_models = tibble(var = c("en_emiss_ha", "fert_emiss_ha", "fert_m_emiss_ha", "m_emiss_ha", "pest_emiss_ha", "tot_emiss_ha", "p_ha", "fert_use_ha"),
                   model = c("en_emiss_ols", "fert_emiss_ols", "fert_m_emiss_ols", "m_emiss_ols", "pest_emiss_ols", "tot_emiss_ols", "p_ols", "fert_use_ols"))

#loop through each dependent variable, scenario, and region to predict each dep variable for each region & scenario
for (dependent_variable in var_models$var) {
  for (scenario in unique(scenarios$scenario)){
    for (region in regions){
      
      reg_fe_results[i,] = c(dependent_variable, 
                            scenario, 
                            region, 
                            as.list(as_vector(predict(get(var_models$model[var_models$var==dependent_variable]), #choose regression model to predict with
              newdata = scenarios[scenarios$country==region & scenarios$scenario==scenario, c("country", "yield")], #add regression estimates
              interval = "confidence", level = 0.95))))
      i=i+1
    }
  }
}

#exponentiate estimates and confidence intervals
reg_fe_results <- reg_fe_results %>% mutate(fit = exp(fit), lwr = exp(lwr), upr = exp(upr)) 
  
#convert scenario in reg_fe_results to factor variable
reg_fe_results <- reg_fe_results %>% mutate(scenario = factor(scenario, levels = c("Baseline", "Projected", "High")))
```

```{r Calculate total input emissions for each input source and region}
#create dataframe with only totals for each emissions type and for all input emissions, by region and scenario
region_totals <- reg_fe_results %>% 
  filter(dep_var %in% c("en_emiss_ha", "fert_emiss_ha", "fert_m_emiss_ha", "m_emiss_ha", "pest_emiss_ha", "tot_emiss_ha")) %>% #filter to only emissions variables
  pivot_longer(c(fit, lwr, upr), names_to = "estimate") %>% #make dataframe long
  left_join(scenarios, by = c("region" = "country", "scenario")) %>% #add production scenario variables i.e. yield, area to fe regression results table.
  mutate(total_emiss = value * arable_area) %>%  #calculate total emissions for each input source, region, and scenario, and lower and upper CI.
  select(dep_var, scenario, region, estimate, total_emiss) %>% #select variables of interest
  pivot_wider(names_from = dep_var, values_from = total_emiss)  #make dataframe wide

#rename each emissions type to note that it is total emissions, not emissions per hectare
names(region_totals)[names(region_totals) == "en_emiss_ha"] <- "en_emiss"
names(region_totals)[names(region_totals) == "fert_emiss_ha"] <- "fert_emiss"
names(region_totals)[names(region_totals) == "fert_m_emiss_ha"] <- "fert_m_emiss"
names(region_totals)[names(region_totals) == "m_emiss_ha"] <- "m_emiss"
names(region_totals)[names(region_totals) == "pest_emiss_ha"] <- "pest_emiss"
names(region_totals)[names(region_totals) == "tot_emiss_ha"] <- "tot_emiss"
```

```{r Calculate total emissions per ha from input use by region and scenario}
#create dataframe for predictions by region
scenarios_predictions <- scenarios %>% 
  filter(country!="Africa")

scenarios_predictions <- scenarios_predictions %>% #add predictions of per hectare emissions for each region
  mutate(
    en_emiss_ha = exp(predict(en_emiss_ols, newdata = scenarios_predictions)),
    fert_emiss_ha = exp(predict(fert_emiss_ols, newdata = scenarios_predictions)),
    fert_m_emiss_ha = exp(predict(fert_m_emiss_ols, newdata = scenarios_predictions)),
    m_emiss_ha = exp(predict(m_emiss_ols, newdata = scenarios_predictions)),
    pest_emiss_ha = exp(predict(pest_emiss_ols, newdata = scenarios_predictions)),
    tot_emiss_ha_single_mod = exp(predict(tot_emiss_ols, newdata = scenarios_predictions)),
    tot_emiss_ha = en_emiss_ha+fert_emiss_ha+fert_m_emiss_ha+m_emiss_ha+pest_emiss_ha)

#calculate variance and 95% CI for total emissions per ha for each region
library(car)

# Function to calculate variance using delta method
calculate_variance <- function(model, new_data) {
  predictions <- predict(model, newdata = new_data, se.fit = TRUE)
  se_log <- predictions$se.fit
  pred_log <- predictions$fit
  pred <- exp(pred_log)
  var_pred <- (exp(2 * pred_log) * se_log^2)
  return(var_pred)
}

# Calculating variances
var_en <- calculate_variance(en_emiss_ols, scenarios_predictions)
var_f <- calculate_variance(fert_emiss_ols, scenarios_predictions)
var_f_m <- calculate_variance(fert_m_emiss_ols, scenarios_predictions)
var_m <- calculate_variance(m_emiss_ols, scenarios_predictions)
var_p <- calculate_variance(pest_emiss_ols, scenarios_predictions)


# Summing variances
scenarios_predictions$total_var <- var_en + var_f + var_f_m + var_m + var_p

# Calculating 95% CI
z <- qnorm(0.975) # Z value for 95% CI
scenarios_predictions <- scenarios_predictions %>%
  mutate(
    ci_lower = tot_emiss_ha - z * sqrt(total_var),
    ci_upper = tot_emiss_ha + z * sqrt(total_var)
  )
```

```{r Calculate total emissions from input use for Africa}
#Calculate total emissions for each source, region and scenario
scenarios_predictions <- scenarios_predictions %>% 
  mutate(tot_t = tot_emiss_ha * arable_area,
         tot_e = en_emiss_ha * arable_area,
         tot_f = fert_emiss_ha * arable_area,
         tot_fm = fert_m_emiss_ha * arable_area,
         tot_m = m_emiss_ha * arable_area,
         tot_p = pest_emiss_ha * arable_area) 

#Calculate Variance for Each emission source, region and scenario 
scenarios_predictions <- scenarios_predictions %>% 
  mutate(
    var_t = (arable_area^2)* total_var,
    var_e = (arable_area^2)* var_en,
    var_f = (arable_area^2)* var_f,
    var_fm = (arable_area^2)* var_f_m,
    var_m = (arable_area^2)* var_m,
    var_p = (arable_area^2)* var_p
  )

#calculate Africa sum emissions and sum variance
africa_sums <- scenarios_predictions %>% 
  group_by(scenario) %>% 
  summarize(across(c(tot_t, tot_e, tot_f, tot_fm, tot_m, tot_p, 
                     var_t, var_e, var_f, var_fm, var_m, var_p), sum)) %>% 
  pivot_longer(cols = -scenario, names_to = c(".value", "estimate"), names_pattern = "(.*)_(.*)")

#Calculate Confidence Interval
z <- qnorm(0.975) # Z value for 95% CI

africa_sums <- africa_sums %>% 
  mutate(
    lwr = tot - z * sqrt(var),
    upr = tot + z * sqrt(var)
  )
africa_sums
```


```{r Calculate total input emissions for Africa with 95% confidence interval}
#we calculate the sum separately since calculating a confidence interval for teh sum requires careful treatment

#map models to model names
models <- list(en_emiss_ols, fert_emiss_ols, fert_m_emiss_ols, m_emiss_ols, pest_emiss_ols, tot_emiss_ols)
model_names <- c("en_emiss", "fert_emiss", "fert_m_emiss", "m_emiss", "pest_emiss", "tot_emiss")
scenario_names <- c("Baseline", "Projected", "High")

#Define function to calculate sum and confidence interval across the regions
calculate_sum_and_ci <- function(model_name){
  # Extract coefficients and variance-covariance matrix
  beta <- coef(model_name)
  V <- vcov(model_name)
                      
  # Structure prediction data for calculation
  
  predictions <- reg_fe_results %>%  #extract exponentiated log values (per ha) from model predictions 
    filter(dep_var == model_name[["terms"]][[2]][[2]], #filter to dependent variable for this model. 
                                 region %in% regions) %>% #ensure only correct regions included
    arrange(scenario, region) %>% #structure in same way as other data to ensure data alignment
    select(fit) %>% 
    pull() 
  
  yields <- scenarios %>% #extract yield values for each region and scenario
    filter(country %in% regions) %>% 
    arrange(scenario, country) %>% 
    select(country, yield) %>% 
    pull()
  
  l_values <- scenarios %>% #extract arable land area values for each region and scenario
    filter(country %in% regions) %>% 
    arrange(scenario, country) %>% 
    select(arable_area) %>% 
    pull() 
  
  ## Calculation of derivatives for log yield and fixed effects
  #map countries to country fixed effects in coeffient table
  country_coef_indices <- sapply(regions, function(country) {
    which(names(beta) == paste0("factor(country)", country))
  })
  
  # Number of countries and scenarios
  num_countries <- length(regions)
  num_scenarios <- length(predictions) / num_countries
  country_factors <- rep(regions, num_scenarios)
  
  # Initialize a matrix for derivatives for all scenarios
  derivatives_all_scenarios <- matrix(nrow = length(predictions), ncol = 1 + num_countries)
  
  # Loop over each scenario
  for (scenario in 1:num_scenarios) {
    # Starting and ending indices for this scenario in the predictions vector
    start_idx <- (scenario - 1) * num_countries + 1
    end_idx <- scenario * num_countries
  
    # Extract predictions for this scenario
    scenario_predictions <- predictions[start_idx:end_idx]
    scenario_yields <- yields[start_idx:end_idx]
    scenario_l_values <- l_values[start_idx:end_idx]
    
    # Fill in the derivatives matrix for log(yield)
    derivatives_all_scenarios[start_idx:end_idx, 1] <- scenario_predictions * (1 / scenario_yields) * scenario_l_values

      
    # Fill in derivatives for each country's fixed effect
    for (i in 1:num_countries) {
      country_index <- country_coef_indices[i]
      derivatives_all_scenarios[start_idx:end_idx, i + 1] <- ifelse(country_factors[start_idx:end_idx] == regions[i], scenario_predictions * scenario_l_values, 0)
    }
  }
  
  # Initialize a vector to store variance of the sum for each scenario
  var_sum_scenarios <- numeric(num_scenarios)
  
  # Loop over each scenario
  for (scenario in 1:num_scenarios) {
    # Starting and ending indices for this scenario in the predictions vector
    start_idx <- (scenario - 1) * num_countries + 1
    end_idx <- scenario * num_countries
  
    # Variance of the sum for this scenario
    var_sum <- 0
    for (i in 1:(1 + num_countries)) { # Include log(yield) and the specific countries
      for (j in 1:(1 + num_countries)) {
        var_sum <- var_sum + sum(derivatives_all_scenarios[start_idx:end_idx, i] * derivatives_all_scenarios[start_idx:end_idx, j]) * V[i, j]
      }
    }
    var_sum_scenarios[scenario] <- var_sum
  }
  
  # Standard error of the sum for each scenario
  se_sum_scenarios <- sqrt(var_sum_scenarios)
  
  # Calculate the sum, across regions, of the total emissions (predicted per ha value * arable area) for each scenario
  # Calculate the sum, across regions, for each scenario
  sum_multiplied_predictions <- tibble(Scenario = character(num_scenarios), Sum = numeric(num_scenarios))
  for (scenario in 1:num_scenarios) {
  start_idx <- (scenario - 1) * num_countries + 1
  end_idx <- scenario * num_countries
  
  sum_multiplied_predictions$Scenario[scenario] <- scenario_names[scenario]
  sum_multiplied_predictions$Sum[scenario] <- sum(predictions[start_idx:end_idx] * l_values[start_idx:end_idx])
}

# Calculate the confidence interval for each scenario
ci_lower <- sum_multiplied_predictions$Sum - (1.96 * se_sum_scenarios)
ci_upper <- sum_multiplied_predictions$Sum + (1.96 * se_sum_scenarios)

# Return results as a dataframe
return(data.frame(
  scenario = sum_multiplied_predictions$Scenario,
  fit = sum_multiplied_predictions$Sum,
  lwr = ci_lower,
  upr = ci_upper
))

}

#apply function to each model
results_list <- lapply(models, calculate_sum_and_ci)
names(results_list) <- model_names

#combine into 1 dataframe
afr_totals <- bind_rows(results_list, .id = "source") %>% 
  mutate(region = "Africa") %>% 
  pivot_longer(cols = c(fit, lwr, upr), names_to = "estimate", values_to = "value") %>%
  pivot_wider(names_from = source, values_from = value)
```


#Add LUC
```{r Add LUC data to input emissions data}
region_key <- c(C_Afr="Middle", E_Afr="Eastern", N_Afr = "Northern", S_Afr="Southern", W_Afr="Western")

convert_luc_co2 <- function(x){return(x * kg_to_mt/38)} # convert to million metric ton and divide by 38, the number of years between 2012 and 2050, this division annualizes the emissions

luc_co2_region <- read_csv("int_data/luc_co2_region.csv") %>%  #read in kg CO2e from LUC by region and scenario, with low values calculated allowing for negative LUC for crops (i.e. restoration) and high values setting all negative LUC to 0.
  mutate(region = recode(region, !!!region_key)) %>%  #rename regions for joining
  rename(luc_co2_low = co2_low, luc_co2_high=co2_high) %>%  #clarify column names
  mutate(across(c(luc_co2_low, luc_co2_high), convert_luc_co2), #convert to MMT CO2/yr
         scenario = factor(scenario, levels = c("b", "p", "h"), labels = c("Baseline", "Projected", "High"))) #make scenario a factor to join below w/ other data

#add rows to luc_co2_region that is the total across regions for each scenario and c_loss_ratio
luc_co2_region <- luc_co2_region %>% 
  bind_rows(luc_co2_region %>% 
              group_by(scenario, c_loss_ratio) %>% 
              summarise(luc_co2_low = sum(luc_co2_low), luc_co2_high = sum(luc_co2_high), luc = sum(luc)) %>% 
              ungroup() %>% 
              mutate(region = "Africa"))

all_emiss <- region_totals %>% bind_rows(afr_totals) %>% #combine region and Africa values
  inner_join(luc_co2_region, by = c("scenario", "region"), relationship = "many-to-many") %>%  #join input and LUC emissions
  mutate(tot_co2_high = tot_emiss + luc_co2_high, tot_co2_low = tot_emiss + luc_co2_low) #calculate total emissions for low and high LUC approaches

write_csv(all_emiss,"results/all_emiss_region.csv")
```

#Sensitivity analysis
```{r Calculate LUC and total input emissions by scenario and region, under linear model}
#fit linear model to filtered data set with african regions aggregated
afr_tot_emiss_linear_mod <- lm(africa_level_reg, formula = tot_emiss_ha ~ yield + factor(country))

#Generate predictions for Africa under each yield scenario
reg_linear_afr_results <- tibble(dep_var=character(), scenario = character(), region = character(), fit=double(), lwr = double(), upr = double())
i=1
for (scenario in unique(scenarios$scenario)){
  reg_linear_afr_results[i,] = c("tot_emiss_ha", 
                         scenario, 
                         "Africa", 
                         as.list(as_vector(predict(afr_tot_emiss_linear_mod, #choose regression model 
                              newdata = scenarios[scenarios$country=="Africa" & scenarios$scenario==scenario, c("country", "yield")], 
                              interval = "confidence", level = 0.95
                              ))))
    i=i+1
  }

#Calculate total predicted input emissions for scenario
reg_linear_afr_results <- reg_linear_afr_results %>% 
  pivot_longer(c(fit, lwr, upr), names_to = "estimate") %>% #make dataframe long
  left_join(scenarios, by = c("region" = "country", "scenario")) %>% #add production scenario variables i.e. yield, area to fe regression results table.
  mutate(total_emiss = value * arable_area) %>%  #calculate total emissions for each input source, region, and scenario, and lower and upper CI.
  select(dep_var, scenario, region, estimate, total_emiss) %>% #select variables of interest
  pivot_wider(names_from = dep_var, values_from = total_emiss) %>% rename(tot_emiss = tot_emiss_ha)  #make dataframe wide

#Add LUC
reg_linear_afr_results <- inner_join(reg_linear_afr_results, luc_co2_region, by = c("scenario", "region"), relationship = "many-to-many") %>%  #join input and LUC emissions
  mutate(tot_co2_high = tot_emiss + luc_co2_high, tot_co2_low = tot_emiss + luc_co2_low) #calculate total emissions for low and high LUC approaches
```

```{r Calculate LUC and total input emissions by scenario and region, with data filter to after 1990}
#re-run log-log regression with data filterted to adfter 1990, which is when pesticide use data is first available. all values are NA before then
#fit linear model to filtered data set with african regions aggregated
afr_tot_emiss_1990_mod <- lm(africa_level_reg %>% filter(year>=1990), formula = log(tot_emiss_ha) ~ log(yield) + factor(country))

#Generate predictions for Africa under each yield scenario
afr_1990_results <- tibble(dep_var=character(), scenario = character(), region = character(), fit=double(), lwr = double(), upr = double())
i=1
for (scenario in unique(scenarios$scenario)){
  afr_1990_results[i,] = c("tot_emiss_ha", 
                         scenario, 
                         "Africa", 
                         as.list(as_vector(predict(afr_tot_emiss_1990_mod, #choose regression model 
                              newdata = scenarios[scenarios$country=="Africa" & scenarios$scenario==scenario, c("country", "yield")], 
                              interval = "confidence", level = 0.95
                              ))))
    i=i+1
  }

#Calculate total predicted input emissions for scenario
afr_1990_results <- afr_1990_results %>% 
  pivot_longer(c(fit, lwr, upr), names_to = "estimate") %>% #make dataframe long
  mutate(value = exp(value)) %>% #convert from log scale to original scale
  left_join(scenarios, by = c("region" = "country", "scenario")) %>% #add production scenario variables i.e. yield, area to fe regression results table.
  mutate(total_emiss = value * arable_area) %>%  #calculate total emissions for each input source, region, and scenario, and lower and upper CI.
  select(dep_var, scenario, region, estimate, total_emiss) %>% #select variables of interest
  pivot_wider(names_from = dep_var, values_from = total_emiss) %>% rename(tot_emiss = tot_emiss_ha)  #make dataframe wide

#Add LUC
afr_1990_results <- inner_join(afr_1990_results, luc_co2_region, by = c("scenario", "region"), relationship = "many-to-many") %>%  #join input and LUC emissions
  mutate(tot_co2_high = tot_emiss + luc_co2_high, tot_co2_low = tot_emiss + luc_co2_low) #calculate total emissions for low and high LUC approaches
afr_1990_results %>% filter(estimate == "fit", c_loss_ratio == "H")
```


#Graph results
```{r Set BTI style guide for  graphing}
#define colors
bti_colors <- c("#0d4459", "#00a990", "#d05527", "#a33332",
                "#b381d0",  "#dfb9a6", "#b2b2b1", "#2A2A2A", "#ecc627")

#general plot theme
theme_bti <- function (base_size = 14, base_family = "Helvetica") {
  theme_classic() %+replace% 
    theme(plot.title = element_text(color = "black",  size = 14), 
          strip.text.x = element_text(size = 14),
          strip.background = element_blank(),
          
          #gridlines
          panel.grid.major.y = element_blank(), panel.grid.minor.y = element_blank(), #no grid lines
          panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank(), #no grid lines
          #background and border
          panel.border = element_blank(), #no plot border
          #panel.background = element_rect(fill = "white"), #white panel background 
          #legend
          legend.position = "bottom", #legend default position is bottom
          legend.key = element_rect(fill = "#FFFFFF00", color = NA), #no border around legend items
          legend.text = element_text(size=10),
          legend.title = element_text(size=10),
          #axes
          axis.line.x = element_line(color="black", size = .5),
          axis.line.y = element_line(color="black", size = .5),
          axis.title.y = element_text(size = 12, angle = 90), 
          axis.title.x = element_text(size = 12), 
          #logo 
          plot.margin = unit(c(0.5, 0.5, 2, 0.5), "lines") # add space for logo
    )
}
```

```{r Set up data for graphing and tables}
c_loss_selected <- "S" #edit to change which soil carbon loss scenario is used for following graphs. options are S (searchinger), H (houghton)
luc_scenario_excluded <- "low" #edit to change which LUC scenario is used for following graphs. options are low and high
luc_scenario_included <- "luc_co2_high" #as above options are luc_co2_low and luc_co2_high

#map short crop names (e.g. banp, barl) onto full names (e.g. Bananas and Plantains, Barley)
crop_full_names <-c(
  "banp" = "Bananas and Plantains",
  "barl" = "Barley",
  "bean" = "Beans, dry",
  "cass" = "Cassava",
  "cott" = "Cotton",
  "grou" = "Groundnuts",
  "maiz" = "Maize",
  "mill" = "Millet",
  "ooil" = "Oilcrops",
  "opul" = "Pulses",
  "pota" = "Potatoes",
  "rice" = "Rice, paddy",
  "sorg" = "Sorghum",
  "soyb" = "Soybeans",
  "sugb" = "Sugar beet",
  "sugc" = "Sugar cane",
  "swpy" = "Sweet potatoes and yams",
  "whea" = "Wheat")

fig_dat <- all_emiss %>% 
  filter(c_loss_ratio == c_loss_selected) %>%
  select(-c_loss_ratio, -paste0("luc_co2_", luc_scenario_excluded), -tot_co2_high, -tot_co2_low) %>% 
  mutate(scenario = factor(scenario, levels = c("Baseline", "Projected", "High"))) %>%  #change order of scenario column
  pivot_longer(cols = c(en_emiss:starts_with("luc_co2")),names_to = "source", values_to = "emiss") %>% #restructure so there is a column for the lwr and upr input emission totals
  pivot_wider(names_from = estimate, values_from = emiss) %>%  #restructure so there is a column for the lwr and upr input emission totalsest)
  mutate(lwr = case_when(source == luc_scenario_included ~ NA_real_, TRUE ~ lwr), #set lwr and upr to NA when source equals "luc_co2_low" or "luc_co2_high" so that error bars are not plotted for LUC emissions
          upr = case_when(source == luc_scenario_included ~ NA_real_, TRUE ~ upr))
```

```{r Fig 1. Total Africa LUC and Input Emissions by Scenario}
#column chart showing total LUC emissions and total input emissions (sum of energy, fertilizer, pesticide, machinery), by scenario
fig1 <- fig_dat %>% 
  filter(source %in% c(luc_scenario_included, "tot_emiss"), region=="Africa") %>% 
  ggplot()+
  geom_col(aes(x = scenario, y = fit, fill = source), position = "dodge") +
  geom_errorbar(aes(x = scenario, ymin = lwr, ymax = upr, group=source), width = 0.2, position = position_dodge(.9))+
  ggtitle("Emissions from input use and LUC by scenario for Africa.") + 
  xlab("Scenarios") + 
  ylab("Greenhouse Gas Emissions (million metric tons CO2e)") + 
  labs(fill = "Emission Source")+  #caption = "95% confidence interval shown only for total input emissions."
  scale_y_continuous(expand = expand_scale(mult = c(0.0, 0.1)))+ #move y origin to plot margin/line
  theme_bti()+
  scale_fill_manual(values = setNames(c(bti_colors[1], bti_colors[2]), c("tot_emiss", luc_scenario_included)), #set colors
                    labels = setNames(c("Manufacturing and Use of Farm Inputs", "Land Use Change"), c("tot_emiss", luc_scenario_included))) #set labels

fig1
ggsave(plot = fig1, filename = "results/graphs/manuscript/fig1.png", width = 6, height = 4, units = "in", dpi = 300)
```

```{r Fig 2. Africa Input Emissions by Scenario and Source}
#column chart showing each source of input emissions for Africa, by scenario
fig2 <- fig_dat %>% 
  filter(!source %in% c(luc_scenario_included, "tot_emiss"), region=="Africa") %>% #filter just to individual inputs
  ggplot()+
  geom_col(aes(x = scenario, y = fit, fill = source), position = "dodge") +
  geom_errorbar(aes(x = scenario, ymin = lwr, ymax = upr, group=source), width = 0.2, position = position_dodge(.9))+
  ggtitle("Emissions from input use by scenario for Africa.") + 
  xlab("Scenarios") + 
  ylab("Greenhouse Gas Emissions (million metric tons CO2e)") + 
  labs(fill = "Emission Source")+  #caption = "95% confidence interval shown only for total input emissions."
  scale_y_continuous(expand = expand_scale(mult = c(0.0, 0.1)))+ #move y origin to plot margin/line
  theme_bti()+
  scale_fill_manual(values=bti_colors, #set colors to bti colors
                    labels = c("On-Farm Energy", "Synthetic N Application", "Synthetic N Manufacturing", "Pesticide Manufacturing", "Machinery Manufacturing")) #set labels

fig2
ggsave(plot = fig2, filename = "results/graphs/manuscript/fig2.png", width = 6, height = 4, units = "in", dpi = 300)
```

```{r Fig S1. Total LUC and Input Emissions by Scenario for each region}
#column chart showing total LUC emissions and total input emissions (sum of energy, fertilizer, pesticide, machinery), by scenario, for each region
figS1 <- fig_dat %>% 
  filter(source %in% c(luc_scenario_included, "tot_emiss"), region!="Africa") %>% 
  ggplot()+
  geom_col(aes(x = scenario, y = fit, fill = source), position = "dodge") +
  geom_errorbar(aes(x = scenario, ymin = lwr, ymax = upr, group=source), width = 0.2, position = position_dodge(.9))+
  ggtitle("Emissions from input use and LUC by scenario for each region.") + 
  xlab("Scenarios") + 
  ylab("Greenhouse Gas Emissions (million metric tons CO2e)") + 
  facet_wrap(~region, scales = "free_y", ncol=3)+
  labs(fill = "Emission Source")+  #caption = "95% confidence interval shown only for total input emissions. "
  scale_y_continuous(expand = expand_scale(mult = c(0.0, 0.1)))+ #move y origin to plot margin/line
  scale_fill_manual(values = setNames(c(bti_colors[1], bti_colors[2]), c("tot_emiss", luc_scenario_included)), #set colors
                     labels = setNames(c("Manufacturing and Use of Farm Inputs", "Land Use Change"), c("tot_emiss", luc_scenario_included)))+ #set labels
  theme_bti() + 
  geom_hline(yintercept = 0, color = "black", linewidth = 1) #add x axis line since doesnt show up for all when facetted

figS1
ggsave(plot = figS1, filename = "results/graphs/supplementary/figs1.png", width = 6, height = 4, units = "in", dpi = 300)
```

```{r Fig S2. Input Emissions by Scenario and Source for each region}
#column chart showing each source of input emissions for each region, by scenario
figS2 <- fig_dat %>% 
  filter(!source %in% c(luc_scenario_included, "tot_emiss"), region!="Africa") %>% 
  ggplot()+
  geom_col(aes(x = scenario, y = fit, fill = source), position = "dodge") +
  geom_errorbar(aes(x = scenario, ymin = lwr, ymax = upr, group=source), width = 0.2, position = position_dodge(.9))+
  ggtitle("Emissions from input use by scenario for each region.") + 
  xlab("Scenarios") + 
  ylab("Greenhouse Gas Emissions (million metric tons CO2e)") + 
  facet_wrap(~region, scales = "free_y", ncol=3)+
  labs(fill = "Emission Source")+  #caption = "95% confidence interval shown."
  scale_y_continuous(expand = expand_scale(mult = c(0.0, 0.1)))+ #move y origin to plot margin/line
  scale_fill_manual(values=bti_colors, #set colors to bti colors
                    labels = c("On-Farm Energy", "Synthetic N Application", "Synthetic N Manufacturing", "Pesticide Manufacturing", "Machinery Manufacturing"))+ #set labels
  theme_bti() + 
  geom_hline(yintercept = 0, color = "black", linewidth = 1) #add x axis line since doesnt show up for all when facetted

figS2
ggsave(plot = figS2, filename = "results/graphs/supplementary/figs2.png", width = 6, height = 4, units = "in", dpi = 300)
```

```{r Fig S3. Rebound Analysis Line Graph}

```

#Create and Export Tables
```{r Table 1. Africa Yield and Harvested Area and Arable Area by Scenario}
decimals <- 1 #define number of decimals to round to

scenarios %>% filter(country=="Africa") %>% 
  mutate(yield = round(yield/1000000, digits = decimals), #convert to million kcal/ha
         harv_area = round(harv_area/1000000, digits = decimals), #convert to million ha
         arable_area = round(arable_area/1000000, digits = decimals)) %>% #convert to million ha
  select("Scenario"=scenario, "Yield (million kcal/ha)" = yield, 
         "Harvested Area (million ha)" = harv_area, "Arable Area (million ha)" = arable_area) %>% 
  arrange(Scenario) %>%  #order by scenario order
  write_csv("results/tables/table1_afr_yield_area_by_scenario.csv")
```

```{r Table S1. Yield, Harvested Values for each Scenario and Region}
scenarios %>% 
  mutate(scenario = recode(scenario, "b"="Baseline","p"="Projected", "h"="High"), #rename scenarios for presentation
         country = recode(country, "Middle" = "Middle Africa", "Eastern" = "Eastern Africa", "Northern" = "Northern Africa", "Southern" = "Southern Africa", "Western" = "Western Africa"), #change to full names for regions
         yield = round(yield/1000000, digits = decimals), #convert to million kcal/ha
         harv_area = round(harv_area/1000000, digits = decimals), #convert to million ha
         arable_area = round(arable_area/1000000, digits = decimals)) %>% #convert to million ha
  select("Region"=country, "Scenario"=scenario, "Yield (million kcal/ha)" = yield, 
         "Harvested Area (million ha)" = harv_area, "Arable Area (million ha)" = arable_area) %>%
  arrange(Scenario, Region) %>% #arder by scenario order, and regions alphabetically within
  write_csv("results/tables/tableS1_yield_area_by_scenario_and_region.csv")
```

```{r Table S2. tons CO2 per ha per crop and country}
read_csv("int_data/LUC_CO2_crops.csv") %>%  #read in kg co2/ha carbon loss for crops for all countries; need to filter to just countries included
  select(crop = id, country = ADMIN, co2_ha = tot_H) %>%  #filter to just Houghton loss ratio of 25%
  mutate(country = recode(country, "Republic of the Congo" = "Congo", "Ivory Coast" = "Côte d’Ivoire" , "eSwatini" = "Eswatini")) %>% #change country names to match FAO names
  filter(country %in% africa_scenario_countries, #filter to just countries included
         !crop %in% c("bean", "coff")) %>%  #remove bean & coffee since not matched w/ FOFA and fao data and so not used in analysis
  select(crop, Country = country, co2_ha) %>% #select just crops, country, and kg Co2/ha
  mutate(co2_ha = co2_ha / 1000,  #convert to metric tons Co2/ha
        crop = recode(crop, !!!crop_full_names)) %>% #replace crop names w/full names
  pivot_wider(names_from = crop, values_from = co2_ha) %>% #pivot to have 1 column per crop
  mutate(across(-Country, ~round(., digits = decimals))) %>% #round values
  arrange(Country) %>%  # order country column alphabetically and write to csv
  write_csv("results/tables/tableS2_tons_co2_ha_by_crop_and_country.csv")
```

```{r Table S3 African countries and regional classifications}
#remove Mauritius from scenario country list since not in LUC CO2 data 
africa_scenario_countries <- africa_scenario_countries[africa_scenario_countries!="Mauritius"]

#list unique countries in each region
tibble(
  Region = c("Middle Africa", "Eastern Africa", "Northern Africa", "Southern Africa", "Western Africa"),
  Countries = c(paste(C_Afr[C_Afr %in% africa_scenario_countries], collapse = ", "), 
                paste(E_Afr[E_Afr %in% africa_scenario_countries], collapse = ", "), 
                paste(N_Afr[N_Afr %in% africa_scenario_countries], collapse = ", "), 
                paste(S_Afr[S_Afr %in% africa_scenario_countries], collapse = ", "), 
                paste(W_Afr[W_Afr %in% africa_scenario_countries], collapse = ", ")
                )) %>% 
  write_csv("results/tables/tableS3_african_countries_and_regions.csv")
```

```{r Table S4. LUC and total input emissions by scenario and region}
fig_dat %>% 
  mutate(region = recode(region, "Middle" = "Middle Africa", "Eastern" = "Eastern Africa", "Northern" = "Northern Africa", "Southern" = "Southern Africa", "Western" = "Western Africa")) %>%  #change to full names for regions
  filter(source %in% c(luc_scenario_included, "tot_emiss")) %>% #filter to just LUC and total input emissions
  select(-lwr, -upr, -luc) %>% #remove upper and lower bounds
  pivot_wider(names_from = source, values_from = fit) %>% #pivot to have 1 column per source
  mutate(`Total (Mt CO2e)` = get(luc_scenario_included) + tot_emiss) %>% #add total emissions column
  rename(Scenario = scenario, Region = region, `LUC (Mt CO2e)` = luc_scenario_included, `Input Use (Mt CO2e)` = tot_emiss) %>%  #rename columns for presentation
  arrange(Scenario, Region) %>%   #arder by scenario order, and regions alphabetically within
  mutate(across(-c(Scenario, Region), ~round(., digits = decimals))) %>% #round values
  write_csv("results/tables/tableS4_LUC_and_total_input_emissions_by_scenario_and_region.csv")
```

```{r Table S5. Synthetic Nitrogen Fertilizer Application Rate per scenario and region}
reg_fe_results %>% 
  mutate(region = recode(region, "Middle" = "Middle Africa", "Eastern" = "Eastern Africa", "Northern" = "Northern Africa", "Southern" = "Southern Africa", "Western" = "Western Africa")) %>%  #change to full names for regions
  filter(dep_var=="fert_use_ha", region!="Africa") %>% #filter to just synthetic nitrogen fertilizer application rate, and exclude Africa total
  select(-lwr, -upr) %>% #remove upper and lower bounds
  pivot_wider(names_from = dep_var, values_from = fit) %>% #pivot to have 1 column per source
  rename(Scenario = scenario, Region = region, `Synthetic Fertilizer Application (kg N/ha)` = fert_use_ha) %>%  #rename columns for presentation
  arrange(Scenario, Region) %>% #order by scenario order, and regions alphabetically within
  mutate(across(-c(Scenario, Region), ~round(., digits = decimals))) %>% #round values
  write_csv("results/tables/tableS5_synthetic_nitrogen_fertilizer_application_rate_by_scenario_and_region.csv")
#kg N synthetic fertilizer per ha
```

```{r Table S6. Pesticide Application Rate per scenario and region}
reg_fe_results %>% 
  mutate(region = recode(region, "Middle" = "Middle Africa", "Eastern" = "Eastern Africa", "Northern" = "Northern Africa", "Southern" = "Southern Africa", "Western" = "Western Africa")) %>%  #change to full names for regions
  filter(dep_var=="p_ha", region!="Africa") %>% #filter to just pesticide fertilizer application rate, and exclude Africa total
  select(-lwr, -upr) %>% #remove upper and lower bounds
  pivot_wider(names_from = dep_var, values_from = fit) %>% #pivot to have 1 column per source
  mutate(p_ha=p_ha*1000) %>%  #convert tons/ha to kg/ha
  rename(Scenario = scenario, Region = region, `Pesticide Application (kg/ha)` = p_ha) %>%  #rename columns for presentation
  arrange(Scenario, Region) %>% #order by scenario order, and regions alphabetically within
  mutate(across(-c(Scenario, Region), ~round(., digits = decimals))) %>% #round values
  write_csv("results/tables/tableS6_pesticide_application_rate_by_scenario_and_region.csv")
#output is in kg pesticide per hectare
```

```{r Table S7. Region and AFrica Model slopes and intercepts}
#RETURN TO UPDATE w/ new africa estimates
#generate table with the slope coefficient and intercept from each of the region-based regression models
tibble(
  `Emission Source` = c("Synthetic N application", "Manufacturing fertilizers", "Manufacturing pesticides", "On-farm fuel energy", "Machinery energy"),
  `Slope (b1)` = c(fert_emiss_ols$coefficients[2], fert_m_emiss_ols$coefficients[2], pest_emiss_ols$coefficients[2], en_emiss_ols$coefficients[2], m_emiss_ols$coefficients[2]),
  `Intercept (b0)` = c(fert_emiss_ols$coefficients[1], fert_m_emiss_ols$coefficients[1], pest_emiss_ols$coefficients[1], en_emiss_ols$coefficients[1], m_emiss_ols$coefficients[1])) %>%
  mutate(across(-`Emission Source`, ~round(., digits = decimals))) %>% #round values
  write_csv("results/tables/tableS7a_region_model_slopes_and_intercepts.csv")

#generate table with the slope coefficient and intercept from the regression models with AFrica data aggregated
tibble(
  `Emission Source` = c("Synthetic N application", "Manufacturing fertilizers", "Manufacturing pesticides", "On-farm fuel energy", "Machinery energy"),
  `Slope (b1)` = c(afr_fert_emiss_ols$coefficients[2], afr_fert_m_emiss_ols$coefficients[2], afr_pest_emiss_ols$coefficients[2], afr_en_emiss_ols$coefficients[2], afr_m_emiss_ols$coefficients[2]),
  `Intercept (b0)` = c(afr_fert_emiss_ols$coefficients[1], afr_fert_m_emiss_ols$coefficients[1], afr_pest_emiss_ols$coefficients[1], afr_en_emiss_ols$coefficients[1], afr_m_emiss_ols$coefficients[1])) %>%
  mutate(across(-`Emission Source`, ~round(., digits = decimals))) %>% #round values
  write_csv("results/tables/tableS7b_africa_model_slopes_and_intercepts.csv")
```

```{r Table S8. Fixed effects for each African Region in the regression models}
#generate table with the fixed effects for each region in the regression models
tibble(
  `Emission Source` = c("Synthetic N application", "Manufacturing fertilizers", "Manufacturing pesticides", "On-farm fuel energy", "Machinery energy"),
  `Middle Africa` = c(fert_emiss_ols$coefficients["factor(country)Middle"], fert_m_emiss_ols$coefficients["factor(country)Middle"], pest_emiss_ols$coefficients["factor(country)Middle"], en_emiss_ols$coefficients["factor(country)Middle"], m_emiss_ols$coefficients["factor(country)Middle"]),
  `Eastern Africa` = c(fert_emiss_ols$coefficients["factor(country)Eastern"], fert_m_emiss_ols$coefficients["factor(country)Eastern"], pest_emiss_ols$coefficients["factor(country)Eastern"], en_emiss_ols$coefficients["factor(country)Eastern"], m_emiss_ols$coefficients["factor(country)Eastern"]),
  `Northern Africa` = c(fert_emiss_ols$coefficients["factor(country)Northern"], fert_m_emiss_ols$coefficients["factor(country)Northern"], pest_emiss_ols$coefficients["factor(country)Northern"], en_emiss_ols$coefficients["factor(country)Northern"], m_emiss_ols$coefficients["factor(country)Northern"]),
  `Southern Africa` = c(fert_emiss_ols$coefficients["factor(country)Southern"], fert_m_emiss_ols$coefficients["factor(country)Southern"], pest_emiss_ols$coefficients["factor(country)Southern"], en_emiss_ols$coefficients["factor(country)Southern"], m_emiss_ols$coefficients["factor(country)Southern"]),
  `Western Africa` = c(fert_emiss_ols$coefficients["factor(country)Western"], fert_m_emiss_ols$coefficients["factor(country)Western"], pest_emiss_ols$coefficients["factor(country)Western"], en_emiss_ols$coefficients["factor(country)Western"], m_emiss_ols$coefficients["factor(country)Western"])) %>%
  mutate(across(-`Emission Source`, ~round(., digits = decimals))) %>% #round values
  write_csv("results/tables/tableS8_region_model_fixed_effects.csv")
```

```{r Table S9. LUC (ha) by crop}
#generate table with the LUC (ha) by crop
read_csv("int_data/luc_co2_country_crop.csv") %>%  #read in kg co2/ha carbon loss for crops for all countries; need to filter to just countries included
  select(Crop = Item, CountryName, scenario, luc, c_loss_ratio) %>%  
  mutate(CountryName = recode(CountryName, "Republic of the Congo" = "Congo", "Ivory Coast" = "Côte d’Ivoire" , "eSwatini" = "Eswatini")) %>% #change country names to match FAO names
  filter(CountryName %in% africa_scenario_countries,  #filter to just countries included
         c_loss_ratio == c_loss_selected) %>% #filter to c_loss_ratio used
  group_by(Crop, scenario) %>% summarize(sum_luc = sum(luc)) %>% #summarize to get total LUC for each crop)
  mutate(sum_luc = sum_luc/1000000) %>% #convert to million ha
  pivot_wider(names_from = scenario, values_from = sum_luc) %>% #pivot to wide format
  mutate(Crop = recode(Crop, !!!crop_full_names)) %>% #replace crop names w/full names
  select(Crop, "Baseline"=b, "Projected"=p, "High"=h) %>% #rename cols for presentation and change order of scenarios
  mutate(across(where(is.numeric), round, digits = decimals)) %>%  # Adjust the number of digits as needed
  write_csv("results/tables/tableS9_LUC_mha_by_crop.csv")
```

```{r Table S10. Carbon dioxide loss per hectare by crop for all countries combined}
c_to_co2 <- 44/12 #conversion factor from carbon to CO2

#create aggregated dataframe with average carbon value across all countries included in regression analysis, for each crop. this value represents the total difference in carbon between native vegetation and the crop, not the annual value
read_csv("int_data/LUC_CO2_crops.csv") %>% #read in country-crop level values of total LUC, total soil carbon loss, total veg loss, and avg. crop c stocks
  select(crop = id, country = ADMIN, soilsum, vegsum, lucsum, cstock, co2_ha = tot_H) %>%  #filter to just Houghton loss ratio of 25%
  mutate(country = recode(country, "Republic of the Congo" = "Congo", "Ivory Coast" = "Côte d’Ivoire" , "eSwatini" = "Eswatini")) %>% #change country names to match FAO names
  filter(is.na(cstock)==F,  #remove crops with missing crop carbon data
         !crop %in% c("bean", "coff"), #remove bean & coffee since not matched w/ FOFA and fao data and so not used in analysis
         country %in% africa_scenario_countries) %>% #remove countries not included in regression analysis
  group_by(crop) %>% #group by crop
  summarise(soilH = sum(soilsum, na.rm = TRUE)/sum(lucsum, na.rm = TRUE)  * c_to_co2 *  .25, #calculate total tons CO2e lost
            soilS = sum(soilsum, na.rm = TRUE)/sum(lucsum, na.rm = TRUE)  * c_to_co2 *  .4,
            veg = (sum(vegsum, na.rm = TRUE)/sum(lucsum, na.rm = TRUE) - mean(cstock))  * c_to_co2
  ) %>% 
  mutate(`LUC (t CO2e/ha)` = get(paste0("soil",c_loss_selected)) + veg,  #calculate total carbon loss from LUC with selected C loss ratio
         crop = recode(crop, !!!crop_full_names)) %>% #replace crop names w/full names
  select(Crop=crop, `LUC (t CO2e/ha)`) %>%  #select only crop and LUC columns
  mutate(across(where(is.numeric), round, digits = decimals)) %>%  # Adjust the number of digits as needed
  write_csv("results/tables/tableS10_tCO2_per_ha_loss_by_crop_for_included_countries.csv")
```

```{r Table S11. LUC (million ha) by region and scenario}
luc_co2_region %>% select(Region = region, scenario, c_loss_ratio, luc) %>% 
  filter(c_loss_ratio == c_loss_selected) %>% 
  mutate(luc = luc / 1000000) %>% #convert to million ha
  pivot_wider(names_from = scenario, values_from = luc) %>% #pivot to wide format
  select(Region, Baseline, Projected, High) %>%  #select and reorder columns
  mutate(across(where(is.numeric), round, digits = decimals)) %>%  # Adjust the number of digits as needed
  write_csv("results/tables/tableS11_LUC_mha_by_region.csv")
```

```{r Table S12. Sensitivity analysis: LUC and total input emissions by scenario and region, under linear model}
#generate table with the sensitivity analysis results for LUC and total input emissions by scenario and region, under linear model
reg_linear_afr_results %>% 
  filter(c_loss_ratio == c_loss_selected, estimate == "fit") %>% 
  select(Region = region, Scenario = scenario, `LUC emissions (Mt CO2e)` = luc_co2_high, `Total input emissions (Mt CO2e)` = tot_emiss, `Total emissions (Mt CO2e)` = tot_co2_high) %>% 
  mutate(Scenario = factor(Scenario, levels = c("Baseline", "Projected", "High"))) %>% arrange(Scenario) %>% #reorder scenario column
  mutate(across(where(is.numeric), round, digits = decimals)) %>%  # Adjust the number of digits as needed
  write_csv("results/tables/tableS12_LUC_and_total_input_emissions_mha_by_region_linear_model.csv")
```

```{r Table S13. Sensitivity analysis: LUC and total input emissions by scenario and region, data filtered to >=1990}
afr_1990_results %>% 
  filter(c_loss_ratio == c_loss_selected, estimate == "fit") %>% 
  select(Region = region, Scenario = scenario, `LUC emissions (Mt CO2e)` = luc_co2_high, `Total input emissions (Mt CO2e)` = tot_emiss, `Total emissions (Mt CO2e)` = tot_co2_high) %>% 
  mutate(Scenario = factor(Scenario, levels = c("Baseline", "Projected", "High"))) %>% arrange(Scenario) %>% #reorder scenario column
  mutate(across(where(is.numeric), round, digits = decimals)) %>%  # Adjust the number of digits as needed
  write_csv("results/tables/tableS13_LUC_and_total_input_emissions_mha_by_region_post1990.csv")
```
