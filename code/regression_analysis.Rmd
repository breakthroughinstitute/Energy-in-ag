---
title: "Regression Analysis for Emissions Predictions"
authors: "Saloni Shah, Dan Blaustein-Rejto "
date: "originally started 11/06/2020; last modified 1/24/2024"
output: html_document
---
#SETUP
```{r Load packages}
library(zoo)
library(sandwich)
library(plm)
library(lmtest)
library(jtools) 
library(ggstance)
library(tidyverse)
library(janitor)
library(naniar)
library(wesanderson)
library(grid);library(sysfonts);library(showtext)
```

```{r Read in Data}
#pesticide use
pest_use <- read_csv("raw_data/faostat/pest_use.csv") %>% select(Country = Area, Year, pest_use = Value)
#units: tonnes use in country inc. all herbicides, insecticide, fungicide etc. timeframe: 1990-2020

#on-farm energy use emissions - converting to CO2e and subtracting fisheries energy emissions from total on-farm energy emissions
energy_emiss <- read_csv("raw_data/faostat/energy_use_emissions.csv") %>% 
  select(-Domain, -Unit) %>% #remove to avoid creating extra rows when pivoting since Units missing when value is NA
  pivot_wider(names_from = Element, values_from = Value) %>% 
  mutate(tot_co2e = (`Emissions (CH4)`*28) + (`Emissions (N2O)`*265) + `Emissions (CO2)`) %>%  # calculate total energy emissions, multiplying by AR5 GWP values FAO uses
  select(Country = Area, Year, tot_co2e, Item) %>%
  pivot_wider(names_from = Item, values_from = tot_co2e) %>% 
  mutate(en_emiss = ifelse(is.na(`Total Energy`), NA, `Total Energy` - coalesce(`Energy used in fishery`, 0)),#calculate farm emissions as total - fishery, ensuring that the result is not NA just because Energy used in fishery is 
         en_emiss = ifelse(en_emiss<0,NA,en_emiss)) %>%  #replace negative values w/ NA
  select(Country, Year, en_emiss)
#units: kilotonnes (i.e. gigagram) CO2e.  timeframe: 1970-2020

#on-farm diesel use, used to estimate emissions embodied in machinery
##we subtract out gas-diesel use in fisheries since FAO metadata says that the gas-diesel oil values  includes fisheries, then multiply by 40% to estimate embodied machinery energy, per Woods et al. (2010) https://royalsocietypublishing.org/doi/full/10.1098/rstb.2010.0172
m_energy <- read_csv("raw_data/faostat/diesel_use.csv") %>% 
  select(Country = Area, Year, Item, Value) %>% 
  pivot_wider(names_from = Item, values_from = Value) %>% 
  mutate(m_energy = (`Gas-Diesel oil` -coalesce(`Gas-diesel oils used in fisheries`, 0)) * 0.4,
         m_energy = ifelse(m_energy<0,NA,m_energy)) %>%  #replace negative values w/ NA 
  select(Country, Year, m_energy)
#units: Terajoules. #timeframe 1970-2020

#fertilizer application emissions
fert_emiss <- read_csv("raw_data/faostat/fert_use_emissions.csv") %>% select(Country = Area, Year, fert_emiss = Value)
#units: kilotonnes (i.e. gigagram) CO2e, using AR5 GWP. timeframe: 1961-2020

#synthetic fertilizer use and use per ha cropland
fert_use_per_ha <- read_csv("raw_data/faostat/fert_use_per_ha_cropland.csv") %>% select(Country = Area, Year, fert_use_ha = Value)
#N use per ha of cropland. units: kg nutrient N/ha timeframe: 1961-2020

fert_use <- read_csv("raw_data/faostat/fert_use.csv") %>% select(Country = Area, Year, fert_use = Value) %>% mutate(fert_use= fert_use*1000)
#N agricultural use. units: convert from original units of tonnes N to kg N. timeframe: 1961-2020

#Yield and Cropland Data from calculate_calories_per_cropland.Rmd
prod <- read_csv("int_data/prod.cropland.csv")

#scenarios for regression analysis
scenarios <- read_csv("int_data/scenarios.csv") %>%  #yields are in kcal/ha
  mutate(region = recode(region, E_Afr = "Eastern", C_Afr = "Middle", S_Afr = "Southern", N_Afr = "Northern", W_Afr = "Western")) %>%   #Convert country names in scenarios to East, West, Central, South, North
  dplyr::rename(country=region) %>%  #rename column to match with variable name used to fit regression
  mutate(scenario = factor(scenario, levels = c("b", "p", "h"), labels = c("Baseline", "Projected", "High")))
```

```{r Calculate total fuel emissions, calculate emissions per ha for each input }
#join datasets
reg <- full_join(energy_emiss, fert_emiss) %>% full_join(fert_use) %>% full_join(fert_use_per_ha) %>%full_join(pest_use) %>% full_join(m_energy) %>% full_join(prod, by =  c("Country" = "country", "Year" = "year"))

#Fill in missing data for each column by country. Apply the last one carried forward method to each column in the dataframe (called reg below), grouping by country so that if the first observation is NA, the function doesn't replace with observation from different country. Will not fill in data for previous years.
reg <- reg %>% group_by(Country) %>% arrange(Country, Year) %>% fill(en_emiss:cropland)

#Calculate each emissions or input use per ha 
reg$en_emiss_ha <-reg$en_emiss/reg$cropland #units are gigagrams CO2e/ha of cropland (not harvested area)
reg$p_ha <- reg$pest_use/reg$cropland #units are tons applied/ha of cropland
reg$fert_emiss_ha <- reg$fert_emiss/reg$cropland#units are gigagrams CO2e/ha of cropland
reg$m_energy_ha <- reg$m_energy/reg$cropland#units are Terajoules/ha of cropland

#calculate yield
reg$yield <-  reg$tot_kcal/reg$cropland #units are kilocal/ha of cropland 
```

```{r Clean Data }
reg <-  clean_names(reg)  #makes all names lower case

#Determine if all yield values are non-zero
sum(reg$tot_kcal ==  0, na.rm=T) #none zero
sum(reg$cropland ==  0, na.rm=T) #none zero

#check for duplicate rows
get_dupes(reg, country, year) # no duplicates found

#count fuel emissions per ha, pesticide, and synthetic N observations by country
reg %>% group_by(country) %>% summarize(count = sum(is.na(en_emiss_ha)==FALSE)) 
reg %>% group_by(country) %>% summarize(count = sum(is.na(p_ha)==FALSE))
reg %>% group_by(country) %>% summarize(count = sum(is.na(fert_emiss_ha)==FALSE))
#results indicate different number of obs per country, an unbalanced panel dataset

#Convert 0's to NA's  - Not likely that a country has 0 fertilizer or fuel use if production and cropland  values are all non-zero. Likely that the "0" is missing data. These false 0's might influence regression estimates. All 0's will be converted to NAs and the regression will automatically eliminate all NAs. 
reg <- naniar::replace_with_na_all(data = reg, condition = ~.x == 0)

# #Graph data to inspect for outliers
# boxplot(reg$fert_use_ha)
# boxplot(reg$p_ha) #visual representation of data points and outliers. #values are generally within 0.137 tons P/ha maximum (from World Bank) ; 5698 values are NA
# plot(reg$yield, reg$en_emiss_ha) #there are some values for which yields are low but fuel emissions per ha is above 0.010 Gg/ha, values that are higher than 0.5 Gg/ha are nearly all from Singapore. Others that are above 0.15 include Bermuda, Hong Kong, and Kuwait.
# boxplot(reg$en_emiss_ha) #429 outliers
# plot(reg$yield, reg$m_energy_ha)  #outliers with values > 1 primarily Singapore, China Hong Kong, Kuwait
# plot(reg$yield, reg$fert_emiss_ha) #some high values have low yields, but values are substantially more clustered (w/ less extreme outliers) than for fert_use_ha, p_ha, en_emiss_ha, and m_energy_ha. 2012 values are NA, values are lower in magnitude 
# boxplot(reg$fert_emiss_ha)
# ggplot(reg) + geom_density(aes(fert_emiss_ha))

#remove countries with many substantial and unexplainable outlier values
outlier_en_countries <- reg %>% filter(en_emiss_ha>=0.15) %>% distinct(country) %>% pull() 
outlier_p_countries <- reg %>% filter(p_ha>=0.1) %>% distinct(country) %>% pull() 
outlier_m_countries <- reg %>% filter(m_energy_ha>=1.0) %>% distinct(country) %>% pull() 
reg <- reg %>% filter(!country %in% c(outlier_en_countries, outlier_p_countries, outlier_m_countries))
```

```{r Aggregate African countries data by region} 
#Subset by regions
#Member countries within each region are from the UN Statistics division : https://unstats.un.org/unsd/methodology/m49/overview/
country_groupings <- readxl::read_excel("raw_data/UNSD — Methodology.xlsx")

Africa <- country_groupings %>% filter(`Region Name`=="Africa") %>% select(`Country or Area`) %>% arrange(`Country or Area`) %>% pull()
W_Afr <- country_groupings %>% filter(`Intermediate Region Name`=="Western Africa") %>% select(`Country or Area`) %>% arrange(`Country or Area`) %>% pull()
E_Afr <- country_groupings %>% filter(`Intermediate Region Name`=="Eastern Africa") %>% select(`Country or Area`) %>% arrange(`Country or Area`) %>% pull()
C_Afr <- country_groupings %>% filter(`Intermediate Region Name`=="Middle Africa") %>% select(`Country or Area`) %>% arrange(`Country or Area`) %>% pull()
S_Afr <- country_groupings %>% filter(`Intermediate Region Name`=="Southern Africa") %>% select(`Country or Area`) %>% arrange(`Country or Area`) %>% pull()
N_Afr <- country_groupings %>% filter(`Sub-region Name`=="Northern Africa") %>% select(`Country or Area`) %>% arrange(`Country or Area`) %>% pull()

#define countries in Africa without matching names in faostat data in order to make names consistent for joining
Africa[which(!Africa %in% unique(reg$country))]

#match all possible, based on manual examination of faostat countries.  non-matching ones aren't listed separately in faostat
reg$country <- recode(reg$country, "Côte d'Ivoire"="Côte d’Ivoire")

#create new column with names as factors to revise
reg <- mutate(reg, Country_rename = country)

# add region name for countries in african regions AND in list of africa countries included in FOFA. this ensures that later regressions are conducted such that the fixed effect for a region only includes countries that are in the region for which predictions are being made (i.e. FOFA projections for northern africa exclude libya)
africa_scenario_countries <- read.csv(file = "int_data/countries_included_in_africa.csv")[,2]
reg$Country_rename[reg$Country_rename %in% E_Afr & reg$country %in% africa_scenario_countries] <-  "E_Afr"
reg$Country_rename[reg$Country_rename %in% W_Afr & reg$country %in% africa_scenario_countries] <-  "W_Afr"
reg$Country_rename[reg$Country_rename %in% C_Afr & reg$country %in% africa_scenario_countries] <-  "C_Afr"
reg$Country_rename[reg$Country_rename %in% S_Afr & reg$country %in% africa_scenario_countries] <-  "S_Afr"
reg$Country_rename[reg$Country_rename %in% N_Afr & reg$country %in% africa_scenario_countries] <-  "N_Afr"

aggregate_reg <- function(region_data, region_name){
  output <- region_data %>% select(year,cropland, tot_kcal, en_emiss, fert_use, pest_use, fert_emiss, m_energy) %>% 
  group_by(year) %>%
  summarise_all(sum, na.rm= TRUE) #sum total values across region by year
  
  #calculate per hectare values
  output <- output %>% mutate(yield = tot_kcal/cropland, en_emiss_ha = en_emiss/cropland, p_ha = pest_use/cropland, fert_emiss_ha = fert_emiss/cropland, fert_use_ha = fert_use/cropland, m_energy_ha = m_energy/cropland, country = region_name)
  
  return(output)
}

# #filter data by region
reg_E <- dplyr::filter(reg,reg$Country_rename == "E_Afr" )
reg_W <- dplyr::filter(reg,reg$Country_rename == "W_Afr" )
reg_C <- dplyr::filter(reg,reg$Country_rename == "C_Afr" )
reg_S <- dplyr::filter(reg,reg$Country_rename == "S_Afr" )
reg_N <- dplyr::filter(reg,reg$Country_rename == "N_Afr" )

reg_E_aggregate <- aggregate_reg(reg_E, "Eastern")
reg_W_aggregate <- aggregate_reg(reg_W, "Western")
reg_C_aggregate <- aggregate_reg(reg_C, "Middle")
reg_S_aggregate <- aggregate_reg(reg_S, "Southern")
reg_N_aggregate <- aggregate_reg(reg_N, "Northern")
```

```{r Load in other countries' data and join it with African regions data}
#Filter out Africa data, keep non-Africa data 
reg_other_country <- reg %>% filter(!Country_rename %in% c("N_Afr", "C_Afr", "S_Afr","E_Afr","W_Afr")) %>% select(-Country_rename)

#Join Africa data with all of the countries' (non Africa) data
reg_all_countries <- bind_rows(reg_other_country, reg_C_aggregate, reg_E_aggregate, reg_S_aggregate, reg_W_aggregate, reg_N_aggregate)
```

```{r Explore data and remove outliers}

#OLS model includes country fixed effect to reduce bias

reg_all_countries <- naniar::replace_with_na_all(data = reg_all_countries, condition = ~.x == 0) #Make sure all 0's are converted to NAs, lm function automatically removes data with NAs 

# #Outlier detection is based on yield values, could extend to the other inputs 
# summary(reg_all_countries$yield)
# boxplot(reg_all_countries$yield)
# hist(reg_all_countries$yield,
#   xlab = "yield",
#   main = "Histogram of yield",
#   breaks = sqrt(nrow(reg_all_countries))) # set number of bins
# #Barbados, Kuwait, Belgium, Martinque occupy many of the highest values
# #higher than ~2*10^7 is an outlier based on historgram and barplot
# sum(reg_all_countries$yield >= 20000000, na.rm=T) #32 entries
# sum(reg_all_countries$yield >= 20000000, na.rm=T)/nrow(reg_all_countries) #~.5% of total entries
filter_reg <- filter(reg_all_countries, reg_all_countries$yield < 20000000)
write_csv(filter_reg %>% select(country, year, cropland, en_emiss_ha, p_ha, fert_emiss_ha, m_energy_ha, yield), "int_data/reg_dat_outliers_removed.csv")
```

#Regression Code
```{r Prep for regression: Convert input use to consistent units of emissions per ha}
#Conversion factors
fert_ef <- 5.66 #5.66 kg CO2 eq/kg product  is the fertilizer EF
pest_ef <- 25.5 # 25.5 kg cO2e/kg applied is the pesticides EF
tpes_ef <- 34 #emissions factor for primary energy supply for Africa (34 tons CO2 eq/Terajoules), carbon intensity of energy mix

kg_to_mt <- 1/10^9 #conversion factor for kg to megatons (million metric tons)
tons_to_mt <- 1/10^6 #conversion factor for metric tons to megatons (million metric tons)
Gg_to_mt <- 1/10^3 #conversion factor for gigatons to megatons (million metric tons)

filter_reg <- filter_reg %>% 
  mutate(en_emiss_ha = en_emiss_ha * Gg_to_mt,#convert gigagrams CO2e emissions from energy use per ha to MMT CO2e emissions from energy use per ha     
         fert_emiss_ha = fert_emiss_ha * Gg_to_mt, #convert gigagrams CO2e emissions from energy use per ha to MMT CO2e emissions from energy use per ha
         fert_m_emiss_ha = fert_use_ha * fert_ef * kg_to_mt, #convert kg fertilizer use/ha to MMT CO2e emissions from fertilizer manufacturing per ha
         m_emiss_ha = m_energy_ha * tpes_ef * tons_to_mt, #convert from Terajoules per ha to MMT CO2e emissions per ha
         pest_emiss_ha = p_ha * pest_ef * tons_to_mt, #convert tons pesticide use/ha to MMT CO2e emissions from pesticide manufacturing per ha
         tot_emiss_ha = en_emiss_ha + fert_emiss_ha + fert_m_emiss_ha + m_emiss_ha + pest_emiss_ha) #total emissions per ha in MMT CO2e
```

```{r Run OLS linear regressions with filtered regression data to estimate relationship between yield and input use factor}
#regressions have country fixed effect where africa regions (e.g. east, west) are used as countries, enabling prediction later

#models for emissions per ha
en_emiss_ols <- lm(filter_reg, formula = log(en_emiss_ha) ~ log(yield) + factor(country)) #Energy Emissions OLS Regression
fert_emiss_ols <- lm(filter_reg, formula = log(fert_emiss_ha) ~ log(yield) + factor(country)) #Synthetic N emissions OLS Regression
fert_m_emiss_ols <- lm(filter_reg, formula = log(fert_m_emiss_ha) ~ log(yield) + factor(country)) #Synthetic N manufacturing emissions OLS Regression
m_emiss_ols <- lm(filter_reg, formula = log(m_emiss_ha) ~ log(yield) + factor(country)) #Energy embodied in machinery OLS Regression
pest_emiss_ols <- lm(filter_reg, formula = log(pest_emiss_ha) ~ log(yield) + factor(country)) #Pesticides manufacturing emissions OLS Regression
tot_emiss_ols <- lm(filter_reg, formula = log(tot_emiss_ha) ~ log(yield) + factor(country)) #Total emissions OLS Regression

#models for input use per ha
p_ols <- lm(filter_reg, formula = log(p_ha) ~ log(yield) + factor(country)) #Pesticides Use OLS regression
fert_use_ols <- lm(filter_reg, formula = log(fert_use_ha) ~ log(yield) + factor(country))#Synthetic N use or application OLS regression
m_energy_ols <- lm(filter_reg, formula = log(m_energy_ha) ~ log(yield) + factor(country))#Energy embodied in machinery OLS regression
```

```{OLS regression with africa data aggregated at continent level}
#fit regression models again with data for african countries and regions aggregated at the continent level. this lets us make continent-level predictions below with proper uncertainty levels
africa_level_reg <- filter_reg %>% mutate(country = recode(country, "Eastern"="Africa", "Western"="Africa","Middle"="Africa","Southern"="Africa","Northern"="Africa")) %>%
                                            group_by(country, year) %>% 
                                            summarize(across(c(en_emiss, fert_emiss, pest_use, fert_use, m_energy, tot_kcal, cropland), sum, na.rm=T)) %>%
                                            mutate(yield = tot_kcal/cropland, 
                                                   en_emiss_ha = en_emiss * Gg_to_mt/cropland, #convert to consistent emissions values, as in above chunk
                                                   fert_emiss_ha = fert_emiss * Gg_to_mt/cropland, 
                                                   fert_m_emiss_ha = fert_use * fert_ef * kg_to_mt/cropland, 
                                                   m_emiss_ha = m_energy * tpes_ef * tons_to_mt/cropland,
                                                   pest_emiss_ha = pest_use * pest_ef * tons_to_mt /cropland,
                                                   tot_emiss_ha = en_emiss_ha + fert_emiss_ha + fert_m_emiss_ha + m_emiss_ha + pest_emiss_ha,
                                                   p_ha = pest_use/cropland, #calculate africa-wide input use per hectare
                                                   fert_use_ha = fert_use/cropland)

africa_level_reg <- naniar::replace_with_na_all(data = africa_level_reg, condition = ~.x == 0) #replace 0s with NA 

#models for emissions per ha
afr_en_emiss_ols <- lm(africa_level_reg, formula = log(en_emiss_ha) ~ log(yield) + factor(country)) #Energy Emissions OLS Regression
afr_fert_emiss_ols <- lm(africa_level_reg, formula = log(fert_emiss_ha) ~ log(yield) + factor(country)) #Synthetic N emissions OLS Regression
afr_fert_m_emiss_ols <- lm(africa_level_reg, formula = log(fert_m_emiss_ha) ~ log(yield) + factor(country)) #Synthetic N manufacturing emissions OLS Regression
afr_m_emiss_ols <- lm(africa_level_reg, formula = log(m_emiss_ha) ~ log(yield) + factor(country)) #Energy embodied in machinery OLS Regression
afr_pest_emiss_ols <- lm(africa_level_reg, formula = log(pest_emiss_ha) ~ log(yield) + factor(country)) #Pesticides manufacturing emissions OLS Regression
afr_tot_emiss_ols <- lm(africa_level_reg, formula = log(tot_emiss_ha) ~ log(yield) + factor(country)) #Total emissions OLS Regression

#models for input use per ha
afr_p_ols <- lm(africa_level_reg, formula = log(p_ha) ~ log(yield) + factor(country)) #Pesticides Use OLS regression
afr_fert_use_ols <- lm(africa_level_reg, formula = log(fert_use_ha) ~ log(yield) + factor(country))#Synthetic N use or application OLS regression
```

```{r Sanity Check on parameters - optional for running}
#Check to see that that the model fitted values match the log(actual values) in the regression dataset, values should fall around 1:1 line

# plot(x = log(na.omit(filter_reg$p_ha)), y = p_ols$fitted.values, xlab = "True values", ylab = "Model Fitted values", main = "Regression fits of pesticide/ha values")
# abline(b=1, a=0) #values fall around this 1:1 line
# 
# plot(x = log(na.omit(filter_reg$en_emiss_ha)), y = fuel_ols$fitted.values, xlab = "True values", ylab = "Model Fitted values", main = "Regression fits of fuel/ha values")
#  abline(b=1, a=0) #values fall around this 1:1 line
# 
# plot(x = log(na.omit(filter_reg$fert_emiss_ha)), y = syn_n_ols$fitted.values, xlab = "True values", ylab = "Model Fitted values", main = "Regression fits of synN/ha values")
# abline(b=1, a=0) #values fall around this 1:1 line
# 
# plot(log(na.omit(filter_reg$fert_use_ha)), fert_use_ols$fitted.values,xlab = "True values", ylab = "Model Fitted values", main = "Regression fits of synN use/ha values"  )
# abline(b=1, a=0) #values fall around this 1:1 line
```
#Generate predictions
```{r Calculate predicted input emissions and use per ha by input, scenario and region}
#create empty dataframe to add in fixed effect regression results
reg_fe_results <- tibble(dep_var=character(), scenario = character(), region = character(), fit=double(), lwr = double(), upr = double())

i=1
#define regions to loop through
regions <- unique(scenarios$country)
regions <- regions[!regions =="Africa"]

#map variables to model names
var_models = tibble(var = c("en_emiss_ha", "fert_emiss_ha", "fert_m_emiss_ha", "m_emiss_ha", "pest_emiss_ha", "tot_emiss_ha", "p_ha", "fert_use_ha"),
                   model = c("en_emiss_ols", "fert_emiss_ols", "fert_m_emiss_ols", "m_emiss_ols", "pest_emiss_ols", "tot_emiss_ols", "p_ols", "fert_use_ols"))

#loop through each dependent variable, scenario, and region to predict each dep variable for each region & scenario
for (dependent_variable in var_models$var) {
  for (scenario in unique(scenarios$scenario)){
    for (region in regions){
      
      reg_fe_results[i,] = c(dependent_variable, 
                            scenario, 
                            region, 
                            as.list(as_vector(predict(get(var_models$model[var_models$var==dependent_variable]), #choose regression model to predict with
              newdata = scenarios[scenarios$country==region & scenarios$scenario==scenario, c("country", "yield")], #add regression estimates
              interval = "confidence", level = 0.95))))
      i=i+1
    }
  }
}

#Add predictions for Africa to above dataframe of predicted input use per ha by input, scenario and region
for (dependent_variable in var_models$var) {
  for (scenario in unique(scenarios$scenario)){
    reg_fe_results[i,] = c(dependent_variable, 
                            scenario, 
                            "Africa", 
                            as.list(as_vector(predict(
                              get(paste0("afr_",var_models$model[var_models$var==dependent_variable])), #choose regression model 
                              newdata = scenarios[scenarios$country=="Africa" & scenarios$scenario==scenario, c("country", "yield")], 
                              interval = "confidence", level = 0.95
                              ))))
    i=i+1
  }
}

#exponentiate estimates and confidence intervals (not SE)
reg_fe_results <- reg_fe_results %>% mutate(fit = exp(fit), lwr = exp(lwr), upr = exp(upr)) 
  
#convert scenario in reg_fe_results to factor variable
reg_fe_results <- reg_fe_results %>% mutate(scenario = factor(scenario, levels = c("Baseline", "Projected", "High")))
```

```{r Calculate total predicted emissions for each input source, region, and scenario}
#create dataframe with only totals for each emissions type and for all input emissions, by region and scenario
region_totals <- reg_fe_results %>% 
  filter(dep_var %in% c("en_emiss_ha", "fert_emiss_ha", "fert_m_emiss_ha", "m_emiss_ha", "pest_emiss_ha", "tot_emiss_ha")) %>% #filter to only emissions variables
  pivot_longer(c(fit, lwr, upr), names_to = "estimate") %>% #make dataframe long
  left_join(scenarios, by = c("region" = "country", "scenario")) %>% #add production scenario variables i.e. yield, area to fe regression results table.
  mutate(total_emiss = value * arable_area) %>%  #calculate total emissions for each input source, region, and scenario, and lower and upper CI.
  select(dep_var, scenario, region, estimate, total_emiss) %>% #select variables of interest
  pivot_wider(names_from = dep_var, values_from = total_emiss)  #make dataframe wide

#rename each emissions type to note that it is total emissions, not emissions per hectare
names(region_totals)[names(region_totals) == "en_emiss_ha"] <- "en_emiss"
names(region_totals)[names(region_totals) == "fert_emiss_ha"] <- "fert_emiss"
names(region_totals)[names(region_totals) == "fert_m_emiss_ha"] <- "fert_m_emiss"
names(region_totals)[names(region_totals) == "m_emiss_ha"] <- "m_emiss"
names(region_totals)[names(region_totals) == "pest_emiss_ha"] <- "pest_emiss"
names(region_totals)[names(region_totals) == "tot_emiss_ha"] <- "tot_emiss"
```

#Add LUC
```{r Add LUC data to input emissions data}
region_key <- c(C_Afr="Middle", E_Afr="Eastern", N_Afr = "Northern", S_Afr="Southern", W_Afr="Western")

convert_luc_co2 <- function(x){return(x * kg_to_mt/38)} # convert to million metric ton and divide by 38, the number of years between 2012 and 2050, this division annualizes the emissions

luc_co2_region <- read_csv("int_data/luc_co2_region.csv") %>%  #read in kg CO2e from LUC by region and scenario, with low values calculated allowing for negative LUC for crops (i.e. restoration) and high values setting all negative LUC to 0.
  mutate(region = recode(region, !!!region_key)) %>%  #rename regions for joining
  rename(luc_co2_low = co2_low, luc_co2_high=co2_high) %>%  #clarify column names
  mutate(across(c(luc_co2_low, luc_co2_high), convert_luc_co2), #convert to MMT CO2/yr
         scenario = factor(scenario, levels = c("b", "p", "h"), labels = c("Baseline", "Projected", "High"))) #make scenario a factor to join below w/ other data

#add rows to luc_co2_region that is the total across regions for each scenario and c_loss_ratio
luc_co2_region <- luc_co2_region %>% 
  bind_rows(luc_co2_region %>% 
              group_by(scenario, c_loss_ratio) %>% 
              summarise(luc_co2_low = sum(luc_co2_low), luc_co2_high = sum(luc_co2_high)) %>% 
              ungroup() %>% 
              mutate(region = "Africa"))

all_emiss <- inner_join(region_totals, luc_co2_region, by = c("scenario", "region"), relationship = "many-to-many") %>%  #join input and LUC emissions
  mutate(tot_co2_high = tot_emiss + luc_co2_high, tot_co2_low = tot_emiss + luc_co2_low) #calculate total emissions for low and high LUC approaches

write_csv(all_emiss,"results/all_emiss_region.csv")
```

#Graph results
```{r Set BTI style guide for  graphing}
#define colors
bti_colors <- c("#0d4459", "#00a990", "#d05527", "#a33332",
                "#b381d0",  "#dfb9a6", "#b2b2b1", "#2A2A2A", "#ecc627")

#general plot theme
theme_bti <- function (base_size = 14, base_family = "Helvetica") {
  theme_classic() %+replace% 
    theme(plot.title = element_text(color = "black",  size = 14), 
          strip.text.x = element_text(size = 14),
          strip.background = element_blank(),
          
          #gridlines
          panel.grid.major.y = element_blank(), panel.grid.minor.y = element_blank(), #no grid lines
          panel.grid.major.x = element_blank(), panel.grid.minor.x = element_blank(), #no grid lines
          #background and border
          panel.border = element_blank(), #no plot border
          #panel.background = element_rect(fill = "white"), #white panel background 
          #legend
          legend.position = "bottom", #legend default position is bottom
          legend.key = element_rect(fill = "#FFFFFF00", color = NA), #no border around legend items
          legend.text = element_text(size=10),
          legend.title = element_text(size=10),
          #axes
          axis.line.x = element_line(color="black", size = .5),
          axis.line.y = element_line(color="black", size = .5),
          axis.title.y = element_text(size = 12, angle = 90), 
          axis.title.x = element_text(size = 12), 
          #logo 
          plot.margin = unit(c(0.5, 0.5, 2, 0.5), "lines") # add space for logo
    )
}
```

```{r Set up data for graphing}
c_loss_selected <- "H" #edit to change which soil carbon loss scenario is used for following graphs
luc_scenario_excluded <- "low" #edit to change which LUC scenario is used for following graphs. options are low and high
luc_scenario_included <- "luc_co2_high"

fig_dat <- all_emiss %>% 
  filter(c_loss_ratio == c_loss_selected) %>%
  select(-c_loss_ratio, -paste0("luc_co2_", luc_scenario_excluded), -tot_co2_high, -tot_co2_low) %>% 
  mutate(scenario = factor(scenario, levels = c("Baseline", "Projected", "High"))) %>%  #change order of scenario column
  pivot_longer(cols = c(en_emiss:starts_with("luc_co2")),names_to = "source", values_to = "emiss") %>% #restructure so there is a column for the lwr and upr input emission totals
  pivot_wider(names_from = estimate, values_from = emiss) %>%  #restructure so there is a column for the lwr and upr input emission totalsest)
  mutate(lwr = case_when(source == luc_scenario_included ~ NA_real_, TRUE ~ lwr), #set lwr and upr to NA when source equals "luc_co2_low" or "luc_co2_high" so that error bars are not plotted for LUC emissions
          upr = case_when(source == luc_scenario_included ~ NA_real_, TRUE ~ upr))
```

```{r Fig 1. Total Africa LUC and Input Emissions by Scenario}
#column chart showing total LUC emissions and total input emissions (sum of energy, fertilizer, pesticide, machinery), by scenario
fig1 <- fig_dat %>% 
  filter(source %in% c(luc_scenario_included, "tot_emiss"), region=="Africa") %>% 
  ggplot()+
  geom_col(aes(x = scenario, y = fit, fill = source), position = "dodge") +
  geom_errorbar(aes(x = scenario, ymin = lwr, ymax = upr, group=source), width = 0.2, position = position_dodge(.9))+
  ggtitle("Emissions from input use and LUC by scenario for Africa.") + 
  xlab("Scenarios") + 
  ylab("Greenhouse Gas Emissions (million metric tons CO2e)") + 
  labs(fill = "Emission Source")+  #caption = "95% confidence interval shown only for total input emissions."
  scale_y_continuous(expand = expand_scale(mult = c(0.0, 0.1)))+ #move y origin to plot margin/line
  theme_bti()+
  scale_fill_manual(values = setNames(c(bti_colors[1], bti_colors[2]), c("tot_emiss", luc_scenario_included)), #set colors
                    labels = setNames(c("Manufacturing and Use of Farm Inputs", "Land Use Change"), c("tot_emiss", luc_scenario_included))) #set labels

fig1
ggsave(plot = fig1, filename = "results/graphs/manuscript/fig1.png", width = 6, height = 4, units = "in", dpi = 300)
```

```{r Fig 2. Africa Input Emissions by Scenario and Source}
#column chart showing each source of input emissions for Africa, by scenario
fig2 <- fig_dat %>% 
  filter(!source %in% c(luc_scenario_included, "tot_emiss"), region=="Africa") %>% #filter just to individual inputs
  ggplot()+
  geom_col(aes(x = scenario, y = fit, fill = source), position = "dodge") +
  geom_errorbar(aes(x = scenario, ymin = lwr, ymax = upr, group=source), width = 0.2, position = position_dodge(.9))+
  ggtitle("Emissions from input use by scenario for Africa.") + 
  xlab("Scenarios") + 
  ylab("Greenhouse Gas Emissions (million metric tons CO2e)") + 
  labs(fill = "Emission Source")+  #caption = "95% confidence interval shown only for total input emissions."
  scale_y_continuous(expand = expand_scale(mult = c(0.0, 0.1)))+ #move y origin to plot margin/line
  theme_bti()+
  scale_fill_manual(values=bti_colors, #set colors to bti colors
                    labels = c("On-Farm Energy", "Synthetic N Application", "Synthetic N Manufacturing", "Pesticide Manufacturing", "Machinery Manufacturing")) #set labels

fig2
ggsave(plot = fig2, filename = "results/graphs/manuscript/fig2.png", width = 6, height = 4, units = "in", dpi = 300)
```

```{r Fig S1. Total LUC and Input Emissions by Scenario for each region}
#column chart showing total LUC emissions and total input emissions (sum of energy, fertilizer, pesticide, machinery), by scenario, for each region
figS1 <- fig_dat %>% 
  filter(source %in% c(luc_scenario_included, "tot_emiss"), region!="Africa") %>% 
  ggplot()+
  geom_col(aes(x = scenario, y = fit, fill = source), position = "dodge") +
  geom_errorbar(aes(x = scenario, ymin = lwr, ymax = upr, group=source), width = 0.2, position = position_dodge(.9))+
  ggtitle("Emissions from input use and LUC by scenario for each region.") + 
  xlab("Scenarios") + 
  ylab("Greenhouse Gas Emissions (million metric tons CO2e)") + 
  facet_wrap(~region, scales = "free_y", ncol=3)+
  labs(fill = "Emission Source")+  #caption = "95% confidence interval shown only for total input emissions. "
  scale_y_continuous(expand = expand_scale(mult = c(0.0, 0.1)))+ #move y origin to plot margin/line
  scale_fill_manual(values = setNames(c(bti_colors[1], bti_colors[2]), c("tot_emiss", luc_scenario_included)), #set colors
                     labels = setNames(c("Manufacturing and Use of Farm Inputs", "Land Use Change"), c("tot_emiss", luc_scenario_included)))+ #set labels
  theme_bti() + 
  geom_hline(yintercept = 0, color = "black", linewidth = 1) #add x axis line since doesnt show up for all when facetted

figS1
ggsave(plot = figS1, filename = "results/graphs/supplementary/figs1.png", width = 6, height = 4, units = "in", dpi = 300)
```

```{r Fig S2. Input Emissions by Scenario and Source for each region}
#column chart showing each source of input emissions for each region, by scenario
figS2 <- fig_dat %>% 
  filter(!source %in% c(luc_scenario_included, "tot_emiss"), region!="Africa") %>% 
  ggplot()+
  geom_col(aes(x = scenario, y = fit, fill = source), position = "dodge") +
  geom_errorbar(aes(x = scenario, ymin = lwr, ymax = upr, group=source), width = 0.2, position = position_dodge(.9))+
  ggtitle("Emissions from input use by scenario for each region.") + 
  xlab("Scenarios") + 
  ylab("Greenhouse Gas Emissions (million metric tons CO2e)") + 
  facet_wrap(~region, scales = "free_y", ncol=3)+
  labs(fill = "Emission Source")+  #caption = "95% confidence interval shown."
  scale_y_continuous(expand = expand_scale(mult = c(0.0, 0.1)))+ #move y origin to plot margin/line
  scale_fill_manual(values=bti_colors, #set colors to bti colors
                    labels = c("On-Farm Energy", "Synthetic N Application", "Synthetic N Manufacturing", "Pesticide Manufacturing", "Machinery Manufacturing"))+ #set labels
  theme_bti() + 
  geom_hline(yintercept = 0, color = "black", linewidth = 1) #add x axis line since doesnt show up for all when facetted

figS2
ggsave(plot = figS2, filename = "results/graphs/supplementary/figs2.png", width = 6, height = 4, units = "in", dpi = 300)
```

```{r Fig S3. Rebound Analysis Line Graph}

```

#Create and Export Tables
```{r Table 1. Africa Yield and Harvested Area and Arable Area by Scenario}
scenarios %>% filter(country=="Africa") %>% 
  mutate(yield = round(yield/1000000, digits = 2), #convert to million kcal/ha
         harv_area = round(harv_area/1000000, digits = 2), #convert to million ha
         arable_area = round(arable_area/1000000, digits = 2)) %>% #convert to million ha
  select("Scenario"=scenario, "Yield (million kcal/ha)" = yield, 
         "Harvested Area (million ha)" = harv_area, "Arable Area (million ha)" = arable_area) %>% 
  arrange(Scenario) %>%  #order by scenario order
  write_csv("results/tables/table1_afr_yield_area_by_scenario.csv")
```

```{r Table S1. Yield, Harvested Values for each Scenario and Region}
scenarios %>% 
  mutate(scenario = recode(scenario, "b"="Baseline","p"="Projected", "h"="High"), #rename scenarios for presentation
         country = recode(country, "Middle" = "Middle Africa", "Eastern" = "Eastern Africa", "Northern" = "Northern Africa", "Southern" = "Southern Africa", "Western" = "Western Africa"), #change to full names for regions
         yield = round(yield/1000000, digits = 2), #convert to million kcal/ha
         harv_area = round(harv_area/1000000, digits = 2), #convert to million ha
         arable_area = round(arable_area/1000000, digits = 2)) %>% #convert to million ha
  select("Region"=country, "Scenario"=scenario, "Yield (million kcal/ha)" = yield, 
         "Harvested Area (million ha)" = harv_area, "Arable Area (million ha)" = arable_area) %>%
  arrange(Scenario, Region) %>% #arder by scenario order, and regions alphabetically within
  write_csv("results/tables/tableS1_yield_area_by_scenario_and_region.csv")
```

```{r Table S2. CO2 per ha per crop and country}
read_csv("int_data/LUC_CO2_crops.csv") %>%  #read in kg co2/ha carbon loss for crops for all countries; need to filter to just countries included
  select(crop = id, country = ADMIN, co2_ha = tot_H) %>%  #filter to just Houghton loss ratio of 25%
  mutate(country = recode(country, "Republic of the Congo" = "Congo", "Ivory Coast" = "Côte d’Ivoire" , "eSwatini" = "Eswatini")) %>% #change country names to match FAO names
  filter(country %in% africa_scenario_countries) %>% #filter to just countries included
         #filter to c_loss_ratio used
  select(crop, country, co2_ha) %>% #select just crops, country, and kg Co2/ha
  mutate(co2_ha = co2_ha / 1000) %>%  #convert to metric tons Co2/ha
  pivot_wider(names_from = crop, values_from = co2_ha) %>% #pivot to have 1 column per crop
  write_csv("results/tables/tableS2_tons_co2_ha_by_crop_and_country.csv")
```

```{r Table S3 African countries and regional classifications}
#remove Mauritius from scenario country list since not in LUC CO2 data 
africa_scenario_countries <- africa_scenario_countries[africa_scenario_countries!="Mauritius"]

#list unique countries in each region
tibble(
  Region = c("Middle Africa", "Eastern Africa", "Northern Africa", "Southern Africa", "Western Africa"),
  Countries = c(paste(C_Afr[C_Afr %in% africa_scenario_countries], collapse = ", "), 
                paste(E_Afr[E_Afr %in% africa_scenario_countries], collapse = ", "), 
                paste(N_Afr[N_Afr %in% africa_scenario_countries], collapse = ", "), 
                paste(S_Afr[S_Afr %in% africa_scenario_countries], collapse = ", "), 
                paste(W_Afr[W_Afr %in% africa_scenario_countries], collapse = ", ")
                )) %>% 
  write_csv("results/tables/tableS3_african_countries_and_regions.csv")
```

```{r Table S4. LUC and total input emissions by scenario and region}
fig_dat %>% 
  mutate(region = recode(region, "Middle" = "Middle Africa", "Eastern" = "Eastern Africa", "Northern" = "Northern Africa", "Southern" = "Southern Africa", "Western" = "Western Africa")) %>%  #change to full names for regions
  filter(source %in% c(luc_scenario_included, "tot_emiss")) %>% #filter to just LUC and total input emissions
  select(-lwr, -upr) %>% #remove upper and lower bounds
  pivot_wider(names_from = source, values_from = fit) %>% #pivot to have 1 column per source
  rename(Scenario = scenario, Region = region, LUC = luc_scenario_included, `Input Use` = tot_emiss) %>%  #rename columns for presentation
  arrange(Scenario, Region) %>%   #arder by scenario order, and regions alphabetically within
  write_csv("results/tables/tableS4_LUC_and_total_input_emissions_by_scenario_and_region.csv")
```

```{r Table S5. Synthetic Nitrogen Fertilizer Application Rate per scenario and region}
reg_fe_results %>% 
  mutate(region = recode(region, "Middle" = "Middle Africa", "Eastern" = "Eastern Africa", "Northern" = "Northern Africa", "Southern" = "Southern Africa", "Western" = "Western Africa")) %>%  #change to full names for regions
  filter(dep_var=="fert_use_ha", region!="Africa") %>% #filter to just synthetic nitrogen fertilizer application rate, and exclude Africa total
  select(-lwr, -upr) %>% #remove upper and lower bounds
  pivot_wider(names_from = dep_var, values_from = fit) %>% #pivot to have 1 column per source
  rename(Scenario = scenario, Region = region, `Synthetic Fertilizer Application (kg N/ha)` = fert_use_ha) %>%  #rename columns for presentation
  arrange(Region, Scenario) %>% #order by scenario order, and regions alphabetically within
  write_csv("results/tables/tableS5_synthetic_nitrogen_fertilizer_application_rate_by_scenario_and_region.csv")
#kg N synthetic fertilizer per ha
```

```{r Table S6. Pesticide Application Rate per scenario and region}
reg_fe_results %>% 
  mutate(region = recode(region, "Middle" = "Middle Africa", "Eastern" = "Eastern Africa", "Northern" = "Northern Africa", "Southern" = "Southern Africa", "Western" = "Western Africa")) %>%  #change to full names for regions
  filter(dep_var=="p_ha", region!="Africa") %>% #filter to just pesticide fertilizer application rate, and exclude Africa total
  select(-lwr, -upr) %>% #remove upper and lower bounds
  pivot_wider(names_from = dep_var, values_from = fit) %>% #pivot to have 1 column per source
  mutate(p_ha=p_ha*1000) %>%  #convert tons/ha to kg/ha
  rename(Scenario = scenario, Region = region, `Pesticide Application (kg/ha)` = p_ha) %>%  #rename columns for presentation
  arrange(Region, Scenario) %>% #order by scenario order, and regions alphabetically within
  write_csv("results/tables/tableS6_pesticide_application_rate_by_scenario_and_region.csv")
#output is in kg pesticide per hectare
```

```{r Table S7. Region and AFrica Model slopes and intercepts}
#generate table with the slope coefficient and intercept from each of the region-based regression models
tibble(
  `Emission Source` = c("Synthetic N application", "Manufacturing fertilizers", "Manufacturing pesticides", "On-farm fuel energy", "Machinery energy"),
  `Slope (b1)` = c(fert_emiss_ols$coefficients[2], fert_m_emiss_ols$coefficients[2], pest_emiss_ols$coefficients[2], en_emiss_ols$coefficients[2], m_emiss_ols$coefficients[2]),
  `Intercept (b0)` = c(fert_emiss_ols$coefficients[1], fert_m_emiss_ols$coefficients[1], pest_emiss_ols$coefficients[1], en_emiss_ols$coefficients[1], m_emiss_ols$coefficients[1])) %>%
  write_csv("results/tables/tableS7a_region_model_slopes_and_intercepts.csv")

#generate table with the slope coefficient and intercept from the regression models with AFrica data aggregated
tibble(
  `Emission Source` = c("Synthetic N application", "Manufacturing fertilizers", "Manufacturing pesticides", "On-farm fuel energy", "Machinery energy"),
  `Slope (b1)` = c(afr_fert_emiss_ols$coefficients[2], afr_fert_m_emiss_ols$coefficients[2], afr_pest_emiss_ols$coefficients[2], afr_en_emiss_ols$coefficients[2], afr_m_emiss_ols$coefficients[2]),
  `Intercept (b0)` = c(afr_fert_emiss_ols$coefficients[1], afr_fert_m_emiss_ols$coefficients[1], afr_pest_emiss_ols$coefficients[1], afr_en_emiss_ols$coefficients[1], afr_m_emiss_ols$coefficients[1])) %>%
  write_csv("results/tables/tableS7b_africa_model_slopes_and_intercepts.csv")
```

```{r Table S8. Fixed effects for each African Region in the regression models}
#generate table with the fixed effects for each region in the regression models
tibble(
  `Emission Source` = c("Synthetic N application", "Manufacturing fertilizers", "Manufacturing pesticides", "On-farm fuel energy", "Machinery energy"),
  `Middle Africa` = c(fert_emiss_ols$coefficients["factor(country)Middle"], fert_m_emiss_ols$coefficients["factor(country)Middle"], pest_emiss_ols$coefficients["factor(country)Middle"], en_emiss_ols$coefficients["factor(country)Middle"], m_emiss_ols$coefficients["factor(country)Middle"]),
  `Eastern Africa` = c(fert_emiss_ols$coefficients["factor(country)Eastern"], fert_m_emiss_ols$coefficients["factor(country)Eastern"], pest_emiss_ols$coefficients["factor(country)Eastern"], en_emiss_ols$coefficients["factor(country)Eastern"], m_emiss_ols$coefficients["factor(country)Eastern"]),
  `Northern Africa` = c(fert_emiss_ols$coefficients["factor(country)Northern"], fert_m_emiss_ols$coefficients["factor(country)Northern"], pest_emiss_ols$coefficients["factor(country)Northern"], en_emiss_ols$coefficients["factor(country)Northern"], m_emiss_ols$coefficients["factor(country)Northern"]),
  `Southern Africa` = c(fert_emiss_ols$coefficients["factor(country)Southern"], fert_m_emiss_ols$coefficients["factor(country)Southern"], pest_emiss_ols$coefficients["factor(country)Southern"], en_emiss_ols$coefficients["factor(country)Southern"], m_emiss_ols$coefficients["factor(country)Southern"]),
  `Western Africa` = c(fert_emiss_ols$coefficients["factor(country)Western"], fert_m_emiss_ols$coefficients["factor(country)Western"], pest_emiss_ols$coefficients["factor(country)Western"], en_emiss_ols$coefficients["factor(country)Western"], m_emiss_ols$coefficients["factor(country)Western"])) %>%
  write_csv("results/tables/tableS8_region_model_fixed_effects.csv")
```


#Old Graph and table code
```{r Plot GHG data across Africa's regions and for SSA as a whole}
GHG <- all_emiss #unsure if GHG is meant to be this dataframe. no notes in old script on this or what GHG dataframe is. 
GHG_Afr <- GHG[GHG$Region == "Africa",] #have separate charts for SSA data to compare to region breakdown
GHG <- anti_join(GHG, GHG_Afr)
#GHG_high <- GHG[GHG$Scenario == "High",] #Use High_alt as High
#GHG <- anti_join(GHG,GHG_high)
GHG$Scenario <- factor(GHG$Scenario ,levels = c("Baseline", "Projected", "High_alt")) #Change order of bars so it is not in alphabetical order, but rather in the order of the yield-scenarios
x.axis <- c("Baseline", "Projected", "High")



#percent stacked bar chart by region
GHG$Region <- factor(GHG$Region, levels = c("West", "East", "Southern", "Central", "North"))
GHG$Scenario <- factor(GHG$Scenario ,levels = c("Baseline", "Projected", "High"))
GHG_region <- ggplot(GHG, aes(fill= Region, y= GHG, x= Scenario)) + 
    geom_bar(position="fill", stat="identity") + ggtitle(expression(paste("% Greenhouse emissions by region in Africa for each scenario"))) + xlab("Scenarios") + ylab("% of each scenario's GHG emissions") + labs(fill = "Regions")  + scale_x_discrete(labels= x.axis) +  theme(axis.title.x = element_text(color="black",size=12),axis.title.y = element_text(color="black", size=12) ,panel.background = element_rect(fill = NA),
       panel.grid.major.y = element_line(colour="grey68",linetype="solid"),
       panel.grid.major.x = element_line(colour="grey68",linetype="solid"),axis.ticks.y = element_blank(),axis.ticks.x=element_blank(),
       plot.title = element_text(size=15, face="bold")) 
      # plot.background = element_rect(fill=NA), legend.key=element_rect(fill=NA)
GHG_region <- GHG_region  +  scale_fill_manual(values=wes_palette(n=5, name="Darjeeling1")) 
GHG_region
ggsave(filename = "~/Google Drive/My Drive/Food & Farming/Energy in ag/results/graphs/New Graphs/GHG_region.png", GHG_region) #save ggplot, not great with dimensions, might use current plot window as default plot size and so may need to specify width and height, dims: Saving 7.29 x 4.51 in image


#bar chart by region, grouped
GHG$Region <- factor(GHG$Region, levels = c("West", "East", "Southern", "Central", "North"))
GHG_region_grouped <- ggplot(GHG, aes(fill= Region, y= GHG, x= Scenario)) + 
    geom_bar(position="dodge", stat="identity") + ggtitle(expression(paste("Greenhouse emissions by scenario and region in Africa"))) + xlab("Scenarios") + ylab("GHG Emissions (Gigagtons CO2eq)") + labs(fill = "Regions")  + scale_x_discrete(labels= x.axis) +  theme_bti()

GHG_region_grouped <- GHG_region_grouped  +  scale_fill_manual(values=bti_colors) 
ggsave(filename =  "~/Google Drive/My Drive/Food & Farming/Energy in ag/results/graphs/New Graphs/GHG_region_grouped.png", plot = GHG_region_grouped )
GHG_region_grouped

#Stacked
GHG_region_stacked <- ggplot(GHG, aes(fill= Region, y= GHG, x= Scenario)) + 
    geom_bar(position="stack", stat="identity") + ggtitle(expression(paste("Greenhouse emissions by scenario for each region in Africa"))) + xlab("Scenarios") + ylab("GHG emissions (Gt CO2eq)") + labs(fill = "African regions")  + scale_x_discrete(labels= x.axis) +  theme(axis.title.x = element_text(color="black",size=12),axis.title.y = element_text(color="black", size=12) ,panel.background = element_rect(fill = NA),
       panel.grid.major.y = element_line(colour="grey68",linetype="solid"),
       panel.grid.major.x = element_line(colour="grey68",linetype="solid"),axis.ticks.y = element_blank(),axis.ticks.x=element_blank(),
       plot.title = element_text(size=15, face="bold")) 
      # plot.background = element_rect(fill=NA), legend.key=element_rect(fill=NA)
GHG_region_stacked <- GHG_region  +  scale_fill_manual(values=bti_colors) 
ggsave(filename = "~/Google Drive/My Drive/Food & Farming/Energy in ag/results/graphs/New Graphs/GHG_region_stacked.png", plot = GHG_region_stacked, width = , height = )

# Africa
#GHG_Afr_high <- GHG_SSA[GHG_Afr$Scenario == "High",] #Use High_alt as High
#GHG_Afr <- anti_join(GHG_Afr,GHG_SSA_high)
GHG_Afr$Scenario <- factor(GHG_Afr$Scenario ,levels = c("Baseline", "Projected", "High_alt"))

GHG_Afr_plot <- ggplot(GHG_Afr, aes(y = GHG, x= Scenario)) + 
    geom_bar(position= "stack", stat="identity",fill = "#0DC3A8") + ggtitle(expression(paste("Greenhouse emissions by scenario in Africa"))) + xlab("Scenarios") + ylab("GHG Emissions (Gigatons CO2eq)") + labs(fill = "African regions")  + scale_x_discrete(labels= x.axis) +  theme(axis.title.x = element_text(color="black",size=12),axis.title.y = element_text(color="black", size=12) ,panel.background = element_rect(fill = NA),
       panel.grid.major.y = element_line(colour="grey68",linetype="solid"),
       panel.grid.major.x = element_line(colour="grey68",linetype="solid"),axis.ticks.y = element_blank(),axis.ticks.x=element_blank(),
       plot.title = element_text(size=15, face="bold"))
 ggsave(filename = "~/Google Drive/My Drive/Food & Farming/Energy in ag/results/graphs/New Graphs/GHG_Afr.png", plot = GHG_Afr_plot )   
```

```{r Energy emissions by region }
#Melt data for ggplot
Energy_emis <- melt(Energy_emis)
colnames(Energy_emis) <- c("Energy_Scenario", "Region", "Value")
Energy_emis$Value <- Energy_emis$Value * Gg_to_Gt

#separate scenario from energy source into 2 columns
Energy_emis$Energy_Scenario <- str_replace(Energy_emis$Energy_Scenario, "synN_use", "synNuse") ##change "syn_use_" to synuse to make it easier to separate values into 2 cols
Energy_emis$Energy_Scenario <- str_replace(Energy_emis$Energy_Scenario, "h_alt", "alt")
Energy_emis <- Energy_emis %>% separate(Energy_Scenario, c("Energy Source", "Scenario"), "_")

#Change naming conventions to match that of error bars to making joining easier
Energy_emis$`Energy Source` <- str_replace(Energy_emis$`Energy Source`, "synNuse","Manufacturing Fertilizers")
Energy_emis$`Energy Source` <- str_replace(Energy_emis$`Energy Source`, "pest","Manufacturing Pesticides")
Energy_emis$`Energy Source` <- str_replace(Energy_emis$`Energy Source`, "m","Embodied Energy in Machinery")
Energy_emis$`Energy Source` <- str_replace(Energy_emis$`Energy Source`, "synN","Synthetic N")
Energy_emis$`Energy Source` <- str_replace(Energy_emis$`Energy Source`, "fuel","On-Farm Fuel")

Energy_emis$Scenario <- str_replace(Energy_emis$Scenario, "base","Baseline")
Energy_emis$Scenario <- str_replace(Energy_emis$Scenario, "proj","Projected")
Energy_emis$Scenario <- str_replace(Energy_emis$Scenario, "alt","High")

#Split data by region
Energy_emis_E<- filter(Energy_emis, Region == "East")
Energy_emis_W <- filter(Energy_emis, Region == "West")
Energy_emis_S <- filter(Energy_emis, Region == "Southern")
Energy_emis_C <- filter(Energy_emis, Region == "Central")
Energy_emis_N <- filter(Energy_emis, Region == "North")
Energy_emis_Afr <- filter(Energy_emis, Region == "Africa")
Energy_emis_N$Region <- NULL
Energy_emis_S$Region <- NULL
Energy_emis_W$Region <- NULL
Energy_emis_E$Region <- NULL
Energy_emis_C$Region <- NULL
Energy_emis_Afr$Region <- NULL


```


```{r Energy emissions charts by region }
#Add in upper and lower error bars data for each region and multiply by cropland, emissions & conversions factors if necessary 

#North Africa
colnames(lwr_N) <- c("Energy Source", "Scenario", "lwr")
colnames(upr_N) <- c("Energy Source", "Scenario", "upr")
lwr_N$`Energy Source`<- trimws(lwr_N$`Energy Source`) #eliminate extra spaces in energy source strings
upr_N$`Energy Source`<- trimws(upr_N$`Energy Source`) #eliminate extra spaces in energy source strings
lwr_N$Scenario <- str_replace(lwr_N$Scenario, "High_alt", "High")
upr_N$Scenario <- str_replace(upr_N$Scenario, "High_alt", "High")
lwr_N$Scenario <- as.character(lwr_N$Scenario)
upr_N$Scenario <- as.character(upr_N$Scenario)

#join upper and lower 95% CI values from the model with the estimates of energy emissions by source
Energy_emis_N <- right_join(Energy_emis_N, lwr_N, by = c("Energy Source", "Scenario"))
Energy_emis_N <- right_join(Energy_emis_N, upr_N, by = c("Energy Source", "Scenario"))

#Multiply 95% CI estimates by cropland  
Energy_emis_N$cropland[Energy_emis_N$Scenario == "Baseline"] <- area_b$harv_area[area_b$region == "North"]
Energy_emis_N$cropland[Energy_emis_N$Scenario == "Projected"] <-  area_p$harv_area[area_p$region == "North"]
Energy_emis_N$cropland[Energy_emis_N$Scenario == "High"] <-  area_h_alt$harv_area[area_h_alt$region == "North"]
#Converts upper and lower estimates are in Gigagrams or tons (manufacturing pesticides is in tons)
Energy_emis_N$lwr <- Energy_emis_N$lwr * Energy_emis_N$cropland  
Energy_emis_N$upr <- Energy_emis_N$upr * Energy_emis_N$cropland 

Energy_emis_N$lwr[Energy_emis_N$`Energy Source` == "Manufacturing Fertilizers"] <- Energy_emis_N$lwr[Energy_emis_N$`Energy Source` == "Manufacturing Fertilizers"] * fert_ef  * kg_to_Gg
Energy_emis_N$lwr[Energy_emis_N$`Energy Source` == "Manufacturing Pesticides"] <- Energy_emis_N$lwr[Energy_emis_N$`Energy Source` == "Manufacturing Pesticides"] * pest_ef  * tons_to_Gg
Energy_emis_N$upr[Energy_emis_N$`Energy Source` == "Manufacturing Fertilizers"] <- Energy_emis_N$upr[Energy_emis_N$`Energy Source` == "Manufacturing Fertilizers"] * fert_ef  * kg_to_Gg
Energy_emis_N$upr[Energy_emis_N$`Energy Source` == "Manufacturing Pesticides"] <- Energy_emis_N$upr[Energy_emis_N$`Energy Source` == "Manufacturing Pesticides"] * pest_ef  * tons_to_Gg

#Convert all lower and upper estimates to Gigatons to match the units of the fitted values
Energy_emis_N$lwr <- Energy_emis_N$lwr * Gg_to_Gt
Energy_emis_N$upr <- Energy_emis_N$upr * Gg_to_Gt


#southern Africa
colnames(lwr_S) <- c("Energy Source", "Scenario", "lwr")
colnames(upr_S) <- c("Energy Source", "Scenario", "upr")
lwr_S$`Energy Source` <- trimws(lwr_S$`Energy Source`)
upr_S$`Energy Source` <- trimws(upr_S$`Energy Source`)
lwr_S$Scenario <- str_replace(lwr_S$Scenario , "High_alt", "High")
upr_S$Scenario <- str_replace(upr_S$Scenario , "High_alt", "High")
Energy_emis_S <- right_join(Energy_emis_S, lwr_S, by = c("Energy Source", "Scenario"))
Energy_emis_S <- right_join(Energy_emis_S, upr_S, by = c("Energy Source", "Scenario"))


#Multiply 95% CI estimates by cropland  
Energy_emis_S$cropland[Energy_emis_S$Scenario == "Baseline"] <- area_b$harv_area[area_b$region == "South"]
Energy_emis_S$cropland[Energy_emis_S$Scenario == "Projected"] <-  area_p$harv_area[area_p$region == "South"]
Energy_emis_S$cropland[Energy_emis_S$Scenario == "High"] <-  area_h_alt$harv_area[area_h_alt$region == "South"]
Energy_emis_S$lwr <- Energy_emis_S$lwr * Energy_emis_S$cropland
Energy_emis_S$upr <- Energy_emis_S$upr * Energy_emis_S$cropland

Energy_emis_S$lwr[Energy_emis_S$`Energy Source` == "Manufacturing Fertilizers"] <- Energy_emis_S$lwr[Energy_emis_S$`Energy Source` == "Manufacturing Fertilizers"]  * fert_ef * kg_to_Gg
Energy_emis_S$lwr[Energy_emis_S$`Energy Source` == "Manufacturing Pesticides"] <- Energy_emis_S$lwr[Energy_emis_S$`Energy Source` == "Manufacturing Pesticides"] * pest_ef * tons_to_Gg 
Energy_emis_S$upr[Energy_emis_S$`Energy Source` == "Manufacturing Fertilizers"] <- Energy_emis_S$upr[Energy_emis_S$`Energy Source` == "Manufacturing Fertilizers"]  * fert_ef * kg_to_Gg 
Energy_emis_S$upr[Energy_emis_S$`Energy Source` == "Manufacturing Pesticides"] <- Energy_emis_S$upr[Energy_emis_S$`Energy Source` == "Manufacturing Pesticides"] * pest_ef * tons_to_Gg 

#Convert all lower and upper estimates to Gigatons to match the units of the fitted values
Energy_emis_S$lwr <- Energy_emis_S$lwr * Gg_to_Gt
Energy_emis_S$upr <- Energy_emis_S$upr * Gg_to_Gt

#west Africa
colnames(lwr_W) <- c("Energy Source", "Scenario", "lwr")
colnames(upr_W) <- c("Energy Source", "Scenario", "upr")
lwr_W$`Energy Source` <- trimws(lwr_W$`Energy Source`)
upr_W$`Energy Source` <- trimws(upr_W$`Energy Source`)
lwr_W$Scenario <- str_replace(lwr_W$Scenario , "High_alt", "High")
upr_W$Scenario <- str_replace(upr_W$Scenario , "High_alt", "High")
Energy_emis_W <- right_join(Energy_emis_W, lwr_W, by = c("Energy Source", "Scenario"))
Energy_emis_W <- right_join(Energy_emis_W, upr_W, by = c("Energy Source", "Scenario"))

#Add in lower and upper 95% CI estimates and multiply by cropland to get gigagrams or tons (manufacturing energy sources)
Energy_emis_W$cropland[Energy_emis_W$Scenario == "Baseline"] <- area_b$harv_area[area_b$region == "West"]
Energy_emis_W$cropland[Energy_emis_W$Scenario == "Projected"] <-  area_p$harv_area[area_p$region == "West"]
Energy_emis_W$cropland[Energy_emis_W$Scenario == "High"] <-  area_h_alt$harv_area[area_h_alt$region == "West"]
Energy_emis_W$lwr <- Energy_emis_W$lwr * Energy_emis_W$cropland 
Energy_emis_W$upr <- Energy_emis_W$upr * Energy_emis_W$cropland

#Convert manufacturing fert and pest to Gg 
Energy_emis_W$lwr[Energy_emis_W$`Energy Source` == "Manufacturing Fertilizers"] <- Energy_emis_W$lwr[Energy_emis_W$`Energy Source` == "Manufacturing Fertilizers"] * fert_ef * kg_to_Gg 
Energy_emis_W$lwr[Energy_emis_W$`Energy Source` == "Manufacturing Pesticides"] <- Energy_emis_W$lwr[Energy_emis_W$`Energy Source` == "Manufacturing Pesticides"] * pest_ef * tons_to_Gg
Energy_emis_W$upr[Energy_emis_W$`Energy Source` == "Manufacturing Fertilizers"] <- Energy_emis_W$upr[Energy_emis_W$`Energy Source` == "Manufacturing Fertilizers"] * fert_ef * kg_to_Gg
Energy_emis_W$upr[Energy_emis_W$`Energy Source` == "Manufacturing Pesticides"] <- Energy_emis_W$upr[Energy_emis_W$`Energy Source` == "Manufacturing Pesticides"] * pest_ef * tons_to_Gg 

#Convert all lower and upper estimates to Gigatons to match the units of the fitted values
Energy_emis_W$lwr <- Energy_emis_W$lwr * Gg_to_Gt
Energy_emis_W$upr <- Energy_emis_W$upr * Gg_to_Gt

#east Africa
colnames(lwr_E) <- c("Energy Source", "Scenario", "lwr")
colnames(upr_E) <- c("Energy Source", "Scenario", "upr")
lwr_E$`Energy Source` <- trimws(upr_E$`Energy Source`)
upr_E$`Energy Source` <- trimws(lwr_E$`Energy Source`)
lwr_E$Scenario <- str_replace(lwr_E$Scenario , "High_alt", "High")
upr_E$Scenario <- str_replace(upr_E$Scenario , "High_alt", "High")
Energy_emis_E <- right_join(Energy_emis_E, lwr_E, by = c("Energy Source", "Scenario"))
Energy_emis_E <- right_join(Energy_emis_E, upr_E, by = c("Energy Source", "Scenario"))

#Multiply lower and upper 95% by cropland 
Energy_emis_E$cropland[Energy_emis_E$Scenario == "Baseline"] <- area_b$harv_area[area_b$region == "East"]
Energy_emis_E$cropland[Energy_emis_E$Scenario == "Projected"] <-  area_p$harv_area[area_p$region == "East"]
Energy_emis_E$cropland[Energy_emis_E$Scenario == "High"] <-  area_h_alt$harv_area[area_h_alt$region == "East"]

#Converts upper and lower estimates are in Gigagrams or tons (manufacturing pesticides/fertilizers is in tons)
Energy_emis_E$lwr <- Energy_emis_E$lwr * Energy_emis_E$cropland  
Energy_emis_E$upr <- Energy_emis_E$upr * Energy_emis_E$cropland 

#convert upper and lower estimates to gigagrams for manufacturing emissions
Energy_emis_E$lwr[Energy_emis_E$`Energy Source` == "Manufacturing Fertilizers"] <- Energy_emis_E$lwr[Energy_emis_E$`Energy Source` == "Manufacturing Fertilizers"] * fert_ef * kg_to_Gg
Energy_emis_E$lwr[Energy_emis_E$`Energy Source` == "Manufacturing Pesticides"] <- Energy_emis_E$lwr[Energy_emis_E$`Energy Source` == "Manufacturing Pesticides"] * pest_ef * tons_to_Gg #Did not multiply by pest_ef 
Energy_emis_E$upr[Energy_emis_E$`Energy Source` == "Manufacturing Fertilizers"] <- Energy_emis_E$upr[Energy_emis_E$`Energy Source` == "Manufacturing Fertilizers"] * fert_ef * kg_to_Gg
Energy_emis_E$upr[Energy_emis_E$`Energy Source` == "Manufacturing Pesticides"] <- Energy_emis_E$upr[Energy_emis_E$`Energy Source` == "Manufacturing Pesticides"] * pest_ef *  tons_to_Gg

#Convert all lower and upper estimates to Gigatons to match the units of the fitted values
Energy_emis_E$lwr <- Energy_emis_E$lwr * Gg_to_Gt
Energy_emis_E$upr <- Energy_emis_E$upr * Gg_to_Gt

#Central Africa
colnames(lwr_C) <- c("Energy Source", "Scenario", "lwr")
colnames(upr_C) <- c("Energy Source", "Scenario", "upr")
lwr_C$`Energy Source` <- trimws(lwr_C$`Energy Source`)
upr_C$`Energy Source` <- trimws(lwr_C$`Energy Source`)
lwr_C$Scenario <- str_replace(lwr_C$Scenario , "High_alt", "High")
upr_C$Scenario <- str_replace(upr_C$Scenario , "High_alt", "High")
Energy_emis_C <- right_join(Energy_emis_C, lwr_C, by = c("Energy Source", "Scenario"))
Energy_emis_C <- right_join(Energy_emis_C, upr_C, by = c("Energy Source", "Scenario"))

Energy_emis_C$cropland[Energy_emis_C$Scenario == "Baseline"] <- area_b$harv_area[area_b$region == "Central"]
Energy_emis_C$cropland[Energy_emis_C$Scenario == "Projected"] <-  area_p$harv_area[area_p$region == "Central"]
Energy_emis_C$cropland[Energy_emis_C$Scenario == "High"] <-  area_h_alt$harv_area[area_h_alt$region == "Central"]
#Converts upper and lower estimates are in Gigagrams or tons (manufacturing pesticides/fertilizers is in tons)
Energy_emis_C$lwr <- Energy_emis_C$lwr * Energy_emis_C$cropland  
Energy_emis_C$upr <- Energy_emis_C$upr * Energy_emis_C$cropland 

#convert upper and lower estimates to gigagrams for manufacturing emissions
Energy_emis_C$lwr[Energy_emis_C$`Energy Source` == "Manufacturing Fertilizers"] <- Energy_emis_C$lwr[Energy_emis_C$`Energy Source` == "Manufacturing Fertilizers"] * fert_ef * kg_to_Gg 
Energy_emis_C$lwr[Energy_emis_C$`Energy Source` == "Manufacturing Pesticides"] <- Energy_emis_C$lwr[Energy_emis_C$`Energy Source` == "Manufacturing Pesticides"] * pest_ef * tons_to_Gg #Did not multiply by pest_ef 
Energy_emis_C$upr[Energy_emis_C$`Energy Source` == "Manufacturing Fertilizers"] <- Energy_emis_C$upr[Energy_emis_C$`Energy Source` == "Manufacturing Fertilizers"] * fert_ef * kg_to_Gg
Energy_emis_C$upr[Energy_emis_C$`Energy Source` == "Manufacturing Pesticides"] <- Energy_emis_C$upr[Energy_emis_C$`Energy Source` == "Manufacturing Pesticides"] * pest_ef *  tons_to_Gg

#Convert all lower and upper estimates to Gigatons to match the units of the fitted values
Energy_emis_C$lwr <- Energy_emis_C$lwr * Gg_to_Gt
Energy_emis_C$upr <- Energy_emis_C$upr * Gg_to_Gt

#Calculate lwr and upr error bounds for Africa
# Energy_emis_E$Scenario <- as.matrix(unlist(Energy_emis_E$Scenario))
# Energy_emis_E$Scenario[is.na(Energy_emis_E$Scenario)] <- "High"
Energy_emis_Afr$MoE <- (Energy_emis_C$Value - Energy_emis_C$lwr)^2 + (Energy_emis_N$Value - Energy_emis_N$lwr)^2 +  (Energy_emis_S$Value - Energy_emis_S$lwr)^2 +  (Energy_emis_W$Value - Energy_emis_W$lwr)^2
                                                                                                                        
Energy_emis_Afr$sqrt_MoE <- sqrt(Energy_emis_Afr$MoE)
Energy_emis_Afr$upr <- Energy_emis_Afr$Value + Energy_emis_Afr$sqrt_MoE
Energy_emis_Afr$lwr <- Energy_emis_Afr$Value - Energy_emis_Afr$sqrt_MoE

#rename inputs

#syn n application
Energy_emis_E$`Energy Source` <- str_replace(Energy_emis_E$`Energy Source` , "Synthetic N", "Synthetic N Application")
Energy_emis_W$`Energy Source` <- str_replace(Energy_emis_W$`Energy Source` , "Synthetic N", "Synthetic N Application")
Energy_emis_S$`Energy Source` <- str_replace(Energy_emis_S$`Energy Source` , "Synthetic N", "Synthetic N Application")
Energy_emis_N$`Energy Source` <- str_replace(Energy_emis_N$`Energy Source` , "Synthetic N", "Synthetic N Application")
Energy_emis_C$`Energy Source` <- str_replace(Energy_emis_C$`Energy Source` , "Synthetic N", "Synthetic N Application")
Energy_emis_Afr$`Energy Source` <- str_replace(Energy_emis_Afr$`Energy Source` , "Synthetic N", "Synthetic N Application")

#fert manufacturing
Energy_emis_E$`Energy Source` <- str_replace(Energy_emis_E$`Energy Source` , "Manufacturing Fertilizers", "Manufacturing Synthetic N Fertilizer")
Energy_emis_W$`Energy Source` <- str_replace(Energy_emis_W$`Energy Source` , "Manufacturing Fertilizers", "Manufacturing Synthetic N Fertilizer")
Energy_emis_S$`Energy Source` <- str_replace(Energy_emis_S$`Energy Source` , "Manufacturing Fertilizers", "Manufacturing Synthetic N Fertilizer")
Energy_emis_N$`Energy Source` <- str_replace(Energy_emis_N$`Energy Source` , "Manufacturing Fertilizers", "Manufacturing Synthetic N Fertilizer")
Energy_emis_C$`Energy Source` <- str_replace(Energy_emis_C$`Energy Source` , "Manufacturing Fertilizers", "Manufacturing Synthetic N Fertilizer")
Energy_emis_Afr$`Energy Source` <- str_replace(Energy_emis_Afr$`Energy Source` , "Manufacturing Fertilizers", "Manufacturing Synthetic N Fertilizer")

#machinery
Energy_emis_E$`Energy Source` <- str_replace(Energy_emis_E$`Energy Source` , "Embodied Energy in Machinery", "Manufacturing Machinery")
Energy_emis_W$`Energy Source` <- str_replace(Energy_emis_W$`Energy Source` , "Embodied Energy in Machinery", "Manufacturing Machinery")
Energy_emis_S$`Energy Source` <- str_replace(Energy_emis_S$`Energy Source` , "Embodied Energy in Machinery", "Manufacturing Machinery")
Energy_emis_N$`Energy Source` <- str_replace(Energy_emis_N$`Energy Source` , "Embodied Energy in Machinery", "Manufacturing Machinery")
Energy_emis_C$`Energy Source` <- str_replace(Energy_emis_C$`Energy Source` , "Embodied Energy in Machinery", "Manufacturing Machinery")
Energy_emis_Afr$`Energy Source` <- str_replace(Energy_emis_Afr$`Energy Source` , "Embodied Energy in Machinery", "Manufacturing Machinery")

#change y-axis to megatons and upper and lower error bars
Gt_Mt <- 1000
Energy_emis_E$Value <- Energy_emis_E$Value * Gt_Mt
Energy_emis_W$Value <- Energy_emis_W$Value * Gt_Mt
Energy_emis_S$Value <- Energy_emis_S$Value * Gt_Mt
Energy_emis_C$Value <- Energy_emis_C$Value * Gt_Mt
Energy_emis_N$Value <- Energy_emis_N$Value * Gt_Mt
Energy_emis_Afr$Value <- Energy_emis_Afr$Value * Gt_Mt

#lwr
Energy_emis_E$lwr <- Energy_emis_E$lwr * Gt_Mt
Energy_emis_W$lwr <- Energy_emis_W$lwr * Gt_Mt
Energy_emis_S$lwr <- Energy_emis_S$lwr * Gt_Mt
Energy_emis_C$lwr <- Energy_emis_C$lwr * Gt_Mt
Energy_emis_N$lwr <- Energy_emis_N$lwr * Gt_Mt
Energy_emis_Afr$lwr <- Energy_emis_Afr$lwr * Gt_Mt

#upr
Energy_emis_E$upr <- Energy_emis_E$upr * Gt_Mt
Energy_emis_W$upr <- Energy_emis_W$upr * Gt_Mt
Energy_emis_S$upr <- Energy_emis_S$upr * Gt_Mt
Energy_emis_C$upr <- Energy_emis_C$upr * Gt_Mt
Energy_emis_N$upr <- Energy_emis_N$upr * Gt_Mt
Energy_emis_Afr$upr <- Energy_emis_Afr$upr * Gt_Mt

#Energy graphs by region
#Energy_E_high <- Energy_emis_E[Energy_emis_E$Scenario == "High_alt",] #Use High_alt as High
#Energy_emis_E<- anti_join(Energy_emis_E, Energy_E_high)
Energy_emis_E$Scenario <- factor(Energy_emis_E$Scenario ,levels = c("Baseline", "Projected", "High"))

Energy_E <- ggplot(Energy_emis_E, aes(fill = `Energy Source` , y = Value, x = Scenario)) + 
    geom_bar(position="dodge", stat="identity" ) + ggtitle(expression(paste("East"))) + xlab("Scenario") + ylab("GHG Emissions (Gt CO2 eq)") + labs(fill = "Inputs") + geom_errorbar(aes(ymin = lwr, ymax= upr), width=.2,
                 position=position_dodge(.9))  +  scale_x_discrete(labels= x.axis) +   scale_y_continuous(expand = expand_scale(mult = c(0.0, 0.1))) + theme_bti()
Energy_E <- Energy_E  +  scale_fill_manual(values=bti_colors)
ggsave(filename = "~/Google Drive/My Drive/Food & Farming/Energy in ag/results/graphs/New Graphs/Energy_E.png", plot = Energy_E)  

#West Africa
Energy_emis_W$Scenario <- factor(Energy_emis_W$Scenario ,levels = c("Baseline", "Projected", "High"))

Energy_W <- ggplot(Energy_emis_W, aes(fill = `Energy Source` , y = Value, x = Scenario)) + 
    geom_bar(position="dodge", stat="identity" ) + ggtitle(expression(paste("West"))) + xlab("Scenario") + ylab("GHG Emissions (Gt CO2eq)") + labs(fill = "Inputs") + geom_errorbar(aes(ymin= lwr , ymax= upr), width=0.2,
                 position=position_dodge(.9))  +  scale_x_discrete(labels= x.axis) +   scale_y_continuous(expand = expand_scale(mult = c(0.0, 0.1)))  + theme_bti()
Energy_W <- Energy_W  +  scale_fill_manual(values=bti_colors)
ggsave(filename ="~/Google Drive/My Drive/Food & Farming/Energy in ag/results/graphs/New Graphs/Energy_W.png", plot = Energy_W)  

#Central Africa
Energy_emis_C$Scenario <- factor(Energy_emis_C$Scenario ,levels = c("Baseline", "Projected", "High"))

Energy_C <- ggplot(Energy_emis_C, aes(fill = `Energy Source` , y = Value, x = Scenario)) + 
    geom_bar(position="dodge", stat="identity" ) + ggtitle(expression(paste("Central"))) + xlab("Scenario") + ylab("GHG Emissions (Gt CO2eq)") + labs(fill = "Inputs") + geom_errorbar(aes(ymin= lwr , ymax= upr), width=.2,
                 position=position_dodge(.9))  +  scale_x_discrete(labels= x.axis) +   scale_y_continuous(expand = expand_scale(mult = c(0.0, 0.1))) + theme_bti()
Energy_C <- Energy_C  +  scale_fill_manual(values=bti_colors)
ggsave(filename = "~/Google Drive/My Drive/Food & Farming/Energy in ag/results/graphs/New Graphs/Energy_C.png", plot = Energy_C )  

#Southern Africa
Energy_emis_S$Scenario <- factor(Energy_emis_S$Scenario ,levels = c("Baseline", "Projected", "High"))

Energy_S <- ggplot(Energy_emis_S, aes(fill = `Energy Source` , y = Value, x = Scenario)) + 
    geom_bar(position="dodge", stat="identity" ) + ggtitle(expression(paste("Southern"))) + xlab("Scenario") + ylab("GHG Emissions (Gt CO2eq)") + labs(fill = "Inputs") + geom_errorbar(aes(ymin= lwr , ymax= upr), width=.2,
                 position=position_dodge(.9))  +  scale_x_discrete(labels= x.axis) +   scale_y_continuous(expand = expand_scale(mult = c(0.0, 0.1))) + theme_bti()
Energy_S <- Energy_S  +  scale_fill_manual(values= bti_colors)
ggsave(filename = "~/Google Drive/My Drive/Food & Farming/Energy in ag/results/graphs/New Graphs/Energy_S.png", plot = Energy_S, width = , height = )  


#North Africa
Energy_emis_N$Scenario <- factor(Energy_emis_N$Scenario ,levels = c("Baseline", "Projected", "High"))

Energy_N <- ggplot(Energy_emis_N, aes(fill = `Energy Source` , y = Value, x = Scenario))  +  geom_bar(position="dodge", stat="identity" ) + ggtitle(expression(paste("North")))  + xlab("Scenario") + ylab("GHG Emissions (Gt CO2eq)") + labs(fill = "Inputs") + geom_errorbar(aes(ymin= lwr , ymax= upr), width=.2,
                 position=position_dodge(.9))  +  scale_x_discrete(labels= x.axis) +  scale_y_continuous(expand = expand_scale(mult = c(0.0, 0.1))) + theme_bti()
Energy_N <- Energy_N  +  scale_fill_manual(values= bti_colors)
ggsave(filename = "~/Google Drive/My Drive/Food & Farming/Energy in ag/results/graphs/New Graphs/Energy_N.png", plot = Energy_N)  

#Africa
Energy_emis_Afr$Scenario <- factor(Energy_emis_Afr$Scenario ,levels = c("Baseline", "Projected", "High"))

Energy_Afr <- ggplot(Energy_emis_Afr, aes(fill = `Energy Source` , y = Value, x = Scenario))  +  geom_bar(position="dodge", stat="identity" ) + ggtitle(expression(paste("Africa")))  + xlab("Scenario") + ylab("GHG Emissions (Gt CO2eq)") + labs(fill = "Inputs") + geom_errorbar(aes(ymin= lwr , ymax= upr), width=.2,
                 position=position_dodge(.9))  +  scale_x_discrete(labels= x.axis) + scale_y_continuous(expand = expand_scale(mult = c(0.0, 0.1))) + theme_bti()
Energy_Afr <- Energy_Afr  +  scale_fill_manual(values= bti_colors)
ggsave(filename = "~/Google Drive/My Drive/Food & Farming/Energy in ag/results/graphs/New Graphs/Energy_N.png", plot = Energy_Afr) 


#total Energy graphs with all regions included except SSA (no error bars)
Energy_emis_all <- Energy_emis %>% group_by(Scenario, Region) %>% summarize(sum(Value)) 
Energy_emis_Afr_all <- Energy_emis_all[Energy_emis_all$Region == "Africa",]
Energy_emis_all <- anti_join(Energy_emis_all,Energy_emis_Afr_all )
Energy_emis_all$Scenario <- factor(Energy_emis_all$Scenario ,levels = c("Baseline", "Projected", "High"))

Energy_emis_all_reg <- ggplot(Energy_emis_all, aes(fill = Region , y = `sum(Value)`, x = Scenario)) + 
    geom_bar(position="dodge", stat="identity" ) + ggtitle(expression(paste("Energy Input Use Emissions by Region"))) + xlab("Scenario") + ylab("GHG Emissions (Gt CO2eq)") + labs(fill = "Region") + theme_bti()
Energy_emis_all_reg <- Energy_emis_all_reg +  scale_fill_manual(values= bti_colors)
ggsave(filename = "~/Google Drive File Stream/My Drive/Food & Farming/Energy in ag/results/graphs/New Graphs/Energy_all_reg.png", plot = Energy_emis_all_reg, width = , height = )

#Create a figure that has all of the energy source by region grafs displayed
Energy_N <- Energy_N + ggtitle("") + ylab("") + xlab("") +  theme_bti() 
Energy_S <- Energy_S + ggtitle("") + ylab("") + xlab("") + theme_bti() 
Energy_W <- Energy_W + ggtitle("") + ylab("") + xlab("") +  theme_bti() 
Energy_E <- Energy_E + ggtitle("") + ylab("") + xlab("") + theme_bti()  
Energy_C <- Energy_C + ggtitle("") + ylab("") + xlab("") +  theme_bti() 
Energy_Afr <-  Energy_Afr + ggtitle("") + ylab("") + xlab("") + theme_bti()  

library(ggpubr)
energy_region_grafs <- ggarrange(Energy_N, Energy_S, Energy_W, Energy_E, Energy_C, Energy_Afr, labels = c("North", "Southern","West","East", "Central", "Africa"),font.label = list(size = 12, face = "plain", color = "black", family = NULL), common.legend = TRUE, legend = "bottom")


# Annotate the figure by adding a common labels
energy_region_grafs <- annotate_figure(energy_region_grafs,
                top = text_grob("Emissions from Input Use by Region", color = "black" , size = 12),
                left = text_grob("GHG Emissions (Mt CO2eq)", color = "black", rot = 90))
                
                #fig.lab = "Figure 1", fig.lab.face = "bold")
ggsave(filename = "results/graphs/supplementary/s2_all_input_emiss_by_region.png", plot = energy_region_grafs, width = , height = )


#Total Energy emissions error bars, and with LUC emis for each region 

#add in lwr and upr bounds for Energy emissions
Energy_emis_E$MoE <- Energy_emis_E$Value - Energy_emis_E$lwr
Energy_emis_C$MoE <- Energy_emis_C$Value - Energy_emis_C$lwr
Energy_emis_S$MoE <- Energy_emis_S$Value - Energy_emis_S$lwr
Energy_emis_N$MoE <- Energy_emis_N$Value - Energy_emis_N$lwr
Energy_emis_W$MoE <- Energy_emis_W$Value - Energy_emis_W$lwr

Energy_emis_E$MoE2 <- Energy_emis_E$MoE^2
Energy_emis_C$MoE2 <- Energy_emis_C$MoE^2
Energy_emis_W$MoE2 <- Energy_emis_W$MoE^2
Energy_emis_N$MoE2 <- Energy_emis_N$MoE^2
Energy_emis_W$MoE2 <- Energy_emis_W$MoE^2

# En <- as.data.frame(matrix(0, ncol = ncol(tot_E) + 1, nrow = nrow(tot_E)))
# En[1,] <- tot_E %>% filter(Region == "East", Scenario == "Baseline") %>% mutate( SS = with(Energy_emis_E,sum(MoE2[Scenario == "Baseline"])))
# En[2,] <- tot_E %>% filter(Region == "East", Scenario == "Projected") %>% mutate( SS = with(Energy_emis_E,sum(MoE2[Scenario == "Projected"])))
# En[3,] <- tot_E %>% filter(Region == "East", Scenario == "High") %>% mutate( SS = with(Energy_emis_E,sum(MoE2[Scenario == "High"])))
# En[4,] <- tot_E %>% filter(Region == "West", Scenario == "Baseline") %>% mutate( SS = with(Energy_emis_E,sum(MoE2[Scenario == "Baseline"])))
# En[5,] <- tot_E %>% filter(Region == "West", Scenario == "Projected") %>% mutate( SS = with(Energy_emis_E,sum(MoE2[Scenario == "Projected"])))
# En[6,] <- tot_E %>% filter(Region == "West", Scenario == "High") %>% mutate( SS = with(Energy_emis_E,sum(MoE2[Scenario == "High"])))
# En[7,] <- tot_E %>% filter(Region == "Southern", Scenario == "Baseline") %>% mutate( SS = with(Energy_emis_E,sum(MoE2[Scenario == "Baseline"])))
# En[8,] <- tot_E %>% filter(Region == "Southern", Scenario == "Projected") %>% mutate( SS = with(Energy_emis_E,sum(MoE2[Scenario == "Projected"])))
# En[9,] <- tot_E %>% filter(Region == "Southern", Scenario == "High") %>% mutate( SS = with(Energy_emis_E,sum(MoE2[Scenario == "High"])))
# En[10,] <- tot_E %>% filter(Region == "Central", Scenario == "Baseline") %>% mutate( SS = with(Energy_emis_E,sum(MoE2[Scenario == "Baseline"])))
# En[11,] <- tot_E %>% filter(Region == "Central", Scenario == "Projected") %>% mutate( SS = with(Energy_emis_E,sum(MoE2[Scenario == "Projected"])))
# En[12,] <- tot_E %>% filter(Region == "Central", Scenario == "High") %>% mutate( SS = with(Energy_emis_E,sum(MoE2[Scenario == "High"])))
# En[13,] <- tot_E %>% filter(Region == "North", Scenario == "Baseline") %>% mutate( SS = with(Energy_emis_E,sum(MoE2[Scenario == "Baseline"])))
# En[14,] <- tot_E %>% filter(Region == "North", Scenario == "Projected") %>% mutate( SS = with(Energy_emis_E,sum(MoE2[Scenario == "Projected"])))
# En[15,] <- tot_E %>% filter(Region == "North", Scenario == "High") %>% mutate( SS = with(Energy_emis_E,sum(MoE2[Scenario == "High"])))
# En[16,] <- tot_E %>% filter(Region == "Africa", Scenario == "Baseline") %>% mutate( SS = with(Energy_emis_E,sum(MoE2[Scenario == "Baseline"])))
# En[17,] <- tot_E %>% filter(Region == "Africa", Scenario == "Projected") %>% mutate( SS = with(Energy_emis_E,sum(MoE2[Scenario == "Projected"])))
# En[18,] <- tot_E %>% filter(Region == "Africa", Scenario == "High") %>% mutate( SS = with(Energy_emis_E,sum(MoE2[Scenario == "High"])))                          
# colnames(En) <- c("Scenario", "Region", "Energy", "SummedSqs")
# En$SS_sqrt <- sqrt(En$SummedSqs)
# En$upr <- En$Energy + En$SS_sqrt
# En$lwr <- En$Energy - En$SS_sqrt
# En$Energy <- En$Energy * Gg_to_Gt * Gt_Mt
# En$upr <- En$upr  * Gg_to_Gt * Gt_Mt
# En$lwr <- En$lwr  * Gg_to_Gt * Gt_Mt
# En$Scenario <- ifelse(En$Scenario == 1, "Baseline", ifelse(En$Scenario == 3, "Projected", ifelse(En$Scenario == 2, "High", NA)))
#
#convert to megatons
tot_E$Energy <- tot_E$Energy * Gg_to_Gt * Gt_Mt
#new lwr and upr bounds for tot_e
En2 <- as.data.frame(matrix(0, ncol = ncol(tot_E) + 1, nrow = nrow(tot_E)))
En2[1,] <-  tot_E %>% filter(Region == "East", Scenario == "Baseline") %>% mutate(lwr_new = with(Energy_emis_E,sum(lwr[Scenario == "Baseline"])))
En2[2,] <- tot_E %>% filter(Region == "East", Scenario == "Projected") %>% mutate( lwr_new = with(Energy_emis_E,sum(lwr[Scenario == "Projected"])))
En2[3,] <- tot_E %>% filter(Region == "East", Scenario == "High") %>% mutate(lwr_new = with(Energy_emis_E,sum(lwr[Scenario == "High"])))
En2[4,] <- tot_E %>% filter(Region == "West", Scenario == "Baseline") %>% mutate(lwr_new = with(Energy_emis_W,sum(lwr[Scenario == "Baseline"])))
En2[5,] <- tot_E %>% filter(Region == "West", Scenario == "Projected") %>% mutate(lwr_new = with(Energy_emis_W,sum(lwr[Scenario == "Projected"])))
En2[6,] <- tot_E %>% filter(Region == "West", Scenario == "High") %>% mutate(lwr_new = with(Energy_emis_W,sum(lwr[Scenario == "High"])))
En2[7,] <- tot_E %>% filter(Region == "Southern", Scenario == "Baseline") %>% mutate(lwr_new = with(Energy_emis_S,sum(lwr[Scenario == "Baseline"])))
En2[8,] <- tot_E %>% filter(Region == "Southern", Scenario == "Projected") %>% mutate(lwr_new = with(Energy_emis_S,sum(lwr[Scenario == "Projected"])))
En2[9,] <- tot_E %>% filter(Region == "Southern", Scenario == "High") %>% mutate(lwr_new = with(Energy_emis_S,sum(lwr[Scenario == "High"])))
En2[10,] <- tot_E %>% filter(Region == "Central", Scenario == "Baseline") %>% mutate(lwr_new = with(Energy_emis_C,sum(lwr[Scenario == "Baseline"])))
En2[11,] <- tot_E %>% filter(Region == "Central", Scenario == "Projected") %>% mutate(lwr_new = with(Energy_emis_C,sum(lwr[Scenario == "Projected"])))
En2[12,] <- tot_E %>% filter(Region == "Central", Scenario == "High") %>% mutate(lwr_new = with(Energy_emis_C,sum(lwr[Scenario == "High"])))
En2[13,] <- tot_E %>% filter(Region == "North", Scenario == "Baseline") %>% mutate(lwr_new = with(Energy_emis_N,sum(lwr[Scenario == "Baseline"])))
En2[14,] <- tot_E %>% filter(Region == "North", Scenario == "Projected") %>% mutate(lwr_new = with(Energy_emis_N,sum(lwr[Scenario == "Projected"])))
En2[15,] <- tot_E %>% filter(Region == "North", Scenario == "High") %>% mutate( lwr_new = with(Energy_emis_N,sum(lwr[Scenario == "High"])))
En2[16,] <- tot_E %>% filter(Region == "Africa", Scenario == "Baseline") %>% mutate(lwr_new = with(Energy_emis_Afr,sum(lwr[Scenario == "Baseline"])))
En2[17,] <- tot_E %>% filter(Region == "Africa", Scenario == "Projected") %>% mutate(lwr_new = with(Energy_emis_Afr,sum(lwr[Scenario == "Projected"])))
En2[18,] <- tot_E %>% filter(Region == "Africa", Scenario == "High") %>% mutate(lwr_new = with(Energy_emis_Afr,sum(lwr[Scenario == "High"])))
colnames(En2) <- c("Scenario", "Region", "value", "upr", "lwr","variable" , "lwr_new")
En2$Scenario <- ifelse(En2$Scenario == 1, "Baseline", ifelse(En2$Scenario == 3, "Projected", ifelse(En2$Scenario == 2, "High", NA)))

 #merge lwr and upr bounds with tot_E data
 tot_E <- merge(tot_E, En)
 tot_E$SummedSqs <- NULL
#tot_E$SS_sqrt <- NULL
tot_E$variable <- "Energy"
 colnames(tot_E) <- c("Scenario" , "Region"  ,"value" ,  "upr" , "lwr" ,  "variable")
 LUC_Afr_regions$variable <- "LUC"
 colnames(LUC_Afr_regions) <- c("Region" , "Scenario"  ,"value", "variable")
 LUC_Afr_regions$value <- (LUC_Afr_regions$value * kg_to_Gg *Gg_to_Gt)/380
 GHG <- full_join(tot_E, LUC_Afr_regions)
 GHG[GHG$upr == 0] <- NA
 
tot_E$Scenario <- as.character(unlist(tot_E$Scenario))
upr_new <- as.data.frame(matrix(0, nrow = nrow(tot_E), ncol = ncol(tot_E) + 1))
upr_new[1,] <- tot_E %>% filter(Region == "East", Scenario == "Baseline") %>% mutate(upr_new = with(Energy_emis_E,sum(upr[Scenario == "Baseline"])))
upr_new[2,] <- tot_E %>% filter(Region == "East", Scenario == "Projected") %>% mutate( upr_new = with(Energy_emis_E,sum(upr[Scenario == "Projected"])))
upr_new[3,] <- tot_E %>% filter(Region == "East", Scenario == "High") %>% mutate(upr_new = with(Energy_emis_E,sum(upr[Scenario == "High"])))
upr_new[4,] <- tot_E %>% filter(Region == "West", Scenario == "Baseline") %>% mutate(upr_new = with(Energy_emis_W,sum(upr[Scenario == "Baseline"])))
upr_new[5,] <- tot_E %>% filter(Region == "West", Scenario == "Projected") %>% mutate(upr_new = with(Energy_emis_W,sum(upr[Scenario == "Projected"])))
upr_new[6,] <- tot_E %>% filter(Region == "West", Scenario == "High") %>% mutate(upr_new = with(Energy_emis_W,sum(upr[Scenario == "High"])))
upr_new[7,] <- tot_E %>% filter(Region == "Southern", Scenario == "Baseline") %>% mutate(upr_new = with(Energy_emis_S,sum(upr[Scenario == "Baseline"])))
upr_new[8,] <- tot_E %>% filter(Region == "Southern", Scenario == "Projected") %>% mutate(upr_new = with(Energy_emis_S,sum(upr[Scenario == "Projected"])))
upr_new[9,] <- tot_E %>% filter(Region == "Southern", Scenario == "High") %>% mutate(upr_new = with(Energy_emis_S,sum(upr[Scenario == "High"])))
upr_new[10,] <- tot_E %>% filter(Region == "Central", Scenario == "Baseline") %>% mutate(upr_new = with(Energy_emis_C,sum(upr[Scenario == "Baseline"])))
upr_new[11,] <- tot_E %>% filter(Region == "Central", Scenario == "Projected") %>% mutate(upr_new = with(Energy_emis_C,sum(upr[Scenario == "Projected"])))
upr_new[12,] <- tot_E %>% filter(Region == "Central", Scenario == "High") %>% mutate(upr_new = with(Energy_emis_C,sum(upr[Scenario == "High"])))
upr_new[13,] <- tot_E %>% filter(Region == "North", Scenario == "Baseline") %>% mutate(upr_new = with(Energy_emis_N,sum(upr[Scenario == "Baseline"])))
upr_new[14,] <- tot_E %>% filter(Region == "North", Scenario == "Projected") %>% mutate(upr_new = with(Energy_emis_N,sum(upr[Scenario == "Projected"])))
upr_new[15,] <- tot_E %>% filter(Region == "North", Scenario == "High") %>% mutate( upr_new = with(Energy_emis_N,sum(upr[Scenario == "High"])))
upr_new[16,] <- tot_E %>% filter(Region == "Africa", Scenario == "Baseline") %>% mutate(upr_new = with(Energy_emis_Afr,sum(upr[Scenario == "Baseline"])))
upr_new[17,] <- tot_E %>% filter(Region == "Africa", Scenario == "Projected") %>% mutate(upr_new = with(Energy_emis_Afr,sum(upr[Scenario == "Projected"])))
upr_new[18,] <- tot_E %>% filter(Region == "Africa", Scenario == "High") %>% mutate(upr_new = with(Energy_emis_Afr,sum(upr[Scenario == "High"])))
colnames(upr_new) <-  c("Scenario", "Region", "value", "upr", "lwr","variable" , "upr_new")
En2 <- merge(En2, upr_new)
tot_E <- merge(tot_E, En2)  
LUC_Afr_regions$value  <- LUC_Afr_regions$value * Gt_Mt
GHG <- full_join(tot_E, LUC_Afr_regions)

#Energy_LUC_GHG <- Energy_LUC[Energy_LUC$variable == "GHG",] #exclude total GHG emissions, units are gigatons
#Energy_LUC_GHG  <- anti_join(Energy_LUC , Energy_LUC_GHG )
Energy_LUC_E <- filter(GHG, Region == "East")
Energy_LUC_W <- filter(GHG, Region == "West")
Energy_LUC_C <- filter(GHG, Region == "Central")
Energy_LUC_S <- filter(GHG, Region == "Southern")
Energy_LUC_N <- filter(GHG, Region == "North")
Energy_LUC_Afr <- filter(GHG, Region == "Africa")
Energy_LUC_Afr$variable <- str_replace(Energy_LUC_Afr$variable, "Energy", "Inputs")
Energy_LUC_E$variable <- str_replace(Energy_LUC_E$variable, "Energy", "Inputs")
Energy_LUC_W$variable <- str_replace(Energy_LUC_W$variable, "Energy", "Inputs")
Energy_LUC_C$variable <- str_replace(Energy_LUC_C$variable, "Energy", "Inputs")
Energy_LUC_S$variable <- str_replace(Energy_LUC_S$variable, "Energy", "Inputs")
Energy_LUC_N$variable <- str_replace(Energy_LUC_N$variable, "Energy", "Inputs")

#Graph Energy + LUC graphs
#East
Energy_LUC_E$Scenario <- factor(Energy_LUC_E$Scenario,levels = c("Baseline", "Projected", "High"))
Energy_LUC_E_plot <- ggplot(Energy_LUC_E , aes(fill = variable , y = value , x= Scenario)) + 
    geom_bar(position="dodge", stat="identity") + xlab("") + ylab("") + labs(fill = "Emissions Type") + scale_x_discrete(labels= x.axis) + scale_y_continuous(expand = expand_scale(mult = c(0.0, 0.1))) +  geom_errorbar(aes(ymin= lwr_new , ymax= upr_new), width=.2, position=position_dodge(.9)) + theme_bti()
Energy_LUC_E_plot <- Energy_LUC_E_plot  +  scale_fill_manual(values= bti_colors) 
#West
Energy_LUC_W$Scenario <- factor(Energy_LUC_W$Scenario,levels = c("Baseline", "Projected", "High"))
Energy_LUC_W_plot <- ggplot(Energy_LUC_W , aes(fill = variable , y = value , x= Scenario)) + 
    geom_bar(position="dodge", stat="identity") + xlab("") + ylab("") + labs(fill = "Emissions Type") +  geom_errorbar(aes(ymin= Energy_LUC_W$lwr_new, ymax= Energy_LUC_W$upr_new), width=.2, position=position_dodge(.9))  + scale_x_discrete(labels= x.axis)  + scale_y_continuous(expand = expand_scale(mult = c(0.0, 0.1))) + theme_bti() 
Energy_LUC_W_plot <- Energy_LUC_W_plot  +  scale_fill_manual(values= bti_colors) 

Energy_LUC_S$Scenario <- factor(Energy_LUC_S$Scenario,levels = c("Baseline", "Projected", "High"))
Energy_LUC_S_plot <- ggplot(Energy_LUC_S , aes(fill = variable , y = value , x= Scenario)) + 
    geom_bar(position="dodge", stat="identity") + xlab("") + ylab("") + labs(fill = "Emissions Type") +  geom_errorbar(aes(ymin= lwr_new, ymax= upr_new), width= 0.2, position=position_dodge(0.9)) + scale_x_discrete(labels= x.axis) + scale_y_continuous(expand = expand_scale(mult = c(0.0, 0.1))) +  theme_bti() 
Energy_LUC_S_plot <- Energy_LUC_S_plot  +  scale_fill_manual(values= bti_colors) 

Energy_LUC_N$Scenario <- factor(Energy_LUC_N$Scenario,levels = c("Baseline", "Projected", "High"))
Energy_LUC_N_plot <- ggplot(Energy_LUC_N, aes(fill = variable , y = value , x= Scenario)) + 
    geom_bar(position="dodge", stat="identity") + xlab("") + ylab("") + labs(fill = "Emissions Type") + geom_errorbar(aes(ymin= Energy_LUC_N$lwr_new, ymax= Energy_LUC_N$upr_new), width =0.2, position = position_dodge(0.9))  + scale_x_discrete(labels= x.axis) + scale_y_continuous(expand = expand_scale(mult = c(0.0, 0.1))) +  theme_bti()  
Energy_LUC_N_plot <- Energy_LUC_N_plot  +  scale_fill_manual(values= bti_colors) 

Energy_LUC_C$Scenario <- factor(Energy_LUC_C$Scenario,levels = c("Baseline", "Projected", "High"))
Energy_LUC_C_plot <- ggplot(Energy_LUC_C , aes(fill = variable , y = value , x= Scenario)) + 
    geom_bar(position="dodge", stat="identity") + xlab("") + ylab("") + labs(fill = "Emissions Type") + geom_errorbar(aes(ymin= lwr_new, ymax= upr_new), width = 0.2, position = position_dodge(0.9))  + scale_x_discrete(labels= x.axis) + scale_y_continuous(expand = expand_scale(mult = c(0.0, 0.1))) +  theme_bti() 
Energy_LUC_C_plot <- Energy_LUC_C_plot  +  scale_fill_manual(values= bti_colors) 

#Africa
Energy_LUC_Afr$lwr_new <- Energy_LUC_Afr$lwr_new  * Gt_Mt
Energy_LUC_Afr$upr_new <- Energy_LUC_Afr$upr_new  * Gt_Mt
Energy_LUC_Afr$Scenario <- factor(Energy_LUC_Afr$Scenario,levels = c("Baseline", "Projected", "High"))
Energy_LUC_Afr_plot <- ggplot(Energy_LUC_Afr , aes(fill = variable , y = value , x= Scenario)) +
    geom_bar(position="dodge", stat="identity") + xlab("") + ylab("") + labs(fill = "Emissions Type") + geom_errorbar(aes(ymin= lwr_new, ymax= upr_new), width = 0.2, position = position_dodge(0.9))   + scale_x_discrete(labels= x.axis) +scale_y_continuous(expand = expand_scale(mult = c(0.0, 0.1))) +  theme_bti() 
Energy_LUC_Afr_plot <- Energy_LUC_Afr_plot  +  scale_fill_manual(values= bti_colors) 

energy_LUC_grafs2 <- ggarrange(Energy_LUC_N_plot, Energy_LUC_S_plot, Energy_LUC_W_plot, Energy_LUC_E_plot, Energy_LUC_C_plot,Energy_LUC_Afr_plot, labels = c("North", "Southern","West","East", "Central", "Africa"), hjust = 0,vjust = 0.4, font.label = list(size = 10, face = "plain", color = "black", family = NULL), common.legend = TRUE, legend = "bottom")


# Annotate the figure by adding a common labels
energy_LUC_grafs2 <- annotate_figure(energy_LUC_grafs2,
                top = text_grob("", color = "black" , size = 10),
                left = text_grob("GHG Emissions (Mt CO2eq)", color = "black", rot = 90))
                
                #fig.lab = "Figure 1", fig.lab.face = "bold")
ggsave(filename = "~/Google Drive/My Drive/Food & Farming/Energy in ag/results/graphs/New Graphs/energy_LUC_grafs.png", plot = energy_LUC_grafs2, width = , height = )

write.csv(Energy_emis_C, "~/Google Drive File Stream/My Drive/Food & Farming/Energy in ag/results/Energy-Ag_tbls/Energy_emis_C.csv")
write.csv(Energy_emis_E, "~/Google Drive File Stream/My Drive/Food & Farming/Energy in ag/results/Energy-Ag_tbls/Energy_emis_E.csv")
write.csv(Energy_emis_S, "~/Google Drive File Stream/My Drive/Food & Farming/Energy in ag/results/Energy-Ag_tbls/Energy_emis_S.csv")
write.csv(Energy_emis_W, "~/Google Drive File Stream/My Drive/Food & Farming/Energy in ag/results/Energy-Ag_tbls/Energy_emis_W.csv")
write.csv(Energy_emis_N, "~/Google Drive File Stream/My Drive/Food & Farming/Energy in ag/results/Energy-Ag_tbls/Energy_emis_N.csv")
write.csv(Energy_emis_Afr, "~/Google Drive File Stream/My Drive/Food & Farming/Energy in ag/results/Energy-Ag_tbls/Energy_emis_Afr.csv")
```


```{r LUC emis graph, all emis sources graph }
#plot results  
LUC_emis <- GHG[, c(1:3)]
x.axis <- c("Baseline", "Projected", "High")

LUC_emis_Afr <- LUC_emis[LUC_emis$Region == "Africa",] #have separate charts for SSA data to compare to region breakdown
LUC_emis <- anti_join(LUC_emis, LUC_emis_Afr)
LUC_emis$Scenario <- str_replace(LUC_emis$Scenario, "High_alt","High")
LUC_emis$Scenario <- factor(LUC_emis$Scenario,levels = c("Baseline", "Projected", "High"))

LUC_regions <- ggplot(LUC_emis , aes(fill = Region , y = LUC , x = Scenario)) + 
    geom_bar(position="dodge", stat="identity" ) + ggtitle(expression(paste("LUC emissions by scenario and region"))) + xlab("Scenario") + ylab("LUC Emissions (Gt CO2 eq)") + labs(fill = "Region")  +  scale_x_discrete(labels= x.axis) + theme_bti()

LUC_regions  <- LUC_regions  +  scale_fill_manual(values= bti_colors)
ggsave(filename = "~/Google Drive File Stream/My Drive/Food & Farming/Energy in ag/results/LUC_regions_grouped", plot = LUC_regions , width = , height = )

#LUC stacked chart 
LUC_stacked <- ggplot(LUC_Afr_regions , aes(fill = Region , y = `LUC emissions(Gt)`, x = Scenario)) + 
    geom_bar(position="fill", stat="identity" ) + ggtitle(expression(paste("% LUC emissions by region for each scenario"))) + xlab("Scenario") + ylab("% LUC emissions") + labs(fill = "Region")  +  scale_x_discrete(labels= x.axis) + theme(axis.title.x = element_text(color="black",size=12),axis.title.y = element_text(color="black", size=12) ,panel.background = element_rect(fill = NA),
       panel.grid.major.y = element_line(colour="grey68",linetype="dotted"),
       panel.grid.major.x = element_line(colour="grey68",linetype="dotted"),axis.ticks.y = element_blank(),axis.ticks.x=element_blank(),
       plot.title = element_text(size=13, face="bold"))

LUC_stacked <- LUC_stacked +  scale_fill_manual(values=wes_palette(n=5, name="Darjeeling1"))
ggsave(filename = "~/Google Drive File Stream/My Drive/Food & Farming/Energy in ag/results/graphs/New Graphs/LUC_stacked_reg", plot = LUC_stacked , width = , height = )


#LUC_SSA chart
LUC_SSA$Scenario <- factor(LUC_SSA$Scenario,levels = c("Baseline", "Projected", "High_alt"))
LUC_SSA <- as.data.frame(na.omit(LUC_Afr_regions))
LUC_SSA <- ggplot(LUC_Afr_regions , aes(y = LUC, x = Scenario)) + 
    geom_bar(position="dodge", stat="identity", fill = "#0DC3A8") + ggtitle(expression(paste("LUC emissions by scenario in Sub-Saharan Africa"))) + xlab("Scenario") + ylab("LUC Emissions (Gt CO2 eq)")  +  scale_x_discrete(labels= x.axis) + theme(axis.title.x = element_text(color="black",size=12),axis.title.y = element_text(color="black", size=12) ,panel.background = element_rect(fill = NA),
       panel.grid.major.y = element_line(colour="grey68",linetype="dotted"),
       panel.grid.major.x = element_line(colour="grey68",linetype="dotted"),axis.ticks.y = element_blank(),axis.ticks.x=element_blank(),
       plot.title = element_text(size=13, face="bold"))

ggsave(filename = "~/Desktop/Grafs_energyag/LUC_SSA.png", plot = LUC_SSA , width = , height = )

#Stacked bar chart
bp <- ggplot(all_emis_melted, aes(fill= variable, y= LUC, x=Scenario)) + 
    geom_bar(position="stack", stat="identity") + ggtitle(expression(paste("Emissions by Scenario"))) + xlab("Scenario") + ylab("GHG Emissions (CO2eq)") + labs(fill = "Categories") + theme(axis.title.x = element_text(color="black",size=12),axis.title.y = element_text(color="black", size=12) ,panel.background = element_rect(fill = NA),
       panel.grid.major.y = element_line(colour="grey68",linetype="dotted"),
       panel.grid.major.x = element_line(colour="grey68",linetype="dotted"), axis.ticks.y = element_blank(),axis.ticks.x=element_blank(),
       plot.title = element_text(size=13, face="bold"))

positions <- c("Baseline Yield", "Projected Yield", "High Yield")
bp + scale_x_discrete(limits = positions) 
bp

colnames(all_emis) <- c("LUC", "Total Energy + LUC emissions", "Synthetic N emissions", "On Farm Fuel Emissions", "Manufacturing Pesticides Emissions", "Manufacturing Nitrogen Emissions", "Manufacturing Nitrogen Emissions 2", "Energy Embodied in Machinery Emissions", "Total Energy Emissions", "Scenario")
rownames(all_emis) <- c("current", "projected", "high")
write_csv(all_emis, path = "~/Google Drive/Energy and GHG Analysis (2019)/energy_ag_analysis/Results/LUC_Energy_Emissions.csv")
```


```{r OLS Estimators table and Predictions Estimator table}
m.ols_coef <- rbind(m.ols$coefficients[1],m.ols$coefficients[2])
p.ols_coef <- rbind(p.ols$coefficients[1],p.ols$coefficients[2])
fert_use.coef  <- rbind(fert_use.ols$coefficients[1],fert_use.ols$coefficients[2])
syn_n.coef <- rbind(syn_n.ols$coefficients[1],syn_n.ols$coefficients[2])
fuel.coef <- rbind(fuel.ols$coefficients[1], fuel.ols$coefficients[2])
energy_coefs <- cbind(m.ols_coef, p.ols_coef, syn_n.coef, fert_use.coef, fuel.coef)
colnames(energy_coefs) <- c("machinery energy emissions", "manufacturing pesticides emissions", "synthetic N fertilizer emissions", "manufacturing fertilizers emissions", "on-farm fuel energy emissions")
energy_coefs[2,1] <- exp(energy_coefs[2,1])
energy_coefs[2,2] <- exp(energy_coefs[2,2])
energy_coefs[2,3] <- exp(energy_coefs[2,3])
energy_coefs[2,4] <- exp(energy_coefs[2,4])
energy_coefs[2,5] <- exp(energy_coefs[2,5])

rownames(energy_coefs) <- c("Intercept", "Yield")
energy_coefs <- as.data.frame(energy_coefs)
write_csv(energy_coefs, "~/Google Drive/Energy and GHG Analysis (2019)/energy_ag_analysis/Results/energy_coefs.csv")

write_csv(predict_tbl, path = "~/Google Drive/Energy and GHG Analysis (2019)/energy_ag_analysis/Results/predict_tbl.csv")

#Error Bars
fuel.ols <- as.data.frame(fuel.ols$coefficients)
write.csv(fuel.ols, "~/Desktop/Energy-Ag_tbls/Fuel_coeffs.csv")
p.coeffs <- as.data.frame(p.ols$coefficients)
p.coeffs$coeffs <- rownames(p.coeffs)
rownames(p.coeffs) <- NULL
write.csv(p.coeffs, "~/Desktop/Energy-Ag_tbls/p_coeffs.csv")
m.coeffs <- as.data.frame(m.ols$coefficients)
m.coeffs$coeffs <- rownames(m.coeffs)
rownames(p.coeffs) <- NULL
write.csv(m.coeffs, "~/Desktop/Energy-Ag_tbls/m_coeffs.csv")

fert_use.coeffs <- as.data.frame(fert_use.ols$coefficients)
fert_use.coeffs$coeffs <- rownames(fert_use.coeffs)
rownames(fert_use.coeffs) <- NULL
write.csv(fert_use.coeffs, "~/Desktop/Energy-Ag_tbls/fert_use_coeffs.csv")

syn_n.coeffs <- as.data.frame(syn_n.ols$coefficients)
syn_n.coeffs$coeffs <- rownames(syn_n.coeffs)
rownames(syn_n.coeffs) <- NULL
write.csv(syn_n.coeffs, "~/Desktop/Energy-Ag_tbls/syn_n_coeffs.csv")
```

```{r Export table of predicted values }
#"Manufacturing Pesticides", "On-Farm Fuel","Synthetic N", "Manufacturing Fertilizers", "Embodied Energy in Machinery")
```

```{r Additional Data Viz}

```

```{r Calculations comparing scenarios}
pct_c_p <- (Energy_emissions$total[2] -  Energy_emissions$total[1])/Energy_emissions$total[1]
pct_c_h <- (Energy_emissions$total[3] -  Energy_emissions$total[1])/Energy_emissions$total[1]
pct_yld_p <- (unlist(Yield_scenarios$projected[1]) -  unlist(Yield_scenarios$current[1])/unlist(Yield_scenarios$current[1])) 
(all_emis$`Total Energy + LUC emissions`[2] - all_emis$LUC[2])/all_emis$LUC[2]
```